<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HelloIvy - Essay Evaluator</title>
     <link rel="icon" href="data:,">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');

        :root {
            --primary-blue: #4285f4;
            --primary-blue-hover: #3367d6;
            --secondary-blue: #e8f0fe;
            --text-primary: #1f2937;
            --text-secondary: #6b7280;
            --text-light: #9ca3af;
            --bg-primary: #ffffff;
            --bg-secondary: #f8fafc;
            --bg-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --border-color: #e5e7eb;
            --border-light: #f3f4f6;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --error-color: #ef4444;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            --border-radius: 8px;
            --border-radius-lg: 12px;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f9fafb;
            min-height: 100vh;
            line-height: 1.5;
            color: var(--text-primary);
        }

        /* ========== ANIMATED GRADIENT RING ========== */
        @keyframes gradientSpin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes gradientSpinReverse {
            0% { transform: rotate(360deg); }
            100% { transform: rotate(0deg); }
        }

        @keyframes pulseAnimation {
            0%, 100% { opacity: 0.4; }
            50% { opacity: 1; }
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .animated-ring {
            position: relative;
            width: 120px;
            height: 120px;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .gradient-ring {
            position: absolute;
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background: radial-gradient(circle at center, 
                rgba(0, 213, 255, 0.8) 0%,      /* Blue */
                rgba(78, 238, 207, 0.8) 25%,    /* Teal */
                rgba(255, 53, 0, 0.8) 50%,      /* Orange */
                rgba(144, 0, 255, 0.8) 75%,     /* Purple */
                rgba(0, 213, 255, 0.8) 100%     /* Back to Blue */
            );
            animation: gradientSpin 3s linear infinite;
            filter: blur(8px);
            opacity: 0.9;
        }

        .gradient-ring::before {
            content: '';
            position: absolute;
            inset: 0;
            border-radius: 50%;
            background: conic-gradient(from 0deg,
                #00D5FF 0deg,          /* Blue - 00D5FF */
                #4EEECF 90deg,         /* Teal - 4EEECF */
                #FF3500 180deg,        /* Orange - FF3500 */
                #9000FF 270deg,        /* Purple - 9000FF */
                #00D5FF 360deg         /* Back to Blue */
            );
            animation: gradientSpinReverse 2.5s linear infinite;
            filter: blur(12px);
            opacity: 0.8;
        }

        .gradient-ring::after {
            content: '';
            position: absolute;
            inset: 5px;
            border-radius: 50%;
            background: conic-gradient(from 45deg,
                transparent 0deg,
                #00D5FF 30deg,         /* Blue */
                #4EEECF 120deg,        /* Teal */
                #FF3500 210deg,        /* Orange */
                #9000FF 300deg,        /* Purple */
                transparent 360deg
            );
            animation: gradientSpin 4s linear infinite;
            filter: blur(6px);
            opacity: 0.6;
        }

        @keyframes dotSequence {
            0%, 80%, 100% { 
                opacity: 0.3;
                transform: scale(1);
                background: #9ca3af;
            }
            20% { 
                opacity: 1;
                transform: scale(1.2);
                background: #4f46e5;
            }
        }

        .ring-inner {
            position: absolute;
            width: 60px;
            height: 60px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 50%;
            backdrop-filter: blur(10px);
            z-index: 2;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }

        .loading-dots {
            display: flex;
            gap: 4px;
            align-items: center;
            justify-content: center;
        }

        .loading-dot {
            width: 6px;
            height: 6px;
            background: #9ca3af;
            border-radius: 50%;
            animation: dotSequence 2s ease-in-out infinite;
            transition: all 0.3s ease;
        }

        .loading-dot:nth-child(1) { animation-delay: 0s; }
        .loading-dot:nth-child(2) { animation-delay: 0.5s; }
        .loading-dot:nth-child(3) { animation-delay: 1s; }
        .loading-dot:nth-child(4) { animation-delay: 1.5s; }

        /* ========== COMMON LAYOUT ========== */
        .page-container {
            display: none;
            min-height: 100vh;
        }

        .page-container.show {
            display: flex;
            flex-direction: column;
        }

        /* Modern Header */
        .header {
            background: white;
            border-bottom: 1px solid var(--border-color);
            padding: 1rem 1.5rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .header-logo {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
            transition: opacity 0.2s ease;
        }

        .header-logo:hover {
            opacity: 0.8;
        }

        .header-logo-icon {
            width: 24px;
            height: 24px;
            background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 0.75rem;
            font-weight: 700;
        }

        .header-logo-text {
            font-weight: 600;
            color: var(--text-primary);
        }

        .header-section {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .section-icon {
            width: 24px;
            height: 24px;
            background: var(--primary-blue);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 0.75rem;
        }

        .section-title {
            font-weight: 600;
            color: var(--text-primary);
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .help-button {
            width: 32px;
            height: 32px;
            background: var(--bg-secondary);
            border: none;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-secondary);
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .help-button:hover {
            background: var(--border-color);
        }

        .user-dropdown {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem;
            border: none;
            background: transparent;
            cursor: pointer;
            border-radius: var(--border-radius);
            transition: background-color 0.2s;
        }

        .user-dropdown:hover {
            background: var(--bg-secondary);
        }

        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: #ec4899;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 0.875rem;
            font-weight: 600;
        }

        .dropdown-icon {
            width: 16px;
            height: 16px;
            color: var(--text-light);
        }

        /* Content Layout */
        .content-layout {
            display: flex;
            flex: 1;
        }

        /* Sidebar */
        .sidebar {
            width: 256px;
            background: white;
            border-right: 1px solid var(--border-color);
            min-height: calc(100vh - 73px);
        }

        .sidebar-nav {
            padding: 1rem;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.5rem 0.75rem;
            border-radius: var(--border-radius-lg);
            color: var(--text-secondary);
            text-decoration: none;
            font-weight: 500;
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .nav-item:hover {
            background: var(--bg-secondary);
            color: var(--text-primary);
        }

        .nav-item.active {
            background: #dbeafe;
            color: #2563eb;
        }

        .nav-icon {
            width: 32px;
            height: 32px;
            border-radius: var(--border-radius-lg);
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--bg-secondary);
            font-size: 1rem;
        }

        .nav-item.active .nav-icon {
            background: #bfdbfe;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            padding: 2rem;
            overflow-y: auto;
        }

        /* Instructions Card */
        .instructions-card {
            background: white;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-lg);
            padding: 1.5rem;
            margin-bottom: 2rem;
            box-shadow: var(--shadow-sm);
        }

        .instructions-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1rem;
        }

        .instructions-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .listen-btn {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            border: 1px solid #fed7aa;
            background: #fff7ed;
            color: #ea580c;
            border-radius: var(--border-radius);
            text-decoration: none;
            font-size: 0.875rem;
            font-weight: 500;
            transition: all 0.2s;
        }

        .listen-btn:hover {
            background: #fed7aa;
        }

        .instructions-content {
            font-size: 0.875rem;
            color: var(--text-secondary);
            line-height: 1.5;
            margin-bottom: 0.75rem;
        }

        .read-more-btn {
            display: flex;
            align-items: center;
            gap: 0.25rem;
            color: #2563eb;
            font-size: 0.875rem;
            text-decoration: none;
            margin-top: 0.75rem;
            transition: color 0.2s;
        }

        .read-more-btn:hover {
            color: #1d4ed8;
        }

        /* Content Card */
        .content-card {
            background: linear-gradient(135deg, rgba(219, 234, 254, 0.3) 0%, rgba(248, 250, 255, 0.3) 100%);
            border: 2px dashed var(--border-color);
            border-radius: var(--border-radius-lg);
            padding: 2rem;
            margin-bottom: 2rem;
        }

        .content-card-inner {
            display: flex;
            align-items: center;
            gap: 2rem;
        }

        .content-text {
            flex: 1;
            color: var(--text-secondary);
            line-height: 1.5;
        }

        /* Chat Widget */
        .chat-widget {
            background: var(--bg-primary);
            border-radius: var(--border-radius-lg);
            padding: 1.5rem;
            margin-bottom: 2rem;
            box-shadow: var(--shadow-sm);
            position: relative;
        }

        .chat-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            position: absolute;
            left: 1.5rem;
            top: 1.5rem;
        }

        .chat-content {
            margin-left: 3.5rem;
            color: var(--text-secondary);
            line-height: 1.6;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            margin-top: 2rem;
        }

        .empty-state-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 1.5rem;
        }

        /* ========== BUTTONS ========== */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: var(--border-radius);
            font-size: 0.875rem;
            font-weight: 600;
            text-decoration: none;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
            overflow: hidden;
        }

        .btn-primary {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
            transform: translateY(-1px);
        }

        .btn-secondary {
            background: var(--bg-primary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        .btn-secondary:hover {
            background: var(--bg-secondary);
        }

        .btn-ghost {
            background: transparent;
            color: var(--primary-blue);
            border: 1px solid var(--primary-blue);
        }

        .btn-ghost:hover {
            background: var(--secondary-blue);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }

        .btn.loading::after {
            content: '';
            position: absolute;
            width: 16px;
            height: 16px;
            border: 2px solid transparent;
            border-top: 2px solid currentColor;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        /* ========== MODAL ========== */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 1rem;
        }

        .modal-overlay.show {
            display: flex;
        }

        .modal {
            background: var(--bg-primary);
            border-radius: var(--border-radius-lg);
            max-width: 400px;
            width: 100%;
            padding: 2rem;
            position: relative;
            box-shadow: var(--shadow-lg);
        }

        .modal-close {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-light);
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-close:hover {
            background: var(--bg-secondary);
        }

        .modal-icon {
            width: 64px;
            height: 64px;
            border-radius: var(--border-radius-lg);
            background: var(--secondary-blue);
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 1.5rem;
            font-size: 1.5rem;
        }

        .modal h2 {
            text-align: center;
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            color: var(--text-primary);
        }

        .modal p {
            text-align: center;
            color: var(--text-secondary);
            margin-bottom: 2rem;
            line-height: 1.6;
        }

        .modal-buttons {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        /* ========== LANDING PAGE ========== */
        .landing-content {
            padding: 3rem 2rem;
            max-width: 800px;
            margin: 0 auto;
        }

        .landing-hero {
            text-align: center;
            margin-bottom: 3rem;
        }

        .landing-hero h1 {
            font-size: 2.5rem;
            font-weight: 800;
            color: var(--text-primary);
            margin-bottom: 1rem;
        }

        .landing-hero p {
            font-size: 1.125rem;
            color: var(--text-secondary);
        }

        .landing-illustration {
            width: 200px;
            height: 120px;
            margin: 2rem auto;
            background: var(--border-light);
            border-radius: var(--border-radius-lg);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
            opacity: 0.7;
        }

        .instructions-list {
            list-style: none;
            margin-bottom: 2rem;
            counter-reset: step-counter;
        }

        .instructions-list li {
            display: flex;
            gap: 1rem;
            padding: 0.75rem 0;
            color: var(--text-secondary);
            line-height: 1.6;
        }

        .instructions-list li::before {
            content: counter(step-counter);
            counter-increment: step-counter;
            background: var(--primary-blue);
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.875rem;
            font-weight: 600;
            flex-shrink: 0;
            margin-top: 0.125rem;
        }

        .agreement-section {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 2rem;
        }

        .agreement-section input[type="checkbox"] {
            width: 18px;
            height: 18px;
            accent-color: var(--primary-blue);
        }

        .agreement-section label {
            color: var(--text-secondary);
            cursor: pointer;
            user-select: none;
        }

        /* ========== ESSAY LIST & FORMS ========== */
        .content-container {
            padding: 2rem;
            max-width: 1200px;
            margin: 0 auto;
        }

        .content-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }

        .content-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .essay-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-top: 2rem;
        }

        .essay-card {
            background: var(--bg-primary);
            border-radius: var(--border-radius-lg);
            padding: 1.5rem;
            box-shadow: var(--shadow-sm);
            cursor: pointer;
            transition: all 0.2s ease;
            border: 1px solid var(--border-color);
        }

        .essay-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
            border-color: var(--primary-blue);
        }

        .essay-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
        }

        .essay-title {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.25rem;
            line-height: 1.4;
        }

        .essay-meta {
            font-size: 0.75rem;
            color: var(--text-light);
        }

        .essay-actions {
            display: flex;
            gap: 0.5rem;
        }

        .action-icon {
            width: 32px;
            height: 32px;
            border-radius: var(--border-radius);
            border: 1px solid var(--border-color);
            background: var(--bg-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .action-icon:hover {
            background: var(--bg-secondary);
        }

        .essay-stats {
            display: flex;
            justify-content: space-between;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid var(--border-light);
        }

        .stat {
            display: flex;
            align-items: center;
            gap: 0.25rem;
            font-size: 0.75rem;
            color: var(--text-light);
        }

        .college-section {
            margin-bottom: 3rem;
        }

        .college-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .college-name {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .essay-count {
            font-size: 0.875rem;
            color: var(--text-light);
        }

        /* ========== FORMS ========== */
        .form-section {
            background: var(--bg-primary);
            border-radius: var(--border-radius-lg);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            display: block;
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
        }

        .form-input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            font-size: 0.875rem;
            transition: all 0.2s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary-blue);
            box-shadow: 0 0 0 3px rgba(66, 133, 244, 0.1);
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 1rem;
        }

        .essay-limit-section {
            margin-bottom: 1.5rem;
        }

        .essay-limit-options {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            margin-top: 0.5rem;
        }

        .radio-option {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .radio-option input[type="radio"] {
            accent-color: var(--primary-blue);
        }

        .radio-option label {
            font-size: 0.875rem;
            color: var(--text-secondary);
            cursor: pointer;
        }

        .word-limit-input {
            width: 100px;
            margin-top: 0.5rem;
        }
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }

        .past-analysis-indicator {
            animation: fadeIn 0.3s ease-out;
        }

        /* ========== EDITOR PAGE ========== */
        .editor-container {
            display: grid;
            grid-template-columns: 1fr 350px;
            gap: 1.5rem;
            height: calc(100vh - 200px);
        }

        .editor-main {
            background: var(--bg-primary);
            border-radius: var(--border-radius-lg);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .editor-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--border-color);
        }

        .editor-title-section h2 {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.25rem;
        }

        .editor-meta {
            font-size: 0.75rem;
            color: var(--text-light);
        }

        .editor-actions {
            display: flex;
            gap: 0.75rem;
        }

        .share-btn {
            background: var(--warning-color) !important;
            color: white;
        }

        .editor-toolbar {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1.5rem;
            border-bottom: 1px solid var(--border-color);
            background: var(--bg-secondary);
        }

        .toolbar-group {
            display: flex;
            gap: 0.25rem;
        }

        .toolbar-btn {
            width: 32px;
            height: 32px;
            border: none;
            border-radius: var(--border-radius);
            background: transparent;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-weight: 600;
            color: var(--text-secondary);
            transition: all 0.2s ease;
        }

        .toolbar-btn:hover,
        .toolbar-btn.active {
            background: var(--bg-primary);
            color: var(--text-primary);
        }

        .toolbar-separator {
            width: 1px;
            height: 20px;
            background: var(--border-color);
            margin: 0 0.5rem;
        }

        .word-count-display {
            margin-left: auto;
            font-size: 0.75rem;
            color: var(--text-light);
        }

        .editor-content {
            flex: 1;
            padding: 1.5rem;
            overflow-y: auto;
            resize: none;
            border: none;
            outline: none;
            font-family: inherit;
            font-size: 0.875rem;
            line-height: 1.7;
            color: var(--text-primary);
        }

        /* ========== ANALYSIS SIDEBAR ========== */
        .analysis-sidebar {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .analysis-card {
            background: var(--bg-primary);
            border-radius: var(--border-radius-lg);
            overflow: hidden;
        }

        .analysis-tabs {
            display: flex;
            border-bottom: 1px solid var(--border-color);
        }

        .tab-btn {
            flex: 1;
            padding: 0.75rem;
            border: none;
            background: transparent;
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--text-secondary);
            cursor: pointer;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .tab-btn.active {
            color: var(--primary-blue);
        }

        .tab-btn.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: var(--primary-blue);
        }

        .tab-content {
            padding: 1.5rem;
        }

        .tab-panel {
            display: none;
        }

        .tab-panel.active {
            display: block;
        }

        .score-circle {
            text-align: center;
            margin-bottom: 2rem;
        }

        .score-chart {
            width: 120px;
            height: 120px;
            margin: 0 auto 1rem;
            position: relative;
        }

        .score-chart svg {
            width: 100%;
            height: 100%;
            transform: rotate(-90deg);
        }

        .score-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
        }

        .score-number {
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .score-total {
            font-size: 0.875rem;
            color: var(--text-light);
        }

        .score-description {
            font-size: 0.875rem;
            color: var(--text-secondary);
            line-height: 1.5;
        }

        .metric {
            margin-bottom: 1.5rem;
        }

        .metric-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .metric-name {
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--text-primary);
        }

        .metric-score {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .metric-bar {
            height: 6px;
            background: var(--border-light);
            border-radius: 3px;
            overflow: hidden;
        }

        .metric-progress {
            height: 100%;
            background: var(--primary-blue);
            border-radius: 3px;
            transition: width 1s ease;
        }

        .suggestions-section {
            margin-top: 2rem;
        }

        .suggestions-title {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .suggestions-count {
            background: var(--error-color);
            color: white;
            font-size: 0.75rem;
            padding: 0.125rem 0.5rem;
            border-radius: 10px;
            min-width: 20px;
            text-align: center;
        }

        .suggestion-item {
            padding: 0.75rem;
            background: var(--bg-secondary);
            border-radius: var(--border-radius);
            margin-bottom: 0.75rem;
            font-size: 0.875rem;
            line-height: 1.5;
        }

        .suggestion-type {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.25rem;
        }

        .suggestion-text {
            color: var(--text-secondary);
            margin-bottom: 0.25rem;
        }

        .suggestion-fix {
            color: var(--primary-blue);
            font-weight: 500;
        }

        /* ========== RESPONSIVE ========== */
        @media (max-width: 1024px) {
            .editor-container {
                grid-template-columns: 1fr;
                gap: 1rem;
            }

            .analysis-sidebar {
                order: -1;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .essay-limit-options {
                flex-direction: column;
                gap: 0.5rem;
            }
        }

        @media (max-width: 768px) {
            .content-layout {
                flex-direction: column;
            }

            .sidebar {
                width: 100%;
                min-height: auto;
            }

            .sidebar-nav {
                flex-direction: row;
                overflow-x: auto;
            }

            .main-content {
                padding: 1rem;
            }

            .content-card-inner {
                flex-direction: column;
                text-align: center;
                gap: 1.5rem;
            }

            .header {
                padding: 1rem;
            }

            .header-left {
                gap: 0.5rem;
            }

            .landing-content {
                padding: 2rem 1rem;
            }

            .landing-hero h1 {
                font-size: 2rem;
            }

            .modal {
                margin: 1rem;
                padding: 1.5rem;
            }

            .editor-actions {
                flex-wrap: wrap;
                gap: 0.5rem;
            }

            .toolbar-group {
                gap: 0.125rem;
            }

            .essay-grid {
                grid-template-columns: 1fr;
            }
        }


        .brainstorming-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }

        .brainstorming-header {
            text-align: center;
            margin-bottom: 3rem;
        }

        .brainstorming-interface {
            display: grid;
            grid-template-columns: 350px 1fr 300px;
            gap: 2rem;
            min-height: calc(100vh - 200px);
        }

        /* Session Controls */
        .session-controls {
            background: white;
            border-radius: var(--border-radius-lg);
            padding: 1.5rem;
            border: 1px solid var(--border-color);
            height: fit-content;
            position: sticky;
            top: 2rem;
        }

        .session-info {
            background: var(--bg-secondary);
            border-radius: var(--border-radius);
            padding: 1rem;
            margin-bottom: 1.5rem;
        }

        .session-title {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
        }

        .session-meta {
            font-size: 0.75rem;
            color: var(--text-light);
        }

        .control-group {
            margin-bottom: 1.5rem;
        }

        .control-label {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
            display: block;
        }

        .topic-selector {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            font-size: 0.875rem;
        }

        .recording-controls {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .record-btn {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
            border: none;
            padding: 1rem;
            border-radius: var(--border-radius);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .record-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .record-btn.recording {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            animation: pulse 2s infinite;
        }

        .record-btn.processing {
            background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);
            cursor: not-allowed;
        }

        .record-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        /* Conversation Area */
        .conversation-area {
            background: white;
            border-radius: var(--border-radius-lg);
            border: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .conversation-header {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--border-color);
            background: var(--bg-secondary);
        }

        .conversation-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.25rem;
        }

        .conversation-subtitle {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .conversation-messages {
            flex: 1;
            padding: 1.5rem;
            overflow-y: auto;
            max-height: 600px;
        }

        .message {
            margin-bottom: 1.5rem;
            animation: fadeIn 0.3s ease-out;
        }

        .message.ai {
            display: flex;
            gap: 1rem;
        }

        .message.user {
            display: flex;
            gap: 1rem;
            flex-direction: row-reverse;
        }

        .message-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            flex-shrink: 0;
        }

        .message-avatar.ai {
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            color: white;
        }

        .message-avatar.user {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
        }

        .message-content {
            flex: 1;
            max-width: 70%;
        }

        .message-bubble {
            padding: 1rem;
            border-radius: var(--border-radius-lg);
            font-size: 0.875rem;
            line-height: 1.6;
            position: relative;
        }

        .message.ai .message-bubble {
            background: var(--bg-secondary);
            color: var(--text-primary);
            border-bottom-left-radius: 4px;
        }

        .message.user .message-bubble {
            background: var(--primary-blue);
            color: white;
            border-bottom-right-radius: 4px;
        }

        .message-time {
            font-size: 0.75rem;
            color: var(--text-light);
            margin-top: 0.5rem;
        }

        .conversation-input {
            padding: 1rem 1.5rem;
            border-top: 1px solid var(--border-color);
            background: white;
        }

        .input-group {
            display: flex;
            gap: 0.75rem;
            align-items: end;
        }

        .text-input {
            flex: 1;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 0.75rem;
            font-size: 0.875rem;
            resize: vertical;
            min-height: 44px;
            max-height: 120px;
        }

        .send-btn {
            background: var(--primary-blue);
            color: white;
            border: none;
            padding: 0.75rem 1rem;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s ease;
        }

        .send-btn:hover:not(:disabled) {
            background: var(--primary-blue-hover);
        }

        .send-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Memory Panel */
        .memory-panel {
            background: white;
            border-radius: var(--border-radius-lg);
            border: 1px solid var(--border-color);
            height: fit-content;
            position: sticky;
            top: 2rem;
        }

        .memory-header {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--border-color);
            background: var(--bg-secondary);
        }

        .memory-title {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.25rem;
        }

        .memory-progress {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .memory-content {
            padding: 1rem;
            max-height: 500px;
            overflow-y: auto;
        }

        .memory-category {
            margin-bottom: 1rem;
            padding: 0.75rem;
            background: var(--bg-secondary);
            border-radius: var(--border-radius);
            border-left: 3px solid var(--border-color);
            transition: all 0.3s ease;
        }

        .memory-category.filled {
            border-left-color: var(--success-color);
            background: rgba(16, 185, 129, 0.05);
        }

        .memory-category.active {
            border-left-color: var(--primary-blue);
            background: rgba(66, 133, 244, 0.05);
        }

        .category-title {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .category-count {
            background: var(--text-light);
            color: white;
            font-size: 0.625rem;
            padding: 0.125rem 0.375rem;
            border-radius: 10px;
            min-width: 16px;
            text-align: center;
        }

        .category-count.filled {
            background: var(--success-color);
        }

        .category-items {
            font-size: 0.75rem;
            color: var(--text-secondary);
            line-height: 1.4;
        }

        .category-items.empty {
            font-style: italic;
            color: var(--text-light);
        }

        .memory-item {
            background: rgba(255, 255, 255, 0.7);
            padding: 0.5rem;
            border-radius: 4px;
            margin-bottom: 0.5rem;
            border-left: 2px solid var(--primary-blue);
        }

        .memory-item:last-child {
            margin-bottom: 0;
        }

        /* Essay Generation */
        .essay-generation {
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid var(--border-color);
        }

        .generation-status {
            text-align: center;
            padding: 1rem;
            background: var(--bg-secondary);
            border-radius: var(--border-radius);
            margin-bottom: 1rem;
        }

        .status-icon {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        .status-text {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .generate-essay-btn {
            width: 100%;
            background: linear-gradient(135deg, var(--success-color) 0%, #059669 100%);
            color: white;
            border: none;
            padding: 0.75rem;
            border-radius: var(--border-radius);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .generate-essay-btn:hover:not(:disabled) {
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .generate-essay-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        /* Session List */
        .session-list {
            margin-top: 1.5rem;
        }

        .session-item {
            padding: 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            margin-bottom: 0.5rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .session-item:hover {
            background: var(--bg-secondary);
            border-color: var(--primary-blue);
        }

        .session-item.active {
            background: var(--secondary-blue);
            border-color: var(--primary-blue);
        }

        .session-item-title {
            font-size: 0.875rem;
            font-weight: 500;
            margin-bottom: 0.25rem;
        }

        .session-item-meta {
            font-size: 0.75rem;
            color: var(--text-light);
        }

        /* Responsive Design */
        @media (max-width: 1200px) {
            .brainstorming-interface {
                grid-template-columns: 300px 1fr 250px;
                gap: 1.5rem;
            }
        }

        @media (max-width: 1024px) {
            .brainstorming-interface {
                grid-template-columns: 1fr;
                gap: 1rem;
            }
            
            .session-controls,
            .memory-panel {
                position: static;
            }
        }

        @media (max-width: 768px) {
            .brainstorming-container {
                padding: 1rem;
            }
            
            .conversation-messages {
                max-height: 400px;
            }
            
            .message-content {
                max-width: 85%;
            }
        }

        /* Loading States */
        .typing-indicator {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 1rem;
            color: var(--text-light);
            font-style: italic;
        }

        .typing-dots {
            display: flex;
            gap: 2px;
        }

        .typing-dot {
            width: 4px;
            height: 4px;
            background: var(--text-light);
            border-radius: 50%;
            animation: typing 1.4s infinite ease-in-out;
        }

        .typing-dot:nth-child(1) { animation-delay: 0s; }
        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }

        @keyframes typing {
            0%, 80%, 100% { opacity: 0.3; transform: scale(1); }
            40% { opacity: 1; transform: scale(1.2); }
        }

        /* ========== UTILITIES ========== */
        .text-center { text-align: center; }
        .text-right { text-align: right; }
        .font-medium { font-weight: 500; }
        .font-semibold { font-weight: 600; }
        .font-bold { font-weight: 700; }
        .text-sm { font-size: 0.875rem; }
        .text-xs { font-size: 0.75rem; }
        .mb-2 { margin-bottom: 0.5rem; }
        .mb-4 { margin-bottom: 1rem; }
        .mt-4 { margin-top: 1rem; }
        .hidden { display: none; }
        .flex { display: flex; }
        .items-center { align-items: center; }
        .justify-between { justify-content: space-between; }
        .gap-2 { gap: 0.5rem; }
        .gap-4 { gap: 1rem; }
        .fade-in { animation: fadeIn 0.3s ease-out; }



    </style>
</head>
<body>
    <!-- Authentication Modal -->
    <div id="authModal" class="modal-overlay">
        <div class="modal">
            <button class="modal-close" onclick="hideAuth()">&times;</button>
            <h2 id="authTitle">Welcome to HelloIvy</h2>
            <p id="authSubtitle">Sign in to access your essay tools</p>
            
            <form id="loginForm">
                <div class="form-group">
                    <input type="email" name="email" class="form-input" placeholder="Email" required>
                </div>
                <div class="form-group">
                    <input type="password" name="password" class="form-input" placeholder="Password" required>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%">Sign In</button>
            </form>
            
            <div style="text-align: center; margin-top: 1rem;">
                <a href="#" onclick="toggleAuthMode()" style="color: var(--primary-blue); text-decoration: none; font-size: 0.875rem;">
                    Don't have an account? Sign up
                </a>
            </div>
        </div>
    </div>

    <!-- Essay Brainstormer Modal -->
    <div id="brainstormerModal" class="modal-overlay">
        <div class="modal">
            <button class="modal-close" onclick="hideBrainstormer()">&times;</button>
            <div class="modal-icon"></div>
            <h2>Explore Essay Brainstormer</h2>
            <p>Uncover compelling essay ideas tailored to your story and goals.</p>
            <div class="modal-buttons">
                <button class="btn btn-primary" style="width: 100%" onclick="goToBrainstormer()">
                    Go to Essay Brainstormer
                </button>
                <button class="btn btn-ghost" style="width: 100%" onclick="continueWithEvaluator()">
                    Continue with essay evaluator
                </button>
            </div>
        </div>
    </div>

    <!-- Landing Page -->
    <div id="landingPage" class="page-container">
        <!-- Header -->
        <header class="header">
            <div class="header-left">
                <div class="header-logo" onclick="goToHomePage()">
                    <div class="header-logo-icon">h</div>
                    <span class="header-logo-text">hellohvy</span>
                </div>
                <div class="header-section">
                    <div class="section-icon"></div>
                    <span class="section-title">Essay Evaluator</span>
                </div>
            </div>
            <div class="header-right">
                <button class="help-button">?</button>
                <button class="user-dropdown">
                    <div class="user-avatar">U</div>
                    <span style="font-size: 0.75rem;"></span>
                </button>
            </div>
        </header>

        <div class="content-layout">
            <div class="sidebar">
                <nav class="sidebar-nav">
                    <a href="#" class="nav-item" onclick="setActiveTab('dashboard')">
                        <div class="nav-icon"></div>
                        <span>My Dashboard</span>
                    </a>
                    <a href="#" class="nav-item active" onclick="setActiveTab('evaluator')">
                        <div class="nav-icon"></div>
                        <span>Essay Evaluator</span>
                    </a>
                </nav>
            </div>

            <div class="main-content">
                <div class="landing-content">
                    <div class="landing-hero">
                        <h1>Ready to Evaluate<br>Your Essays?</h1>
                        <div class="landing-illustration"></div>
                    </div>

                    <div class="instructions-card">
                        <div class="instructions-header">
                            <h2>Go Through Instructions Before We Start The Module</h2>
                            <a href="#" class="listen-btn">
                                 Listen
                            </a>
                        </div>

                        <ol class="instructions-list">
                            <li>This module helps you evaluate, refine, and elevate your essay drafts.</li>
                            <li>Review your brainstormed structure before uploading - we will ensure your essay evaluation is consistent with your original brainstorming themes.</li>
                            <li>Submit your essay draft to receive targeted AI insights, suggestions, integrative counselor feedback, and iterate through multiple versions.</li>
                            <li>Review all AI and counselor suggestions carefully.</li>
                            <li>Decide what resonates with your voice, and make changes that align with your intended story and tone.</li>
                            <li>Continue to revise and iterate based on feedback.</li>
                            <li>Make sure your essay version is complete and ready for feedback before submitting to maximize the value you receive.</li>
                        </ol>

                        <div class="agreement-section">
                            <input type="checkbox" id="agreedCheckbox">
                            <label for="agreedCheckbox">I have read all the instruction mentioned above</label>
                        </div>

                        <button class="btn btn-primary" id="getStartedBtn" disabled onclick="showBrainstormer()">
                            Get Started 
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Essay List Page -->
    <div id="essayListPage" class="page-container">
        <!-- Header -->
        <header class="header">
            <div class="header-left">
                <div class="header-logo" onclick="goToHomePage()">
                    <div class="header-logo-icon">h</div>
                    <span class="header-logo-text">hellohvy</span>
                </div>
                <div class="header-section">
                    <div class="section-icon"></div>
                    <span class="section-title">Essay Evaluator</span>
                </div>
            </div>
            <div class="header-right">
                <button class="help-button">?</button>
                <button class="user-dropdown">
                    <div class="user-avatar">U</div>
                    <span style="font-size: 0.75rem;"></span>
                </button>
            </div>
        </header>

        <div class="content-layout">
            <div class="sidebar">
                <nav class="sidebar-nav">
                    <a href="#" class="nav-item" onclick="setActiveTab('dashboard')">
                        <div class="nav-icon"></div>
                        <span>My Dashboard</span>
                    </a>
                    <a href="#" class="nav-item active" onclick="setActiveTab('evaluator')">
                        <div class="nav-icon"></div>
                        <span>Essay Evaluator</span>
                    </a>
                </nav>
            </div>

            <div class="main-content">
                <!-- Instructions Card -->
                <div class="instructions-card">
                    <div class="instructions-header">
                        <h2 class="instructions-title">Instructions</h2>
                        <a href="#" class="listen-btn">
                             Listen
                        </a>
                    </div>
                    <div class="instructions-content">
                        <p>1. Click "Evaluate your first essay" to upload or paste your latest draft.</p>
                        <p>2. Ensure your essay is saved in .doc/.docx or PDF format before uploading for accurate reading, feedback tagging, and ver...</p>
                    </div>
                    <a href="#" class="read-more-btn">
                        <span>Read more</span>
                        <span></span>
                    </a>
                </div>

                <!-- Content Card with Animated Ring -->
                <div class="content-card">
                    <div class="content-card-inner">
                        <!-- Animated Gradient Ring -->
                        <div class="animated-ring">
                            <div class="gradient-ring"></div>
                            <div class="ring-inner">
                                <div class="loading-dots">
                                    <div class="loading-dot"></div>
                                    <div class="loading-dot"></div>
                                    <div class="loading-dot"></div>
                                    <div class="loading-dot"></div>
                                </div>
                            </div>
                        </div>

                        <!-- Text Content -->
                        <div class="content-text">
                            <p id="chatMessage">Looks like You haven't uploaded any essays yet. To get started, click "New Essay" to upload your draft or create one from scratch. Once uploaded, you'll enter the editing and evaluation workspace.</p>
                        </div>
                    </div>
                </div>

                <div id="emptyState" class="empty-state">
                    <h3 class="empty-state-title">You don't have any essays uploaded yet!</h3>
                    <button class="btn btn-primary" onclick="showNewEssayForm()">
                        Evaluate Your First Essay 
                    </button>
                </div>

                <div id="essaysByCollege" class="hidden">
                    <!-- Essays will be populated here -->
                </div>

                <div class="content-header" style="margin-top: 3rem;">
                    <div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
                        <div>
                            <h2 class="content-title">Essay List</h2>
                            <div class="text-sm text-light">0/50 Essay Evaluated</div>
                            <!-- Debug info -->
                            <div style="font-size: 0.75rem; color: var(--text-light); margin-top: 0.5rem;" id="debugInfo">
                                Auth: <span id="authStatus">Checking...</span> | 
                                Essays: <span id="essayStatus">Loading...</span>
                            </div>
                        </div>
                        <div style="display: flex; gap: 1rem; align-items: center;">
                            <div style="position: relative;">
                                <input type="text" placeholder=" Search for essay or college" 
                                       style="padding: 0.75rem; border: 1px solid var(--border-color); border-radius: var(--border-radius); width: 250px;">
                            </div>
                            <button class="btn btn-secondary" onclick="window.refreshEssays()" title="Refresh Essays">
                                 Refresh
                            </button>
                            <button class="btn btn-ghost" onclick="window.showAuth()" title="Login" style="font-size: 0.875rem;">
                                 Login
                            </button>
                            <button class="btn btn-primary" onclick="window.showNewEssayForm()">
                                Next Essay 
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- New Essay Form Page -->
    <div id="newEssayPage" class="page-container">
        <!-- Header -->
        <header class="header">
            <div class="header-left">
                <div class="header-logo" onclick="goToHomePage()">
                    <div class="header-logo-icon">h</div>
                    <span class="header-logo-text">hellohvy</span>
                </div>
                <div class="header-section">
                    <div class="section-icon"></div>
                    <span class="section-title">Essay Evaluator</span>
                </div>
            </div>
            <div class="header-right">
                <button class="help-button">?</button>
                <button class="user-dropdown">
                    <div class="user-avatar">U</div>
                    <span style="font-size: 0.75rem;"></span>
                </button>
            </div>
        </header>

        <div class="content-layout">
            <div class="sidebar">
                <nav class="sidebar-nav">
                    <a href="#" class="nav-item" onclick="setActiveTab('dashboard')">
                        <div class="nav-icon"></div>
                        <span>My Dashboard</span>
                    </a>
                    <a href="#" class="nav-item active" onclick="setActiveTab('evaluator')">
                        <div class="nav-icon"></div>
                        <span>Essay Evaluator</span>
                    </a>
                </nav>
            </div>

            <div class="main-content">
                <div class="content-container">
                    <!-- Instructions Card -->
                    <div class="instructions-card">
                        <div class="instructions-header">
                            <h2 class="instructions-title">Instructions</h2>
                            <a href="#" class="listen-btn">
                                 Listen
                            </a>
                        </div>
                        <div class="chat-content" style="margin-left: 0;">
                            Let's choose the college and the essay topic to start with the brainstorming session.
                        </div>
                    </div>

                    <div class="form-section">
                        <div style="display: flex; gap: 2rem; margin-bottom: 2rem; border-bottom: 1px solid var(--border-color); padding-bottom: 1rem;">
                            <div style="display: flex; align-items: center; gap: 0.5rem; padding: 0.75rem 1.5rem; background: var(--secondary-blue); border-radius: var(--border-radius); color: var(--primary-blue); font-weight: 600;">
                                <span></span>
                                Essay Topic
                            </div>
                            <div style="display: flex; align-items: center; gap: 0.5rem; padding: 0.75rem 1.5rem; border: 1px solid var(--border-color); border-radius: var(--border-radius); color: var(--text-secondary);">
                                <span></span>
                                Essay
                            </div>
                        </div>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-bottom: 2rem;">
                            <div>
                                <h3 style="font-size: 1rem; font-weight: 600; margin-bottom: 1rem;">Previously Brainstormed Essay</h3>
                                <select class="form-input">
                                    <option>--- Select essay topic ---</option>
                                </select>
                            </div>
                            <div>
                                <h3 style="font-size: 1rem; font-weight: 600; margin-bottom: 1rem;">New Essay</h3>
                                <input type="text" class="form-input" placeholder="Enter essay topic">
                            </div>
                        </div>

                        <div class="essay-limit-section">
                            <label class="form-label">Essay Limit</label>
                            <div class="essay-limit-options">
                                <div class="radio-option">
                                    <input type="radio" id="words" name="limit" value="words" checked>
                                    <label for="words">Words</label>
                                </div>
                                <div class="radio-option">
                                    <input type="radio" id="chars-space" name="limit" value="chars-space">
                                    <label for="chars-space">Characters With Space</label>
                                </div>
                                <div class="radio-option">
                                    <input type="radio" id="chars-no-space" name="limit" value="chars-no-space">
                                    <label for="chars-no-space">Characters Without Space</label>
                                </div>
                                <div class="radio-option">
                                    <input type="radio" id="pages-single" name="limit" value="pages-single">
                                    <label for="pages-single">Pages Single Space</label>
                                </div>
                                <div class="radio-option">
                                    <input type="radio" id="pages-double" name="limit" value="pages-double">
                                    <label for="pages-double">Pages Double Space</label>
                                </div>
                            </div>
                            <input type="number" class="form-input word-limit-input" placeholder="e.g. 650" value="650">
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">College *</label>
                                <select class="form-input" required>
                                    <option>--- Select college ---</option>
                                    <option>Harvard University</option>
                                    <option>Stanford University</option>
                                    <option>MIT</option>
                                    <option>Yale University</option>
                                    <option>Princeton University</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Degree *</label>
                                <select class="form-input" required>
                                    <option>--- Select degree ---</option>
                                    <option>Bachelor's</option>
                                    <option>Master's</option>
                                    <option>PhD</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Major *</label>
                                <select class="form-input" required>
                                    <option>--- Select major ---</option>
                                    <option>Computer Science</option>
                                    <option>Engineering</option>
                                    <option>Business</option>
                                    <option>Medicine</option>
                                </select>
                            </div>
                        </div>

                        <div style="margin-top: 2rem; padding-top: 2rem; border-top: 1px solid var(--border-color);">
                            <div class="form-group">
                                <label class="form-label">Your Essay *</label>
                                <textarea 
                                    class="form-input" 
                                    placeholder="Paste or type your essay here..." 
                                    rows="15" 
                                    style="resize: vertical; font-family: inherit; line-height: 1.6;"
                                    id="essayContentInput"
                                    oninput="updateEssayWordCount()"
                                ></textarea>
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 0.5rem; font-size: 0.75rem; color: var(--text-light);">
                                    <span>Words: <span id="essayWordCount" style="font-weight: 600;">0</span></span>
                                    <span>Characters: <span id="essayCharCount">0</span></span>
                                </div>
                            </div>
                        </div>

                        <div style="text-align: center; margin-top: 2rem;">
                            <button class="btn btn-primary" onclick="analyzeEssay()" style="padding: 1rem 2rem;" id="analyzeButton" disabled>
                                 Analyze Essay with AI
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Essay Editor Page -->
    <div id="editorPage" class="page-container">
        <!-- Header -->
        <header class="header">
            <div class="header-left">
                <div class="header-logo" onclick="goToHomePage()">
                    <div class="header-logo-icon">h</div>
                    <span class="header-logo-text">hellohvy</span>
                </div>
                <div class="header-section">
                    <div class="section-icon"></div>
                    <span class="section-title">Essay Evaluator</span>
                    <span style="margin-left: 0.5rem; padding: 0.25rem 0.75rem; background: #e0e7ff; color: #4338ca; border-radius: 12px; font-size: 0.75rem; font-weight: 600;">
                        Brainstorm, Essay 1, Structure 1 - 290 words
                    </span>
                </div>
            </div>
            <div class="header-right">
                <button class="help-button">?</button>
                <button class="user-dropdown">
                    <div class="user-avatar">U</div>
                    <span style="font-size: 0.75rem;"></span>
                </button>
            </div>
        </header>

        <div class="main-content" style="padding: 1.5rem;">
            <!-- Instructions Card -->
            <div class="instructions-card">
                <div class="instructions-header">
                    <h2 class="instructions-title">Instructions</h2>
                    <a href="#" class="listen-btn">
                         Listen
                    </a>
                </div>
                <div class="chat-content" style="margin-left: 0;">
                    <strong>Welcome to your essay editing workspace!</strong> Here's how to make the most of your AI feedback:
                    <br><br>
                    <strong> Edit Directly:</strong> Make changes to your essay in the text editor below. Use the formatting toolbar for bold, italic, and alignment.
                    <br><br>
                    <strong> Review Analysis:</strong> Check the analysis panel on the right for your overall score and detailed feedback on narrative impact, structure, and college alignment.
                    <br><br>
                    <strong> Apply Suggestions:</strong> Click through the "Comments" tab to see specific grammar, style, and content recommendations. Accept or reject suggestions based on your voice.
                    <br><br>
                    <strong> Iterate & Improve:</strong> After making changes, you can re-analyze your essay to see score improvements and get fresh feedback.
                    <br><br>
                    <a href="#" style="color: var(--primary-blue); text-decoration: none;">Learn more about effective essay revision strategies </a>
                </div>
            </div>

            <div class="editor-container">
                <div class="editor-main">
                    <div class="editor-header">
                        <div class="editor-title-section">
                            <h2>Some students have a background, identity, interes...</h2>
                            <div class="editor-meta">Last updated: 23/04/2023</div>
                        </div>
                        <div class="editor-actions">
                            <button class="btn btn-primary">
                                 Evaluate Next Essay
                            </button>
                            <button class="btn share-btn">
                                 Share 
                            </button>
                        </div>
                    </div>

                    <div class="editor-toolbar">
                        <div class="toolbar-group">
                            <button class="toolbar-btn" onclick="formatText('bold')" title="Bold"><strong>B</strong></button>
                            <button class="toolbar-btn" onclick="formatText('italic')" title="Italic"><em>I</em></button>
                            <button class="toolbar-btn" onclick="formatText('underline')" title="Underline"><u>U</u></button>
                        </div>
                        <div class="toolbar-separator"></div>
                        <div class="toolbar-group">
                            <button class="toolbar-btn" onclick="formatText('justifyLeft')" title="Align Left"></button>
                            <button class="toolbar-btn" onclick="formatText('justifyCenter')" title="Align Center"></button>
                            <button class="toolbar-btn" onclick="formatText('justifyRight')" title="Align Right"></button>
                            <button class="toolbar-btn" onclick="formatText('justifyFull')" title="Justify"></button>
                        </div>
                        <div class="toolbar-separator"></div>
                        <div class="toolbar-group">
                            <button class="toolbar-btn" onclick="insertList('ul')" title="Bullet List"></button>
                            <button class="toolbar-btn" onclick="createLink()" title="Insert Link"></button>
                        </div>
                        <div class="word-count-display" id="editorWordCount">290 words</div>
                    </div>

                    <div class="editor-content" 
                         id="editableContent"
                         contenteditable="true" 
                         style="outline: none; white-space: pre-wrap;"
                         oninput="updateWordCount(); trackChanges();"
                         onselect="updateToolbarButtonStates();"
                         onmouseup="updateToolbarButtonStates();"
                         onkeyup="updateToolbarButtonStates();">As a child, I was always reserved and struggled to express myself. Whether it was participating in class discussions or socializing with my peers, I found solace in the background, afraid to let my voice be heard. However this, all changed when I discovered my passion for poetry.

Through the power of words, I found a means to articulate the emotions and thoughts that had long been bottled up inside me. Each carefully crafted verse became an outlet for self-expression, allowing me to explore my innermost feelings and share them with the world. Poetry became my voice, a medium through which I could communicate and connect with others.

Writing poetry not only helped me find my voice myself, but it also provided me with a sense of empowerment and purpose. It allowed me to transform my quietness into insightful nights, trembling with nerves but determined to share my truth. The support and encouragement I received from the audience bolstered my self-belief, pushing me to further explore and creative potential.

As I embarked on the college application journey I realized the significance of my newfound voice. I understood that my unique perspective, shaped by my journey of self-discovery through poetry, would contribute to the diverse tapestry of voices on campus. I knew that I had something valuable to offer - a voice that had been cultivated through introspection, creativity, and the courage to be vulnerable.</div>
                </div>

                <div class="analysis-sidebar">
                    <div class="analysis-card">
                        <div class="analysis-tabs">
                            <button class="tab-btn active" data-tab="analysis">
                                <span></span>
                                Analysis (1/4)
                            </button>
                            <button class="tab-btn" data-tab="comments">
                                <span></span>
                                Comments
                                <span style="background: var(--error-color); color: white; font-size: 0.625rem; padding: 0.125rem 0.375rem; border-radius: 8px; margin-left: 0.25rem;">3</span>
                            </button>
                            <button class="tab-btn" data-tab="structure">
                                <span></span>
                                Structure
                            </button>
                        </div>

                        <div class="tab-content">
                            <div class="tab-panel active" id="analysisPanel">
                                <div class="score-circle">
                                    <div class="score-chart">
                                        <svg viewBox="0 0 120 120">
                                            <circle cx="60" cy="60" r="54" fill="none" stroke="#f3f4f6" stroke-width="8"></circle>
                                            <circle cx="60" cy="60" r="54" fill="none" stroke="#f59e0b" stroke-width="8" 
                                                    stroke-dasharray="339.29" stroke-dashoffset="67.86" 
                                                    stroke-linecap="round" style="transition: stroke-dashoffset 1s ease;"></circle>
                                        </svg>
                                        <div class="score-text">
                                            <div class="score-number">8.0</div>
                                            <div class="score-total">/10</div>
                                        </div>
                                    </div>
                                    <div class="score-description">
                                        The analysis results reflects the need for stronger connections between your experiences & learnings and specific offerings, a clearer narrative and well defined insights.
                                    </div>
                                </div>

                                <div class="metric">
                                    <div class="metric-header">
                                        <span class="metric-name">Alignment with Topic</span>
                                        <span class="metric-score"></span>
                                    </div>
                                    <div class="metric-bar">
                                        <div class="metric-progress" style="width: 0%; background: #e5e7eb;"></div>
                                    </div>
                                </div>

                                <div class="metric">
                                    <div class="metric-header">
                                        <span class="metric-name">Alignment with Brainstorming</span>
                                        <span class="metric-score"></span>
                                    </div>
                                    <div class="metric-bar">
                                        <div class="metric-progress" style="width: 0%; background: #e5e7eb;"></div>
                                    </div>
                                </div>

                                <div class="metric">
                                    <div class="metric-header">
                                        <span class="metric-name">Essay Narrative & Impact</span>
                                        <span class="metric-score"></span>
                                    </div>
                                    <div class="metric-bar">
                                        <div class="metric-progress" style="width: 0%; background: #e5e7eb;"></div>
                                    </div>
                                </div>

                                <div class="metric">
                                    <div class="metric-header">
                                        <span class="metric-name">Language & Structure</span>
                                        <span class="metric-score"></span>
                                    </div>
                                    <div class="metric-bar">
                                        <div class="metric-progress" style="width: 0%; background: #e5e7eb;"></div>
                                    </div>
                                </div>

                                <div class="metric">
                                    <div class="metric-header">
                                        <span class="metric-name">Alignment with College Values</span>
                                        <span class="metric-score"></span>
                                    </div>
                                    <div class="metric-bar">
                                        <div class="metric-progress" style="width: 0%; background: #e5e7eb;"></div>
                                    </div>
                                </div>

                                <div style="margin-top: 2rem;">
                                    <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1rem; font-size: 0.875rem; font-weight: 600; color: var(--text-primary);">
                                        <span></span>
                                        Summary
                                    </div>
                                    <div style="font-size: 0.875rem; color: var(--text-secondary); line-height: 1.5; margin-bottom: 1.5rem;">
                                        Add: Moreover, "coming (,)"
                                    </div>

                                    <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1rem; font-size: 0.875rem; font-weight: 600; color: var(--text-primary);">
                                        <span></span>
                                        Suggestions
                                        <span class="suggestions-count">10</span>
                                    </div>
                                    <div style="font-size: 0.875rem; color: var(--text-secondary); line-height: 1.5;">
                                        Spelling: <span style="color: var(--error-color);">passion</span><br>
                                        Replace: "my voice" with <span style="color: var(--primary-blue); font-weight: 500;">myself</span><br>
                                        Remove: <span style="color: var(--error-color);">"The support and encouragement I received from the audience bolstered my self-belief, pushing me to further explore and creative potential."</span>
                                    </div>
                                </div>
                            </div>

                            <div class="tab-panel" id="commentsPanel">
                                <div class="suggestion-item">
                                    <div class="suggestion-type">Grammar</div>
                                    <div class="suggestion-text">However this, all changed</div>
                                    <div class="suggestion-fix">Suggestion: However, this all changed</div>
                                </div>
                                <div class="suggestion-item">
                                    <div class="suggestion-type">Spelling</div>
                                    <div class="suggestion-text">passion</div>
                                    <div class="suggestion-fix">Already correct</div>
                                </div>
                                <div class="suggestion-item">
                                    <div class="suggestion-type">Word Choice</div>
                                    <div class="suggestion-text">my voice myself</div>
                                    <div class="suggestion-fix">Replace with: myself</div>
                                </div>
                            </div>

                            <div class="tab-panel" id="structurePanel">
                                <div style="font-size: 0.875rem; line-height: 1.6; color: var(--text-secondary);">
                                    <p style="margin-bottom: 1rem;"><strong>Introduction:</strong> Sets up the background of being reserved</p>
                                    <p style="margin-bottom: 1rem;"><strong>Body Paragraph 1:</strong> Discovery of poetry as self-expression</p>
                                    <p style="margin-bottom: 1rem;"><strong>Body Paragraph 2:</strong> Poetry's impact on personal growth</p>
                                    <p><strong>Conclusion:</strong> Connection to college application journey</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div style="display: flex; gap: 0.75rem; margin-top: 1rem;">
                    <button class="btn btn-secondary" onclick="uploadEssayAgain()" style="flex: 1;">
                         New Essay
                    </button>
                    <button class="btn btn-primary" onclick="evaluateAgain()" style="flex: 1;">
                         Evaluate Again
                    </button>
                </div>
                </div>
            </div>
        </div>
    </div>
    <div id="brainstormingPage" class="page-container">
    <!-- Header -->
    <header class="header">
        <div class="header-left">
            <div class="header-logo" onclick="goToHomePage()">
                <div class="header-logo-icon">h</div>
                <span class="header-logo-text">HelloIvy</span>
            </div>
            <div class="header-section">
                <div class="section-icon"></div>
                <span class="section-title">Voice Brainstorming</span>
            </div>
        </div>
        <div class="header-right">
            <button class="help-button">?</button>
            <button class="user-dropdown">
                <div class="user-avatar">U</div>
                <span style="font-size: 0.75rem;"></span>
            </button>
        </div>
    </header>

    <div class="main-content">
        <div class="brainstorming-container">
            <div class="brainstorming-header">
                <h1>Voice Essay Brainstorming</h1>
                <p>Discover compelling essay ideas through guided conversation</p>
            </div>

            <div class="brainstorming-interface">
                <!-- Session Controls -->
                <div class="session-controls">
                    <div class="session-info">
                        <div class="session-title" id="currentSessionTitle">New Brainstorming Session</div>
                        <div class="session-meta">
                            <div>Stage: <span id="sessionStage">Introduction</span></div>
                            <div>Exchanges: <span id="sessionExchanges">0</span></div>
                            <div>Duration: <span id="sessionDuration">00:00</span></div>
                        </div>
                    </div>

                    <div class="control-group">
                        <label class="control-label">Current Topic</label>
                        <select class="topic-selector" id="topicSelector" onchange="changeTopic()">
                            <option value="introduction">Introduction</option>
                            <option value="experiences">Life Experiences</option>
                            <option value="challenges">Challenges & Growth</option>
                            <option value="achievements">Achievements</option>
                            <option value="goals">Goals & Aspirations</option>
                            <option value="values">Values & Beliefs</option>
                            <option value="skills">Skills & Talents</option>
                            <option value="leadership">Leadership</option>
                            <option value="service">Community Service</option>
                            <option value="college_preferences">College Preferences</option>
                        </select>
                    </div>

                    <div class="control-group">
                        <label class="control-label">Voice Recording</label>
                        <div class="recording-controls">
                            <button class="record-btn" id="recordBtn" onclick="toggleRecording()">
                                <span id="recordIcon"></span>
                                <span id="recordText">Start Recording</span>
                            </button>
                            <button class="btn btn-secondary" onclick="playLastResponse()" id="playLastBtn" disabled>
                                 Play Last Response
                            </button>
                        </div>
                    </div>

                    <div class="control-group">
                        <button class="btn btn-ghost" onclick="pauseSession()" id="pauseBtn" style="width: 100%;">
                             Pause Session
                        </button>
                        <button class="btn btn-secondary" onclick="resetSession()" style="width: 100%; margin-top: 0.5rem;">
                             Reset Session
                        </button>
                    </div>

                    <!-- Session List -->
                    <div class="session-list">
                        <div class="control-label">Previous Sessions</div>
                        <div id="sessionsList">
                            <!-- Previous sessions will be populated here -->
                        </div>
                        <button class="btn btn-primary" onclick="createNewSession()" style="width: 100%; margin-top: 0.5rem;">
                             New Session
                        </button>
                    </div>
                </div>

                <!-- Conversation Area -->
                <div class="conversation-area">
                    <div class="conversation-header">
                        <div class="conversation-title">AI Counselor Conversation</div>
                        <div class="conversation-subtitle">Share your thoughts and experiences naturally</div>
                    </div>

                    <div class="conversation-messages" id="conversationMessages">
                        <!-- Welcome Message -->
                        <div class="message ai">
                            <div class="message-avatar ai"></div>
                            <div class="message-content">
                                <div class="message-bubble">
                                    <strong>Hi! I'm your AI counselor.</strong> I'm here to help you discover amazing stories for your college essay through natural conversation. 
                                    <br><br>
                                    Let's start by getting to know you better. What's something you're genuinely excited about or proud of in your life right now?
                                </div>
                                <div class="message-time">Just now</div>
                            </div>
                        </div>
                    </div>

                    <div class="conversation-input">
                        <div class="input-group">
                            <textarea 
                                class="text-input" 
                                id="messageInput" 
                                placeholder="Type your response or use voice recording..."
                                rows="2"
                                onkeypress="handleEnterKey(event)"
                            ></textarea>
                            <button class="send-btn" onclick="sendMessage()" id="sendBtn" disabled>
                                Send
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Memory Panel -->
                <div class="memory-panel">
                    <div class="memory-header">
                        <div class="memory-title">Essay Memory</div>
                        <div class="memory-progress">
                            <span id="memoryProgress">0/10</span> insights captured
                        </div>
                    </div>

                    <div class="memory-content">
                        <!-- Experiences -->
                        <div class="memory-category" id="experiencesCategory">
                            <div class="category-title">
                                <span></span>
                                Experiences
                                <span class="category-count" id="experiencesCount">0</span>
                            </div>
                            <div class="category-items empty" id="experiencesItems">
                                No experiences captured yet
                            </div>
                        </div>

                        <!-- Challenges -->
                        <div class="memory-category" id="challengesCategory">
                            <div class="category-title">
                                <span></span>
                                Challenges
                                <span class="category-count" id="challengesCount">0</span>
                            </div>
                            <div class="category-items empty" id="challengesItems">
                                No challenges captured yet
                            </div>
                        </div>

                        <!-- Achievements -->
                        <div class="memory-category" id="achievementsCategory">
                            <div class="category-title">
                                <span></span>
                                Achievements
                                <span class="category-count" id="achievementsCount">0</span>
                            </div>
                            <div class="category-items empty" id="achievementsItems">
                                No achievements captured yet
                            </div>
                        </div>

                        <!-- Goals -->
                        <div class="memory-category" id="goalsCategory">
                            <div class="category-title">
                                <span></span>
                                Goals
                                <span class="category-count" id="goalsCount">0</span>
                            </div>
                            <div class="category-items empty" id="goalsItems">
                                No goals captured yet
                            </div>
                        </div>

                        <!-- Values -->
                        <div class="memory-category" id="valuesCategory">
                            <div class="category-title">
                                <span></span>
                                Values
                                <span class="category-count" id="valuesCount">0</span>
                            </div>
                            <div class="category-items empty" id="valuesItems">
                                No values captured yet
                            </div>
                        </div>

                        <!-- Skills -->
                        <div class="memory-category" id="skillsCategory">
                            <div class="category-title">
                                <span></span>
                                Skills
                                <span class="category-count" id="skillsCount">0</span>
                            </div>
                            <div class="category-items empty" id="skillsItems">
                                No skills captured yet
                            </div>
                        </div>
                    </div>

                    <!-- Essay Generation -->
                    <div class="essay-generation">
                        <div class="generation-status">
                            <div class="status-icon"></div>
                            <div class="status-text" id="generationStatus">
                                Continue brainstorming to unlock essay generation
                            </div>
                        </div>
                        <button class="generate-essay-btn" onclick="generateEssayFromBrainstorming()" id="generateEssayBtn" disabled>
                             Generate Essay Draft
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

    <script>
        // ================================
        // GLOBAL VARIABLES
        // ================================
        let currentPage = 'landing';
        let isAuthenticated = false;
        let userEssays = [];
        let currentUser = null;
        let authToken = null;

        // API Configuration
        const API_BASE_URL = 'http://localhost:8000';

        // ================================
// BRAINSTORMING MODULE VARIABLES
// ================================
        let brainstormingData = {
            currentSessionId: null,
            isRecording: false,
            isPaused: false,
            sessionStartTime: null,
            currentTopic: 'introduction',
            totalExchanges: 0,
            conversationStage: 0,
            
            // Memory structure
            memory: {
                experiences: [],
                challenges: [],
                achievements: [],
                goals: [],
                values: [],
                skills: [],
                leadership: [],
                service: [],
                interests: [],
                personal_info: {}
            },
            
            // Session metadata
            sessions: [],
            currentSession: null
        };

        // Voice recognition setup for brainstorming
        let brainstormingRecognition = null;
        let lastRecordedAudio = null;

        // ================================
        // UTILITY FUNCTIONS
        // ================================
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', {
                month: 'short',
                day: 'numeric',
                year: 'numeric'
            });
        }

        function showError(message) {
            alert(message);
        }

        function updateChatMessage(message) {
            const chatElement = document.getElementById('chatMessage');
            if (chatElement) {
                chatElement.textContent = message;
            }
        }

        // ================================
        // API FUNCTIONS
        // ================================
        async function apiRequest(endpoint, options = {}) {
            const defaultOptions = {
                headers: {
                    'Content-Type': 'application/json',
                    ...(authToken && { 'Authorization': `Bearer ${authToken}` })
                }
            };
            
            const finalOptions = {
                ...defaultOptions,
                ...options,
                headers: { ...defaultOptions.headers, ...options.headers }
            };
            
            console.log(`Making API request to ${endpoint}`, finalOptions);
            
            try {
                const response = await fetch(`${API_BASE_URL}${endpoint}`, finalOptions);
                
                console.log(`API response status: ${response.status}`);
                
                if (response.status === 401) {
                    localStorage.removeItem('auth_token');
                    authToken = null;
                    isAuthenticated = false;
                    showAuth();
                    throw new Error('Authentication required');
                }

                if (response.status === 402) {
                    // Payment required - handle gracefully
                    const errorData = await response.json().catch(() => ({ detail: 'insufficient_credits' }));
                    throw new Error('insufficient_credits');
                }

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ detail: 'Unknown error' }));
                    console.error('API error:', errorData);
                    throw new Error(errorData.detail || `HTTP ${response.status}`);
                }
                
                const result = await response.json();
                console.log('API response data:', result);
                return result;
                
            } catch (error) {
                console.error('API request failed:', error);
                throw error;
            }
        }

        // Test API connection
        async function testAPIConnection() {
            try {
                console.log('Testing API connection to:', API_BASE_URL);
                const response = await fetch(`${API_BASE_URL}/api/health`);
                const data = await response.json();
                console.log(' API connection successful:', data);
                return true;
            } catch (error) {
                console.error(' API connection failed:', error);
                return false;
            }
        }

        // Update debug status
        function updateDebugStatus() {
            const authStatus = document.getElementById('authStatus');
            const essayStatus = document.getElementById('essayStatus');
            
            if (authStatus) {
                authStatus.textContent = isAuthenticated ? `Logged in (${currentUser?.email || 'user'})` : 'Not logged in';
                authStatus.style.color = isAuthenticated ? 'var(--success-color)' : 'var(--error-color)';
            }
            
            if (essayStatus) {
                essayStatus.textContent = `${userEssays.length} essays loaded`;
                essayStatus.style.color = userEssays.length > 0 ? 'var(--success-color)' : 'var(--text-light)';
            }
            
            // Add API status debug
            const debugInfo = document.getElementById('debugInfo');
            if (debugInfo) {
                debugInfo.innerHTML = `
                    Auth: <span style="color: ${isAuthenticated ? 'var(--success-color)' : 'var(--error-color)'};">${isAuthenticated ? 'Logged in' : 'Not logged in'}</span> | 
                    Essays: <span style="color: ${userEssays.length > 0 ? 'var(--success-color)' : 'var(--text-light)'};">${userEssays.length} essays loaded</span> |
                    API: <span style="color: var(--primary-blue);">${API_BASE_URL}</span>
                `;
            }
        }

        // Check if user is already authenticated
        function checkAuthenticationStatus() {
            authToken = localStorage.getItem('auth_token');
            console.log('Checking auth status, token:', authToken ? 'exists' : 'not found');
            updateDebugStatus();
            
            if (authToken) {
                fetchCurrentUser();
            } else {
                console.log('No token found, showing landing page');
                showPage('landingPage');
            }
        }

        // Fetch current user info
        async function fetchCurrentUser() {
            try {
                console.log('Fetching current user...');
                currentUser = await apiRequest('/api/users/me');
                console.log('Current user:', currentUser);
                isAuthenticated = true;
                updateUserInterface();
                updateDebugStatus();
                showPage('essayListPage');
                await fetchUserEssays();
            } catch (error) {
                console.error('Failed to fetch user:', error);
                localStorage.removeItem('auth_token');
                authToken = null;
                isAuthenticated = false;
                updateDebugStatus();
                showAuth();
            }
        }

        // Fetch user's essays
        async function fetchUserEssays() {
            try {
                console.log('Fetching user essays...');
                userEssays = await apiRequest('/api/essays/history?limit=50');
                console.log('Fetched essays:', userEssays);
                updateDebugStatus();
                displayUserEssays();
            } catch (error) {
                console.error('Failed to fetch essays:', error);
                updateDebugStatus();
                showError('Failed to load your essays. Please try again.');
            }
        }

        // Login user
        async function loginUser(email, password) {
            try {
                const loginBtn = document.querySelector('#loginForm button[type="submit"]');
                if (loginBtn) {
                    loginBtn.disabled = true;
                    loginBtn.textContent = 'Signing in...';
                }
                
                const formData = new FormData();
                formData.append('username', email);
                formData.append('password', password);
                
                const response = await fetch(`${API_BASE_URL}/api/token`, {
                    method: 'POST',
                    body: formData
                });
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ detail: 'Login failed' }));
                    throw new Error(errorData.detail || 'Invalid email or password');
                }
                
                const tokenData = await response.json();
                authToken = tokenData.access_token;
                localStorage.setItem('auth_token', authToken);
                
                await fetchCurrentUser();
                hideAuth();
                
            } catch (error) {
                console.error('Login failed:', error);
                showError(error.message || 'Login failed. Please try again.');
            } finally {
                const loginBtn = document.querySelector('#loginForm button[type="submit"]');
                if (loginBtn) {
                    loginBtn.disabled = false;
                    loginBtn.textContent = 'Sign In';
                }
            }
        }

        // Register new user
        async function registerUser(email, password) {
            try {
                const response = await fetch(`${API_BASE_URL}/api/users/register`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        email: email,
                        password: password
                    })
                });
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ detail: 'Registration failed' }));
                    throw new Error(errorData.detail || 'Registration failed');
                }
                
                // Auto-login after successful registration
                await loginUser(email, password);
                
            } catch (error) {
                console.error('Registration failed:', error);
                showError(error.message || 'Registration failed. Please try again.');
            }
        }

        // ================================
        // CORE FUNCTIONS (GLOBAL)
        // ================================
        function showUpgradeModal() {
            // Remove existing modal if present
            const existingModal = document.getElementById('upgradeModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            const modal = document.createElement('div');
            modal.id = 'upgradeModal';
            modal.className = 'modal-overlay show';
            modal.innerHTML = `
                <div class="modal">
                    <button class="modal-close" onclick="closeUpgradeModal()">&times;</button>
                    <div class="modal-icon"></div>
                    <h2>You've Used All Your Essays!</h2>
                    <p>Great progress! You've analyzed your monthly limit. Upgrade to continue improving your essays.</p>
                    
                    <div style="display: grid; gap: 1rem; margin: 2rem 0;">
                        <div style="border: 2px solid var(--primary-blue); border-radius: 8px; padding: 1rem; background: var(--secondary-blue);">
                            <h3 style="color: var(--primary-blue); margin-bottom: 0.5rem;">Premium Plan - $29.99/month</h3>
                            <ul style="margin: 0.5rem 0; padding-left: 1.5rem; font-size: 0.875rem;">
                                <li>50 essay evaluations</li>
                                <li>Advanced AI feedback</li>
                                <li>Priority support</li>
                                <li>College-specific insights</li>
                            </ul>
                            <button class="btn btn-primary" onclick="upgradeUser('premium')" style="width: 100%; margin-top: 1rem;">
                                 Upgrade to Premium
                            </button>
                        </div>
                        
                        <div style="border: 1px solid var(--border-color); border-radius: 8px; padding: 1rem;">
                            <h3 style="margin-bottom: 0.5rem;">Basic Plan - $9.99/month</h3>
                            <ul style="margin: 0.5rem 0; padding-left: 1.5rem; font-size: 0.875rem;">
                                <li>15 essay evaluations</li>
                                <li>Standard AI feedback</li>
                                <li>Email support</li>
                            </ul>
                            <button class="btn btn-secondary" onclick="upgradeUser('basic')" style="width: 100%; margin-top: 1rem;">
                                Choose Basic
                            </button>
                        </div>
                    </div>
                    
                    <button class="btn btn-ghost" onclick="closeUpgradeModal()" style="width: 100%;">
                        Maybe Later
                    </button>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function closeUpgradeModal() {
            const modal = document.getElementById('upgradeModal');
            if (modal) {
                modal.remove();
            }
        }

        function upgradeUser(planType) {
            alert(`${planType.charAt(0).toUpperCase() + planType.slice(1)} plan upgrade coming soon! Contact support@helloivy.com for immediate upgrade.`);
            closeUpgradeModal();
        }

        // Make functions globally accessible
        window.showUpgradeModal = showUpgradeModal;
        window.closeUpgradeModal = closeUpgradeModal;
        window.upgradeUser = upgradeUser;
        function refreshEssays() {
            console.log('Manual refresh triggered');
            if (isAuthenticated && authToken) {
                fetchUserEssays();
            } else {
                console.log('Not authenticated, cannot refresh essays');
                showAuth();
            }
        }

        function showAuth() {
            document.getElementById('authModal').classList.add('show');
        }

        function hideAuth() {
            document.getElementById('authModal').classList.remove('show');
        }

        function showNewEssayForm() {
            if (!isAuthenticated) {
                showAuth();
                return;
            }
            showPage('newEssayPage');
            updateChatMessage("Let's choose the college and the essay topic to start with the brainstorming session.");
        }

        function logout() {
            localStorage.removeItem('auth_token');
            authToken = null;
            currentUser = null;
            isAuthenticated = false;
            userEssays = [];
            showPage('landingPage');
        }

        function showPage(pageId) {
            console.log('Showing page:', pageId);
            document.querySelectorAll('.page-container').forEach(page => {
                page.classList.remove('show');
            });
            
            const targetPage = document.getElementById(pageId);
            if (targetPage) {
                targetPage.classList.add('show');
                currentPage = pageId;
                console.log('Page displayed:', pageId);
            } else {
                console.error('Page not found:', pageId);
            }
        }

        // Display user essays
        function displayUserEssays() {
            console.log('Displaying essays, count:', userEssays.length);
            const container = document.getElementById('essaysByCollege');
            const emptyState = document.getElementById('emptyState');
            
            if (!container || !emptyState) {
                console.error('Container elements not found');
                return;
            }
            
            if (userEssays.length === 0) {
                console.log('No essays found, showing empty state');
                emptyState.classList.remove('hidden');
                container.classList.add('hidden');
                updateChatMessage("Looks like You haven't uploaded any essays yet. To get started, click \"New Essay\" to upload your draft or create one from scratch. Once uploaded, you'll enter the editing and evaluation workspace.");
                return;
            }
            
            console.log('Displaying', userEssays.length, 'essays');
            
            // Group essays by college
            const essaysByCollege = groupEssaysByCollege(userEssays);
            console.log('Essays grouped by college:', essaysByCollege);
            
            container.innerHTML = Object.entries(essaysByCollege).map(([college, essays]) => `
                <div class="college-section">
                    <div class="college-header">
                        <h3 class="college-name">${college}</h3>
                        <span class="essay-count">${essays.length}/20 Essay Evaluated</span>
                    </div>
                    <div class="essay-grid">
                        ${essays.map(essay => `
                            <div class="essay-card" onclick="loadEssayEditor('${essay.id}')" data-essay-id="${essay.id}">
                                <div class="essay-card-header">
                                    <div>
                                        <div class="essay-title">${escapeHtml(essay.title)}</div>
                                        <div class="essay-meta">Created: ${formatDate(essay.created_at)}</div>
                                    </div>
                                    <div class="essay-actions">
                                        <div class="action-icon" onclick="event.stopPropagation(); downloadEssay('${essay.id}')" title="Download"></div>
                                        <div class="action-icon" onclick="event.stopPropagation(); deleteEssay('${essay.id}')" title="Delete"></div>
                                    </div>
                                </div>
                                <p style="color: var(--text-secondary); font-size: 0.75rem; line-height: 1.4; margin: 0.75rem 0;">
                                    ${escapeHtml(essay.question_type.substring(0, 100))}${essay.question_type.length > 100 ? '...' : ''}
                                </p>
                                <div class="essay-stats">
                                    <div class="stat">
                                        <span></span>
                                        <span>${essay.word_count || 0} words</span>
                                    </div>
                                    <div class="stat">
                                        <span></span>
                                        <span>${essay.overall_score ? essay.overall_score.toFixed(1) : 'N/A'}</span>
                                    </div>
                                    <div class="stat">
                                        <span></span>
                                        <span>${essay.college_degree || 'General'}</span>
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `).join('');
            
            emptyState.classList.add('hidden');
            container.classList.remove('hidden');
            updateChatMessage("Great! Here are your essays. Click on any essay to view and edit it, or create a new one.");
            
            // Update essay count
            const totalEssays = userEssays.length;
            const essayCountElement = document.querySelector('.content-header .text-sm');
            if (essayCountElement) {
                essayCountElement.textContent = `${totalEssays}/50 Essay Evaluated`;
            }
        }

        // Group essays by college
        function groupEssaysByCollege(essays) {
            return essays.reduce((groups, essay) => {
                // Extract college name from college_degree field
                let college = 'Other';
                if (essay.college_degree) {
                    // Try to extract college name (assuming format like "Harvard University, Bachelor's in Computer Science")
                    const parts = essay.college_degree.split(',');
                    if (parts.length > 0) {
                        college = parts[0].trim();
                    }
                }
                
                if (!groups[college]) {
                    groups[college] = [];
                }
                groups[college].push(essay);
                return groups;
            }, {});
        }

        // Update user interface with current user info
        function updateUserInterface() {
            if (currentUser) {
                // Update user avatar with first letter of email
                const avatars = document.querySelectorAll('.user-avatar');
                avatars.forEach(avatar => {
                    avatar.textContent = currentUser.email.charAt(0).toUpperCase();
                });
                
                // Update credits display if needed
                if (currentUser.credits !== undefined) {
                    console.log(`User credits: ${currentUser.credits}`);
                }
            }
        }

        // Delete essay
        async function deleteEssay(essayId) {
            if (!confirm('Are you sure you want to delete this essay?')) {
                return;
            }
            
            try {
                await apiRequest(`/api/essays/${essayId}`, { method: 'DELETE' });
                await fetchUserEssays(); // Refresh the list
            } catch (error) {
                console.error('Failed to delete essay:', error);
                showError('Failed to delete essay. Please try again.');
            }
        }

        // Download essay
        function downloadEssay(essayId) {
            const essay = userEssays.find(e => e.id === essayId);
            if (essay) {
                // Simple download as text file
                const blob = new Blob([essay.content], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${essay.title}.txt`;
                a.click();
                URL.revokeObjectURL(url);
            }
        }

        // ================================
        // EDITOR FUNCTIONS
        // ================================
        
        // Rich text formatting functions
        function formatText(command) {
            const editor = document.getElementById('editableContent');
            if (editor) {
                editor.focus();
                try {
                    document.execCommand(command, false, null);
                    updateToolbarButtonStates();
                    trackChanges();
                } catch (e) {
                    console.error('Formatting command failed:', command, e);
                }
            }
        }

        function insertList(type) {
            const editor = document.getElementById('editableContent');
            if (editor) {
                editor.focus();
                if (type === 'ul') {
                    document.execCommand('insertUnorderedList', false, null);
                } else {
                    document.execCommand('insertOrderedList', false, null);
                }
                updateToolbarButtonStates();
                trackChanges();
            }
        }

        function createLink() {
            const editor = document.getElementById('editableContent');
            if (editor) {
                editor.focus();
                const url = prompt('Enter the URL:');
                if (url) {
                    document.execCommand('createLink', false, url);
                    trackChanges();
                }
            }
        }

        function updateToolbarButtonStates() {
            setTimeout(() => {
                try {
                    const toolbarBtns = document.querySelectorAll('#editorPage .toolbar-btn');
                    
                    // Reset all buttons
                    toolbarBtns.forEach(btn => btn.classList.remove('active'));
                    
                    // Check and update states
                    if (document.queryCommandState('bold')) {
                        toolbarBtns[0]?.classList.add('active');
                    }
                    if (document.queryCommandState('italic')) {
                        toolbarBtns[1]?.classList.add('active');
                    }
                    if (document.queryCommandState('underline')) {
                        toolbarBtns[2]?.classList.add('active');
                    }
                    
                    // Alignment buttons
                    if (document.queryCommandState('justifyLeft')) {
                        toolbarBtns[3]?.classList.add('active');
                    } else if (document.queryCommandState('justifyCenter')) {
                        toolbarBtns[4]?.classList.add('active');
                    } else if (document.queryCommandState('justifyRight')) {
                        toolbarBtns[5]?.classList.add('active');
                    } else if (document.queryCommandState('justifyFull')) {
                        toolbarBtns[6]?.classList.add('active');
                    }
                    
                } catch (e) {
                    console.log('queryCommandState not supported');
                }
            }, 10);
        }

        function updateWordCount() {
            const editor = document.getElementById('editableContent');
            const display = document.getElementById('editorWordCount');
            
            if (editor && display) {
                const text = editor.textContent || editor.innerText || '';
                const words = text.trim() ? text.trim().split(/\s+/).length : 0;
                display.textContent = `${words} words`;
            }
        }

        function trackChanges() {
            // Update last modified time
            const metaElement = document.querySelector('.editor-meta');
            if (metaElement) {
                const now = new Date();
                const timeString = now.toLocaleDateString('en-US', {
                    day: '2-digit',
                    month: '2-digit', 
                    year: 'numeric'
                });
                metaElement.textContent = `Last updated: ${timeString}`;
            }
            
            updateWordCount();
        }

        // Keyboard shortcuts for rich text
        function setupKeyboardShortcuts() {
            document.addEventListener('keydown', function(e) {
                const editor = document.getElementById('editableContent');
                if (!editor || document.activeElement !== editor) return;
                
                if (e.ctrlKey || e.metaKey) {
                    switch(e.key.toLowerCase()) {
                        case 'b':
                            e.preventDefault();
                            formatText('bold');
                            break;
                        case 'i':
                            e.preventDefault();
                            formatText('italic');
                            break;
                        case 'u':
                            e.preventDefault();
                            formatText('underline');
                            break;
                        case 's':
                            e.preventDefault();
                            trackChanges();
                            console.log('Essay auto-saved');
                            break;
                    }
                }
            });
        }

        // ================================
        // ESSAY ANALYSIS FUNCTIONS
        // ================================

        // Word count functionality for essay input
        function updateEssayWordCount() {
            const textarea = document.getElementById('essayContentInput');
            const wordCountEl = document.getElementById('essayWordCount');
            const charCountEl = document.getElementById('essayCharCount');
            const analyzeBtn = document.getElementById('analyzeButton');
            
            if (textarea && wordCountEl && charCountEl) {
                const content = textarea.value;
                const wordCount = content.trim() ? content.trim().split(/\s+/).length : 0;
                const charCount = content.length;
                
                wordCountEl.textContent = wordCount;
                charCountEl.textContent = charCount;
                
                // Enable analyze button only if essay has content and form is valid
                const hasContent = wordCount > 20; // Minimum 20 words
                const formValid = validateEssayForm();
                analyzeBtn.disabled = !hasContent || !formValid;
                
                // Update word count color based on limit
                const limit = parseInt(document.querySelector('.word-limit-input').value) || 650;
                if (wordCount > limit) {
                    wordCountEl.style.color = 'var(--error-color)';
                } else if (wordCount > limit * 0.9) {
                    wordCountEl.style.color = 'var(--warning-color)';
                } else {
                    wordCountEl.style.color = 'var(--success-color)';
                }
            }
        }

        function validateEssayForm() {
            const college = document.querySelector('#newEssayPage select[name="college"]');
            const degree = document.querySelector('#newEssayPage select[name="degree"]');
            const major = document.querySelector('#newEssayPage select[name="major"]');
            
            // Check if dropdowns have values selected (not default)
            const collegeValid = college && college.value && !college.value.includes('---');
            const degreeValid = degree && degree.value && !degree.value.includes('---');
            const majorValid = major && major.value && !major.value.includes('---');
            
            return collegeValid && degreeValid && majorValid;
        }

        async function analyzeEssay() {
            const essayContent = document.getElementById('essayContentInput').value.trim();
            const wordCount = essayContent ? essayContent.split(/\s+/).length : 0;
            
            if (wordCount < 20) {
                alert('Please enter at least 20 words for your essay.');
                return;
            }
            
            if (!validateEssayForm()) {
                alert('Please fill in all required fields (College, Degree, Major).');
                return;
            }
            
            // Get form data
            const title = document.querySelector('#newEssayPage input[placeholder="Enter essay topic"]').value.trim() || 'Untitled Essay';
            const questionType = document.querySelector('#newEssayPage textarea').placeholder || 'Essay prompt not specified';
            const college = document.querySelector('#newEssayPage select[name="college"]').value;
            const degree = document.querySelector('#newEssayPage select[name="degree"]').value;
            const major = document.querySelector('#newEssayPage select[name="major"]').value;
            const collegeDegree = `${college}, ${degree} in ${major}`;
            
            // Show loading state
            const analyzeBtn = document.getElementById('analyzeButton');
            analyzeBtn.disabled = true;
            analyzeBtn.innerHTML = '<span style="margin-right: 0.5rem;"></span>Analyzing with AI...';
            analyzeBtn.classList.add('loading');
            
            try {
                // Check authentication first
                // Check authentication first
                if (!isAuthenticated || !authToken) {
                    showAuth();
                    return;
                }
                
                // Submit essay for analysis
                const essayData = {
                    title: title,
                    question_type: questionType,
                    college_degree: collegeDegree,
                    content: essayContent
                };
                
                console.log('Submitting essay for analysis:', essayData);
                
                const result = await apiRequest('/api/analyze-essay', {
                    method: 'POST',
                    body: JSON.stringify(essayData)
                });
                
                console.log('Analysis result received:', result);
                

                // Store the analysis result for the editor
                localStorage.setItem('current_analysis', JSON.stringify(result));
                localStorage.setItem('current_essay_content', essayContent);
                localStorage.setItem('current_essay_title', title);
                
                // Show editor with actual analysis results
                showEssayEditor();
                displayAnalysisResults(result);
                
                // Refresh essays list to show the new essay
                if (isAuthenticated) {
                    await fetchUserEssays();
                }
                
            } catch (error) {
                console.error('Essay analysis failed:', error);
                let errorMessage = 'Failed to analyze essay. Please try again.';
                
                if (error.message.includes('401')) {
                    errorMessage = 'Please log in to analyze essays.';
                    showAuth();
                } else if (error.message.includes('403')) {
                    errorMessage = 'Insufficient credits. Please contact support.';
                } else if (error.message.includes('network') || error.message.includes('fetch')) {
                    errorMessage = 'Network error. Please check your connection and try again.';
                }
                
                showError(errorMessage);
            } finally {
                // Reset button state
                analyzeBtn.disabled = false;
                analyzeBtn.innerHTML = ' Analyze Essay with AI';
                analyzeBtn.classList.remove('loading');
            }
        }

        // Display analysis results in the editor
        // Display analysis results in the editor
        function displayAnalysisResults(analysisResult) {
            console.log('Displaying analysis results:', analysisResult);
            
            if (!analysisResult) {
                console.error('No analysis result provided');
                showAnalysisLoading();
                return;
            }
            
            // Handle both direct analysis object and wrapped response
            const analysis = analysisResult.analysis || analysisResult;
            
            if (!analysis) {
                console.error('No analysis data found in result');
                showAnalysisLoading();
                return;
            }
            
            console.log('Analysis object:', analysis);
            
            // Update overall score
            const overallScore = analysis.overall_score || 0;
            console.log('Setting overall score to:', overallScore);
            updateOverallScore(overallScore);
            
            // Update score description
            const scoreDescription = document.querySelector('.score-description');
            if (scoreDescription && analysis.admissions_perspective) {
                scoreDescription.textContent = analysis.admissions_perspective;
            }
            
            // Update metric scores with actual API response structure
            const contentBreakdown = analysis.content_breakdown || {};
            console.log('Content breakdown:', contentBreakdown);
            
            const metrics = [
                { name: 'Alignment with Topic', score: contentBreakdown.alignment_with_topic || 0 },
                { name: 'Alignment with Brainstorming', score: contentBreakdown.brainstorming_structure || 0 },
                { name: 'Essay Narrative & Impact', score: contentBreakdown.narrative_impact || 0 },
                { name: 'Language & Structure', score: contentBreakdown.language_structure || 0 },
                { name: 'Alignment with College Values', score: contentBreakdown.college_alignment || 0 }
            ];
            
            console.log('Updating metrics:', metrics);
            
            // Animate metric updates with a delay
            metrics.forEach((metric, index) => {
                setTimeout(() => {
                    if (metric.score > 0) {
                        updateMetricBar(metric.name, metric.score);
                    }
                }, index * 200);
            });
            
            // Update suggestions/highlights from API response
            const highlights = analysisResult.highlights || [];
            console.log('Updating highlights:', highlights.length, 'items');
            if (highlights && highlights.length > 0) {
                updateSuggestions(highlights);
            }
            
            // Update admissions perspective in summary
            if (analysis.admissions_perspective) {
                updateAdmissionsPerspective(analysis.admissions_perspective);
            }
            
            // Update summary section with AI provider info
            const aiProvider = analysisResult.ai_provider || 'Previous Analysis';
            const processingTime = analysisResult.processing_time || 0;
            updateAnalysisSummary(analysis, aiProvider, processingTime);
            
            // Show that this is a past analysis
            // Show appropriate indicator based on analysis type
            if (analysisResult.ai_provider && analysisResult.ai_provider.includes('Enhanced')) {
                // This is a fresh analysis
                showReEvaluationSuccess();
            } else if (analysisResult.ai_provider === 'Previous Analysis' || analysisResult.ai_provider === 'Stored Analysis') {
                // This is a past analysis
                addPastAnalysisIndicator(analysisResult);
            }
        }
        // Add indicator that this is a past analysis
function addPastAnalysisIndicator(analysisResult) {
    const analysisPanel = document.getElementById('analysisPanel');
    if (!analysisPanel) return;
    
    // Remove existing indicator
    const existingIndicator = analysisPanel.querySelector('.past-analysis-indicator');
    if (existingIndicator) {
        existingIndicator.remove();
    }
    
    // Add past analysis indicator
    const indicator = document.createElement('div');
    indicator.className = 'past-analysis-indicator';
    indicator.style.cssText = `
        background: #fef3c7;
        border: 1px solid #f59e0b;
        border-radius: var(--border-radius);
        padding: 0.75rem;
        margin-bottom: 1rem;
        font-size: 0.875rem;
        color: #92400e;
    `;
    indicator.innerHTML = `
        <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
            <span></span>
            <strong>Past Analysis Results</strong>
        </div>
        <div style="font-size: 0.75rem; color: #78350f;">
            These are the results from your previous evaluation. Edit your essay above and click "Evaluate Again" to get updated scores.
        </div>
    `;
    
    // Insert at the beginning of the analysis panel
    const scoreCircle = analysisPanel.querySelector('.score-circle');
    if (scoreCircle) {
        analysisPanel.insertBefore(indicator, scoreCircle);
    }
}

// Show success message
function showSuccessMessage(message) {
    // Remove existing success message
    const existing = document.querySelector('.success-message');
    if (existing) existing.remove();
    
    const successDiv = document.createElement('div');
    successDiv.className = 'success-message';
    successDiv.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: #10b981;
        color: white;
        padding: 1rem 1.5rem;
        border-radius: var(--border-radius);
        box-shadow: var(--shadow-lg);
        z-index: 1000;
        animation: slideIn 0.3s ease-out;
        max-width: 400px;
    `;
    successDiv.innerHTML = `
        <div style="display: flex; align-items: center; gap: 0.5rem;">
            <span></span>
            <span>${message}</span>
        </div>
    `;
    
    document.body.appendChild(successDiv);
    
    // Auto-remove after 5 seconds
    setTimeout(() => {
        successDiv.style.animation = 'slideOut 0.3s ease-in';
        setTimeout(() => successDiv.remove(), 300);
    }, 5000);
}

// Re-evaluate the current essay content
// Re-evaluate the current essay content
// Re-evaluate the current essay content
async function evaluateAgain() {
    const currentContent = document.getElementById('editableContent').textContent || document.getElementById('editableContent').innerText || '';
    const currentTitle = localStorage.getItem('current_essay_title') || 'Untitled Essay';
    const essayId = localStorage.getItem('current_essay_id');
    
    if (!currentContent || currentContent.trim().length < 20) {
        alert('Please ensure your essay has at least 20 words before evaluating.');
        return;
    }
    
    if (!isAuthenticated || !authToken) {
        showAuth();
        return;
    }
    
    // For re-evaluation, show upgrade modal instead of blocking
    if (currentUser && currentUser.credits <= 0) {
        showUpgradeModal();
        return;
    }
    
    // Show loading state
    const evaluateBtn = document.querySelector('.btn[onclick="evaluateAgain()"]');
    if (evaluateBtn) {
        evaluateBtn.disabled = true;
        evaluateBtn.innerHTML = '<span style="margin-right: 0.5rem;"></span>Re-evaluating...';
    }
    
    // Show loading in analysis panel
    showAnalysisLoading();
    
    try {
        // Delete the old essay first (to avoid duplicates)
        await apiRequest(`/api/essays/${essayId}`, { method: 'DELETE' });
        
        // Create new essay with updated content using existing endpoint
        const essayData = {
            title: currentTitle,
            question_type: originalEssay.question_type,
            college_degree: originalEssay.college_degree,
            content: currentContent.trim()
        };
        
        console.log('Re-evaluating essay:', essayData);
        
        const result = await apiRequest('/api/analyze-essay', {
            method: 'POST',
            body: JSON.stringify(essayData)
        });
        
        console.log('Re-evaluation result:', result);
        
        // Update stored data with new analysis
        localStorage.setItem('current_analysis', JSON.stringify(result));
        localStorage.setItem('current_essay_content', currentContent);

        // Display new results
        displayAnalysisResults(result);
        
        // Show success message
        showSuccessMessage('Essay re-evaluated successfully! Your updated scores are displayed below.');
        
        // Refresh essays list to show updated essay
        if (isAuthenticated) {
            await fetchUserEssays();
        }
        
    } catch (error) {
        console.error('Re-evaluation failed:', error);
        
        let errorMessage = 'Failed to re-evaluate essay. Please try again.';
        if (error.message.includes('401')) {
            errorMessage = 'Please log in to evaluate essays.';
            showAuth();
        } else if (error.message.includes('403')) {
            errorMessage = 'Insufficient credits. Please contact support.';
        } else if (error.message.includes('404')) {
            errorMessage = 'Essay not found. Please refresh the page and try again.';
        }
        
        showError(errorMessage);
        
        // Restore previous analysis if available
        setTimeout(() => {
            loadStoredAnalysis();
        }, 500);
        
    } finally {
        // Reset button state
        if (evaluateBtn) {
            evaluateBtn.disabled = false;
            evaluateBtn.innerHTML = ' Evaluate Again';
        }
    }
}
// Show re-evaluation success indicator
function showReEvaluationSuccess() {
    // Remove past analysis indicator
    const pastIndicator = document.querySelector('.past-analysis-indicator');
    if (pastIndicator) {
        pastIndicator.remove();
    }
    
    // Add re-evaluation success indicator
    const analysisPanel = document.getElementById('analysisPanel');
    if (!analysisPanel) return;
    
    const indicator = document.createElement('div');
    indicator.className = 'reevaluation-success-indicator';
    indicator.style.cssText = `
        background: #d1fae5;
        border: 1px solid #10b981;
        border-radius: var(--border-radius);
        padding: 0.75rem;
        margin-bottom: 1rem;
        font-size: 0.875rem;
        color: #047857;
        animation: fadeIn 0.3s ease-out;
    `;
    indicator.innerHTML = `
        <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
            <span></span>
            <strong>Fresh Analysis Complete!</strong>
        </div>
        <div style="font-size: 0.75rem; color: #065f46;">
            Your essay has been re-evaluated with the latest content. These are your updated scores.
        </div>
    `;
    
    // Insert at the beginning of the analysis panel
    const scoreCircle = analysisPanel.querySelector('.score-circle');
    if (scoreCircle) {
        analysisPanel.insertBefore(indicator, scoreCircle);
    }
    
    // Auto-remove after 10 seconds
    setTimeout(() => {
        if (indicator.parentNode) {
            indicator.style.animation = 'fadeOut 0.3s ease-in';
            setTimeout(() => indicator.remove(), 300);
        }
    }, 10000);
}

// Show success message
        function showSuccessMessage(message) {
            // Remove existing success message
            const existing = document.querySelector('.success-message');
            if (existing) existing.remove();
            
            const successDiv = document.createElement('div');
            successDiv.className = 'success-message';
            successDiv.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #10b981;
                color: white;
                padding: 1rem 1.5rem;
                border-radius: var(--border-radius);
                box-shadow: var(--shadow-lg);
                z-index: 1000;
                animation: slideIn 0.3s ease-out;
            `;
            successDiv.innerHTML = `
                <div style="display: flex; align-items: center; gap: 0.5rem;">
                    <span></span>
                    <span>${message}</span>
                </div>
            `;
            
            document.body.appendChild(successDiv);
            
            // Auto-remove after 4 seconds
            setTimeout(() => {
                successDiv.style.animation = 'slideOut 0.3s ease-in';
                setTimeout(() => successDiv.remove(), 300);
            }, 4000);
        }
        // Load analysis from stored results (for when returning to editor)
        function loadStoredAnalysis() {
            try {
                const storedAnalysis = localStorage.getItem('current_analysis');
                console.log('Loading stored analysis:', storedAnalysis ? 'found' : 'not found');
                
                if (storedAnalysis) {
                    const analysisData = JSON.parse(storedAnalysis);
                    console.log('Parsed analysis data:', analysisData);
                    
                    // Ensure the analysis has the correct structure for display
                    if (analysisData.analysis || analysisData.overall_score) {
                        displayAnalysisResults(analysisData);
                        return true;
                    }
                }
            } catch (error) {
                console.error('Failed to load stored analysis:', error);
            }
            return false;
        }

        function updateMetricBar(metricName, score) {
            const metrics = document.querySelectorAll('.metric');
            metrics.forEach(metric => {
                const nameEl = metric.querySelector('.metric-name');
                if (nameEl && nameEl.textContent === metricName) {
                    const scoreEl = metric.querySelector('.metric-score');
                    const progressEl = metric.querySelector('.metric-progress');
                    
                    scoreEl.textContent = score.toFixed(1);
                    progressEl.style.width = `${score * 10}%`;
                    
                    // Update color based on score
                    if (score >= 8) {
                        progressEl.style.background = '#10b981'; // Green
                    } else if (score >= 7) {
                        progressEl.style.background = '#3b82f6'; // Blue  
                    } else if (score >= 6) {
                        progressEl.style.background = '#f59e0b'; // Orange
                    } else {
                        progressEl.style.background = '#ef4444'; // Red
                    }
                }
            });
        }

        function updateOverallScore(score) {
            const scoreElement = document.querySelector('.score-number');
            if (scoreElement) {
                scoreElement.textContent = score.toFixed(1);
            }

            // Update progress circle
            const circle = document.querySelector('.score-chart circle:last-child');
            if (circle) {
                const circumference = 2 * Math.PI * 54;
                const offset = circumference - (score / 10) * circumference;
                circle.style.strokeDashoffset = offset;
            }
        }

        // Show loading state for analysis
        // Show loading state for analysis
        function showAnalysisLoading() {
            // Remove past analysis indicator
            const indicator = document.querySelector('.past-analysis-indicator');
            if (indicator) {
                indicator.remove();
            }
            
            // Reset overall score
            const scoreElement = document.querySelector('.score-number');
            if (scoreElement) {
                scoreElement.textContent = '';
            }
            
            // Reset score description
            const scoreDescription = document.querySelector('.score-description');
            if (scoreDescription) {
                scoreDescription.textContent = 'Analyzing your essay...';
            }
            
            // Reset all metric bars to loading state
            const metrics = document.querySelectorAll('.metric');
            metrics.forEach(metric => {
                const scoreEl = metric.querySelector('.metric-score');
                const progressEl = metric.querySelector('.metric-progress');
                
                scoreEl.textContent = '';
                progressEl.style.width = '0%';
                progressEl.style.background = '#e5e7eb';
            });
            
            // Clear suggestions
            const commentsPanel = document.getElementById('commentsPanel');
            if (commentsPanel) {
                commentsPanel.innerHTML = '<div style="text-align: center; padding: 2rem; color: var(--text-light);">Loading suggestions...</div>';
            }
        }

        // Update suggestions in the comments panel
        function updateSuggestions(highlights) {
            const commentsPanel = document.getElementById('commentsPanel');
            if (!commentsPanel) return;
            
            commentsPanel.innerHTML = highlights.map(highlight => `
                <div class="suggestion-item">
                    <div class="suggestion-type">${highlight.type}</div>
                    <div class="suggestion-text">${escapeHtml(highlight.text)}</div>
                    <div class="suggestion-fix">${escapeHtml(highlight.suggestion)}</div>
                </div>
            `).join('');
            
            // Update suggestions count
            const suggestionsCount = document.querySelector('.suggestions-count');
            if (suggestionsCount) {
                suggestionsCount.textContent = highlights.length;
            }
        }

        // Update admissions perspective
        function updateAdmissionsPerspective(perspective) {
            // Find the summary section and update it
            const summarySection = document.querySelector('#analysisPanel [style*="margin-top: 2rem"]');
            if (summarySection) {
                const summaryText = summarySection.querySelector('div[style*="margin-bottom: 1.5rem"]');
                if (summaryText) {
                    summaryText.textContent = perspective;
                }
            }
        }

        // Update analysis summary with AI provider info
        function updateAnalysisSummary(analysis, aiProvider, processingTime) {
            const summarySection = document.querySelector('#analysisPanel [style*="margin-top: 2rem"]');
            if (summarySection) {
                const summaryText = summarySection.querySelector('div[style*="margin-bottom: 1.5rem"]');
                if (summaryText && analysis.admissions_perspective) {
                    summaryText.textContent = analysis.admissions_perspective;
                }
                
                // Add processing info
                const providerInfo = document.createElement('div');
                providerInfo.style.cssText = 'font-size: 0.75rem; color: var(--text-light); margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--border-light);';
                providerInfo.innerHTML = `
                    <div>Analysis by: ${aiProvider}</div>
                    <div>Processing time: ${processingTime.toFixed(2)}s</div>
                `;
                
                // Remove existing provider info if present
                const existingInfo = summarySection.querySelector('[data-provider-info]');
                if (existingInfo) {
                    existingInfo.remove();
                }
                
                providerInfo.setAttribute('data-provider-info', 'true');
                summarySection.appendChild(providerInfo);
            }
        }

        function showEssayEditor() {
            showPage('editorPage');
            updateChatMessage("Edit your essay in the left panel - your writing workspace is fully editable and accessible as you go.");
            
            // Load stored content if available
            const storedContent = localStorage.getItem('current_essay_content');
            const storedTitle = localStorage.getItem('current_essay_title');
            const essayId = localStorage.getItem('current_essay_id');
            
            console.log('Loading editor with:', { title: storedTitle, hasContent: !!storedContent, essayId });
            
            if (storedContent) {
                const editorContent = document.getElementById('editableContent');
                if (editorContent) {
                    editorContent.textContent = storedContent;
                    console.log('Loaded essay content:', storedContent.substring(0, 100) + '...');
                }
            }
            
            if (storedTitle) {
                const titleElement = document.querySelector('#editorPage .editor-title-section h2');
                if (titleElement) {
                    titleElement.textContent = storedTitle;
                    console.log('Set editor title to:', storedTitle);
                }
                
                // Update the header badge with essay info
                const headerBadge = document.querySelector('#editorPage .header-section span[style*="background: #e0e7ff"]');
                if (headerBadge && storedContent) {
                    const wordCount = storedContent.split(/\s+/).length;
                    headerBadge.textContent = `${storedTitle.substring(0, 30)}... - ${wordCount} words`;
                }
            }
            
            // Initialize word count and toolbar states
            setTimeout(() => {
                updateWordCount();
                updateToolbarButtonStates();
            }, 100);
            
            // Load stored analysis results if available, otherwise show loading state
            setTimeout(() => {
                const hasStoredAnalysis = loadStoredAnalysis();
                if (!hasStoredAnalysis) {
                    console.log('No stored analysis found, showing loading state');
                    showAnalysisLoading();
                } else {
                    console.log('Loaded stored analysis successfully');
                }
            }, 500);
        }
        // Debug function to test essay loading
        function debugEssayClick(essayId) {
            console.log('Debug: Essay clicked with ID:', essayId);
            console.log('Available essays:', userEssays.map(e => ({ id: e.id, title: e.title })));
            
            const essay = userEssays.find(e => e.id === essayId);
            console.log('Found essay:', essay ? essay.title : 'NOT FOUND');
            
            if (essay) {
                loadEssayEditor(essayId);
            }
        }

        // Load essay editor with specific essay
        // Load essay editor with specific essay
        async function loadEssayEditor(essayId) {
            try {
                console.log('Loading essay with ID:', essayId);
                
                // Find the essay in our current list
                const essay = userEssays.find(e => e.id === essayId);
                if (!essay) {
                    console.error('Essay not found with ID:', essayId);
                    showError('Essay not found');
                    return;
                }
                
                console.log('Found essay:', essay.title);
                
                // Clear any existing stored analysis to prevent conflicts
                localStorage.removeItem('current_analysis');
                localStorage.removeItem('current_essay_content');
                localStorage.removeItem('current_essay_title');
                
                // Store the current essay data
                localStorage.setItem('current_essay_content', essay.content);
                localStorage.setItem('current_essay_title', essay.title);
                localStorage.setItem('current_essay_id', essay.id);
                
                // Parse and store analysis results if available
                if (essay.analysis_result) {
                    try {
                        const analysisData = JSON.parse(essay.analysis_result);
                        
                        // Ensure the analysis data has the correct structure
                        const formattedAnalysis = {
                            status: "success",
                            analysis: analysisData.analysis || analysisData,
                            highlights: analysisData.highlights || [],
                            ai_provider: "Stored Analysis",
                            processing_time: essay.processing_time || 0
                        };
                        
                        localStorage.setItem('current_analysis', JSON.stringify(formattedAnalysis));
                        console.log('Stored analysis data for essay:', essay.title);
                    } catch (error) {
                        console.error('Failed to parse analysis data:', error);
                    }
                } else {
                    console.log('No analysis data found for essay:', essay.title);
                }
                
                // Show the editor page
                showEssayEditor();
                
            } catch (error) {
                console.error('Failed to load essay:', error);
                showError('Failed to load essay. Please try again.');
            }
        }

        // ================================
        // EVENT HANDLERS & UI FUNCTIONS
        // ================================

        function handleLogin(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            const email = formData.get('email') || e.target.querySelector('input[type="email"]').value;
            const password = formData.get('password') || e.target.querySelector('input[type="password"]').value;
            
            loginUser(email, password);
        }

        function toggleAuthMode() {
            const title = document.getElementById('authTitle');
            const subtitle = document.getElementById('authSubtitle');
            const submitBtn = document.querySelector('#loginForm button[type="submit"]');
            const toggleLink = document.querySelector('#authModal a');
            
            if (title.textContent.includes('Welcome')) {
                // Switch to register mode
                title.textContent = 'Create Account';
                subtitle.textContent = 'Join HelloIvy to get started';
                submitBtn.textContent = 'Sign Up';
                toggleLink.textContent = 'Already have an account? Sign in';
                
                // Update form handler
                document.getElementById('loginForm').onsubmit = function(e) {
                    e.preventDefault();
                    const email = e.target.querySelector('input[type="email"]').value;
                    const password = e.target.querySelector('input[type="password"]').value;
                    registerUser(email, password);
                };
            } else {
                // Switch to login mode
                title.textContent = 'Welcome to HelloIvy';
                subtitle.textContent = 'Sign in to access your essay tools';
                submitBtn.textContent = 'Sign In';
                toggleLink.textContent = "Don't have an account? Sign up";
                
                // Update form handler
                document.getElementById('loginForm').onsubmit = handleLogin;
            }
        }

        function showBrainstormer() {
            document.getElementById('brainstormerModal').classList.add('show');
        }

        function hideBrainstormer() {
            document.getElementById('brainstormerModal').classList.remove('show');
        }

        function goToBrainstormer() {
            hideBrainstormer();
            alert('Brainstormer feature coming soon!');
        }

        function continueWithEvaluator() {
            hideBrainstormer();
            showPage('essayListPage');
            updateChatMessage("Looks like You haven't uploaded any essays yet. To get started, click \"New Essay\" to upload your draft or create one from scratch. Once uploaded, you'll enter the editing and evaluation workspace.");
        }

        function switchTab(tabBtn) {
            const tabContainer = tabBtn.closest('.analysis-tabs').parentNode;
            const tabId = tabBtn.getAttribute('data-tab');
            
            // Remove active class from all tabs and panels
            tabContainer.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            tabContainer.querySelectorAll('.tab-panel').forEach(panel => panel.classList.remove('active'));
            
            // Add active class to clicked tab
            tabBtn.classList.add('active');
            
            // Show corresponding panel
            const targetPanel = document.getElementById(tabId + 'Panel');
            if (targetPanel) {
                targetPanel.classList.add('active');
            }
        }

        function uploadEssayAgain() {
            if (confirm('Are you sure you want to upload a new essay? This will replace your current work.')) {
                showNewEssayForm();
            }
        }

        function goToRecommendations() {
            alert('Recommendation feature coming soon!');
        }

        function goToHomePage() {
            showPage('landingPage');
        }

        function setActiveTab(tab) {
            // Update nav items
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // Add active class to the clicked tab
            event.target.closest('.nav-item').classList.add('active');
        }

        // Add form validation listeners
        function setupFormValidation() {
            const selects = document.querySelectorAll('#newEssayPage select');
            selects.forEach(select => {
                select.addEventListener('change', updateEssayWordCount);
            });
            
            // Add proper name attributes to selects for validation
            const collegeSelect = document.querySelector('#newEssayPage .form-row .form-group:first-child select');
            const degreeSelect = document.querySelector('#newEssayPage .form-row .form-group:nth-child(2) select');
            const majorSelect = document.querySelector('#newEssayPage .form-row .form-group:nth-child(3) select');
            
            if (collegeSelect) collegeSelect.name = 'college';
            if (degreeSelect) degreeSelect.name = 'degree';
            if (majorSelect) majorSelect.name = 'major';
        }

        function setupEventListeners() {
            // Agreement checkbox
            const checkbox = document.getElementById('agreedCheckbox');
            const getStartedBtn = document.getElementById('getStartedBtn');
            
            checkbox?.addEventListener('change', function() {
                getStartedBtn.disabled = !this.checked;
            });

            // Tab switching
            document.addEventListener('click', function(e) {
                if (e.target.classList.contains('tab-btn')) {
                    switchTab(e.target);
                }
            });

            // Form submissions
            document.getElementById('loginForm')?.addEventListener('submit', handleLogin);
            
            // Setup form validation when page loads
            setTimeout(setupFormValidation, 100);
            
            // HelloIvy logo navigation
            document.addEventListener('click', function(e) {
                if (e.target.closest('.header-logo')) {
                    goToHomePage();
                }
            });
            
            // Setup keyboard shortcuts for rich text
            setupKeyboardShortcuts();
        }

        // ================================
        // MAKE FUNCTIONS GLOBALLY ACCESSIBLE
        // ================================
        window.refreshEssays = refreshEssays;
        window.showNewEssayForm = showNewEssayForm;
        window.showAuth = showAuth;
        window.hideAuth = hideAuth;
        window.logout = logout;
        window.showPage = showPage;
        window.formatText = formatText;
        window.insertList = insertList;
        window.createLink = createLink;
        window.updateWordCount = updateWordCount;
        window.trackChanges = trackChanges;

        // ================================
        // INITIALIZATION
        // ================================
        
        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM Content Loaded, initializing app...');
            testAPIConnection();
            checkAuthenticationStatus();
            setupEventListeners();
            setupKeyboardShortcuts();
        });

        // Handle page visibility
        document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
                // Page is hidden - pause any animations or auto-saves
            } else {
                // Page is visible - resume functionality
                updateWordCount();
            }
        });

        // Error handling
        window.addEventListener('error', function(e) {
            console.error('Application error:', e.error);
        });

        // Performance monitoring
        if ('performance' in window) {
            window.addEventListener('load', function() {
                setTimeout(function() {
                    const perfData = performance.getEntriesByType('navigation')[0];
                    console.log('Page load time:', perfData.loadEventEnd - perfData.loadEventStart);
                }, 0);
            });
        }
        // ================================
// BRAINSTORMING CORE FUNCTIONS
// ================================
function initializeBrainstorming() {
    console.log('Initializing Voice Brainstorming...');
    
    // Setup speech recognition
    if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
        setupBrainstormingSpeechRecognition();
    } else {
        console.warn('Speech recognition not supported');
        updateRecordButton('not-supported');
    }
    
    // Initialize session
    createNewSession();
    
    // Setup message input handling
    setupMessageInput();
    
    // Start session timer
    startSessionTimer();
    
    console.log('Voice Brainstorming initialized');
}

function setupBrainstormingSpeechRecognition() {
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    brainstormingRecognition = new SpeechRecognition();
    
    brainstormingRecognition.continuous = false;
    brainstormingRecognition.interimResults = false;
    brainstormingRecognition.lang = 'en-US';
    
    brainstormingRecognition.onstart = function() {
        console.log('Brainstorming speech recognition started');
        updateRecordButton('recording');
        addTypingIndicator();
    };
    
    brainstormingRecognition.onresult = function(event) {
        const transcript = event.results[0][0].transcript;
        console.log('Speech recognized:', transcript);
        
        removeTypingIndicator();
        
        // Add user message to conversation
        addMessage('user', transcript);
        
        // Process the response
        processBrainstormingResponse(transcript);
    };
    
    brainstormingRecognition.onerror = function(event) {
        console.error('Speech recognition error:', event.error);
        removeTypingIndicator();
        updateRecordButton('idle');
        
        addMessage('ai', "I had trouble hearing that. Could you please try again or type your response?");
    };
    
    brainstormingRecognition.onend = function() {
        console.log('Speech recognition ended');
        brainstormingData.isRecording = false;
        updateRecordButton('idle');
    };
}

function toggleRecording() {
    if (!brainstormingRecognition) {
        alert('Voice recording is not supported in your browser. Please type your response instead.');
        return;
    }
    
    if (brainstormingData.isRecording) {
        // Stop recording
        brainstormingRecognition.stop();
        brainstormingData.isRecording = false;
        updateRecordButton('idle');
    } else {
        // Start recording
        brainstormingData.isRecording = true;
        brainstormingRecognition.start();
    }
}

function updateRecordButton(state) {
    const recordBtn = document.getElementById('recordBtn');
    const recordIcon = document.getElementById('recordIcon');
    const recordText = document.getElementById('recordText');
    
    recordBtn.className = 'record-btn';
    recordBtn.disabled = false;
    
    switch(state) {
        case 'idle':
            recordIcon.textContent = '';
            recordText.textContent = 'Start Recording';
            break;
        case 'recording':
            recordBtn.classList.add('recording');
            recordIcon.textContent = '';
            recordText.textContent = 'Stop Recording';
            break;
        case 'processing':
            recordBtn.classList.add('processing');
            recordBtn.disabled = true;
            recordIcon.textContent = '';
            recordText.textContent = 'Processing...';
            break;
        case 'not-supported':
            recordBtn.disabled = true;
            recordIcon.textContent = '';
            recordText.textContent = 'Not Supported';
            break;
    }
}

function setupMessageInput() {
    const messageInput = document.getElementById('messageInput');
    const sendBtn = document.getElementById('sendBtn');
    
    messageInput.addEventListener('input', function() {
        const hasText = this.value.trim().length > 0;
        sendBtn.disabled = !hasText;
    });
}

function handleEnterKey(event) {
    if (event.key === 'Enter' && !event.shiftKey) {
        event.preventDefault();
        sendMessage();
    }
}

function sendMessage() {
    const messageInput = document.getElementById('messageInput');
    const message = messageInput.value.trim();
    
    if (!message) return;
    
    // Clear input
    messageInput.value = '';
    document.getElementById('sendBtn').disabled = true;
    
    // Add user message
    addMessage('user', message);
    
    // Process the response
    processBrainstormingResponse(message);
}

function addMessage(sender, content, timestamp = null) {
    const messagesContainer = document.getElementById('conversationMessages');
    const messageTime = timestamp || new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
    
    const messageElement = document.createElement('div');
    messageElement.className = `message ${sender}`;
    messageElement.innerHTML = `
        <div class="message-avatar ${sender}">
            ${sender === 'ai' ? '' : ''}
        </div>
        <div class="message-content">
            <div class="message-bubble">
                ${content}
            </div>
            <div class="message-time">${messageTime}</div>
        </div>
    `;
    
    messagesContainer.appendChild(messageElement);
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
    
    // Update exchange count
    if (sender === 'user') {
        brainstormingData.totalExchanges++;
        updateSessionStats();
    }
}

function addTypingIndicator() {
    const messagesContainer = document.getElementById('conversationMessages');
    
    const typingElement = document.createElement('div');
    typingElement.className = 'typing-indicator';
    typingElement.id = 'typingIndicator';
    typingElement.innerHTML = `
        <div class="message-avatar ai"></div>
        <span>AI is thinking</span>
        <div class="typing-dots">
            <div class="typing-dot"></div>
            <div class="typing-dot"></div>
            <div class="typing-dot"></div>
        </div>
    `;
    
    messagesContainer.appendChild(typingElement);
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
}

function removeTypingIndicator() {
    const typingIndicator = document.getElementById('typingIndicator');
    if (typingIndicator) {
        typingIndicator.remove();
    }
}

// ================================
// BRAINSTORMING RESPONSE PROCESSING
// ================================
async function processBrainstormingResponse(userInput) {
    updateRecordButton('processing');
    addTypingIndicator();
    
    try {
        // Simulate AI processing
        await new Promise(resolve => setTimeout(resolve, 1500));
        
        // Extract insights from user input
        const extractedInsights = extractInsightsFromInput(userInput);
        
        // Update memory with extracted insights
        updateMemoryWithInsights(extractedInsights);
        
        // Generate AI response
        const aiResponse = await generateAIResponse(userInput, brainstormingData.currentTopic);
        
        // Remove typing indicator and add AI response
        removeTypingIndicator();
        addMessage('ai', aiResponse);
        
        // Update UI
        updateMemoryDisplay();
        checkEssayGenerationReadiness();
        
        // Suggest topic change if needed
        suggestTopicChange();
        
    } catch (error) {
        console.error('Error processing response:', error);
        removeTypingIndicator();
        addMessage('ai', "I apologize, I had trouble processing that. Could you please try again?");
    } finally {
        updateRecordButton('idle');
    }
}

function extractInsightsFromInput(input) {
    const insights = {
        experiences: [],
        challenges: [],
        achievements: [],
        goals: [],
        values: [],
        skills: []
    };
    
    const inputLower = input.toLowerCase();
    
    // Experience patterns
    const experienceKeywords = ['when i', 'i participated', 'i was involved', 'experience', 'time when'];
    if (experienceKeywords.some(keyword => inputLower.includes(keyword))) {
        insights.experiences.push(input);
    }
    
    // Challenge patterns
    const challengeKeywords = ['difficult', 'challenge', 'struggle', 'hard', 'overcome', 'obstacle'];
    if (challengeKeywords.some(keyword => inputLower.includes(keyword))) {
        insights.challenges.push(input);
    }
    
    // Achievement patterns
    const achievementKeywords = ['won', 'achieved', 'accomplished', 'proud', 'successful', 'award'];
    if (achievementKeywords.some(keyword => inputLower.includes(keyword))) {
        insights.achievements.push(input);
    }
    
    // Goal patterns
    const goalKeywords = ['want to', 'hope to', 'plan to', 'goal', 'future', 'aspire'];
    if (goalKeywords.some(keyword => inputLower.includes(keyword))) {
        insights.goals.push(input);
    }
    
    // Value patterns
    const valueKeywords = ['believe', 'important to me', 'value', 'principle', 'care about'];
    if (valueKeywords.some(keyword => inputLower.includes(keyword))) {
        insights.values.push(input);
    }
    
    // Skill patterns
    const skillKeywords = ['good at', 'skilled', 'talent', 'ability', 'capable'];
    if (skillKeywords.some(keyword => inputLower.includes(keyword))) {
        insights.skills.push(input);
    }
    
    return insights;
}

function updateMemoryWithInsights(insights) {
    Object.keys(insights).forEach(category => {
        if (insights[category].length > 0) {
            brainstormingData.memory[category] = brainstormingData.memory[category].concat(insights[category]);
        }
    });
}

async function generateAIResponse(userInput, currentTopic) {
    // In production, this would call your backend API
    // For demo, we'll use predefined responses based on topic and input analysis
    
    const responses = {
        introduction: [
            "That's wonderful! I can sense your passion for that. Can you tell me more about how you first discovered this interest?",
            "I love hearing about what excites you! What specific moment made you realize this was important to you?",
            "That sounds fascinating! How has this shaped who you are as a person?"
        ],
        experiences: [
            "That's a powerful experience! What did that teach you about yourself?",
            "Wow, that must have been significant. How did that change your perspective?",
            "That's really interesting. What was the most challenging part of that experience?"
        ],
        challenges: [
            "Thank you for sharing that challenge. How did you find the strength to overcome it?",
            "That sounds like it was really difficult. What did you learn about yourself through that experience?",
            "I appreciate your honesty about that struggle. How are you different now because of it?"
        ],
        achievements: [
            "Congratulations on that achievement! What personal qualities helped you succeed?",
            "That's impressive! What was the most rewarding part of that accomplishment?",
            "Amazing work! How did that success influence your future goals?"
        ],
        goals: [
            "Those are ambitious goals! What specific steps are you taking to achieve them?",
            "I can see you have a clear vision. What motivates you to pursue these goals?",
            "That's exciting! How do you think your past experiences have prepared you for these goals?"
        ]
    };
    
    const topicResponses = responses[currentTopic] || responses.introduction;
    const randomResponse = topicResponses[Math.floor(Math.random() * topicResponses.length)];
    
    return randomResponse;
}

// ================================
// MEMORY MANAGEMENT
// ================================
function updateMemoryDisplay() {
    const categories = ['experiences', 'challenges', 'achievements', 'goals', 'values', 'skills'];
    let totalInsights = 0;
    
    categories.forEach(category => {
        const items = brainstormingData.memory[category] || [];
        const count = items.length;
        totalInsights += count;
        
        // Update count
        const countElement = document.getElementById(`${category}Count`);
        if (countElement) {
            countElement.textContent = count;
            countElement.className = count > 0 ? 'category-count filled' : 'category-count';
        }
        
        // Update items display
        const itemsElement = document.getElementById(`${category}Items`);
        if (itemsElement) {
            if (count === 0) {
                itemsElement.textContent = `No ${category} captured yet`;
                itemsElement.className = 'category-items empty';
            } else {
                itemsElement.innerHTML = items.slice(-3).map(item => 
                    `<div class="memory-item">${item.substring(0, 80)}${item.length > 80 ? '...' : ''}</div>`
                ).join('');
                itemsElement.className = 'category-items';
            }
        }
        
        // Update category styling
        const categoryElement = document.getElementById(`${category}Category`);
        if (categoryElement) {
            categoryElement.className = count > 0 ? 'memory-category filled' : 'memory-category';
        }
    });
    
    // Update progress
    document.getElementById('memoryProgress').textContent = `${totalInsights}/20`;
}

function checkEssayGenerationReadiness() {
    const categories = ['experiences', 'challenges', 'achievements', 'goals'];
    const filledCategories = categories.filter(category => 
        brainstormingData.memory[category] && brainstormingData.memory[category].length > 0
    ).length;
    
    const totalInsights = Object.values(brainstormingData.memory).reduce((total, items) => 
        total + (Array.isArray(items) ? items.length : 0), 0
    );
    
    const isReady = filledCategories >= 3 && totalInsights >= 8;
    
    const generateBtn = document.getElementById('generateEssayBtn');
    const statusElement = document.getElementById('generationStatus');
    
    if (isReady) {
        generateBtn.disabled = false;
        statusElement.textContent = 'Ready to generate your essay draft!';
    } else {
        generateBtn.disabled = true;
        const needed = Math.max(0, 8 - totalInsights);
        statusElement.textContent = `Need ${needed} more insights to generate essay`;
    }
}

// ================================
// TOPIC MANAGEMENT
// ================================
function changeTopic() {
    const topicSelector = document.getElementById('topicSelector');
    const newTopic = topicSelector.value;
    
    if (newTopic !== brainstormingData.currentTopic) {
        brainstormingData.currentTopic = newTopic;
        updateSessionStats();
        
        // Add AI message about topic change
        const topicNames = {
            introduction: 'getting to know you',
            experiences: 'your life experiences',
            challenges: 'challenges you\'ve overcome',
            achievements: 'your achievements',
            goals: 'your goals and aspirations',
            values: 'your values and beliefs',
            skills: 'your skills and talents',
            leadership: 'your leadership experiences',
            service: 'your community service',
            college_preferences: 'your college preferences'
        };
        
        const topicName = topicNames[newTopic] || newTopic;
        addMessage('ai', `Great! Let's focus on ${topicName}. What would you like to share about this area of your life?`);
    }
}

function suggestTopicChange() {
    const currentCategoryItems = brainstormingData.memory[brainstormingData.currentTopic] || [];
    
    // Suggest topic change after 3 insights in current topic
    if (currentCategoryItems.length >= 3) {
        const topics = ['experiences', 'challenges', 'achievements', 'goals', 'values', 'skills'];
        const uncoveredTopics = topics.filter(topic => 
            !brainstormingData.memory[topic] || brainstormingData.memory[topic].length === 0
        );
        
        if (uncoveredTopics.length > 0) {
            const nextTopic = uncoveredTopics[0];
            setTimeout(() => {
                const topicNames = {
                    experiences: 'life experiences',
                    challenges: 'challenges you\'ve overcome',
                    achievements: 'your achievements',
                    goals: 'your goals and aspirations',
                    values: 'your values and beliefs',
                    skills: 'your skills and talents'
                };
                
                addMessage('ai', `You've shared some great insights about ${brainstormingData.currentTopic}! Would you like to explore ${topicNames[nextTopic]} next?`);
                
                // Auto-change topic selector
                document.getElementById('topicSelector').value = nextTopic;
                brainstormingData.currentTopic = nextTopic;
                updateSessionStats();
            }, 2000);
        }
    }
}

// ================================
// SESSION MANAGEMENT
// ================================
function createNewSession() {
    const sessionId = 'session_' + Date.now();
    const newSession = {
        id: sessionId,
        name: `Brainstorming Session ${brainstormingData.sessions.length + 1}`,
        createdAt: new Date(),
        status: 'active',
        totalExchanges: 0,
        memory: {
            experiences: [],
            challenges: [],
            achievements: [],
            goals: [],
            values: [],
            skills: []
        }
    };
    
    brainstormingData.sessions.unshift(newSession);
    brainstormingData.currentSession = newSession;
    brainstormingData.currentSessionId = sessionId;
    brainstormingData.sessionStartTime = new Date();
    brainstormingData.totalExchanges = 0;
    
    // Reset memory
    brainstormingData.memory = {
        experiences: [],
        challenges: [],
        achievements: [],
        goals: [],
        values: [],
        skills: [],
        leadership: [],
        service: [],
        interests: [],
        personal_info: {}
    };
    
    updateSessionStats();
    updateMemoryDisplay();
    updateSessionsList();
    
    // Clear conversation
    const messagesContainer = document.getElementById('conversationMessages');
    messagesContainer.innerHTML = `
        <div class="message ai">
            <div class="message-avatar ai"></div>
            <div class="message-content">
                <div class="message-bubble">
                    <strong>Welcome to your new brainstorming session!</strong> I'm here to help you discover amazing stories for your college essay through natural conversation. 
                    <br><br>
                    Let's start by getting to know you better. What's something you're genuinely excited about or proud of in your life right now?
                </div>
                <div class="message-time">Just now</div>
            </div>
        </div>
    `;
    
    console.log('New brainstorming session created:', sessionId);
}

function updateSessionStats() {
    document.getElementById('currentSessionTitle').textContent = 
        brainstormingData.currentSession?.name || 'Current Session';
    document.getElementById('sessionStage').textContent = 
        brainstormingData.currentTopic.charAt(0).toUpperCase() + brainstormingData.currentTopic.slice(1);
    document.getElementById('sessionExchanges').textContent = brainstormingData.totalExchanges;
}

function startSessionTimer() {
    setInterval(() => {
        if (brainstormingData.sessionStartTime && !brainstormingData.isPaused) {
            const elapsed = Math.floor((new Date() - brainstormingData.sessionStartTime) / 1000);
            const minutes = Math.floor(elapsed / 60);
            const seconds = elapsed % 60;
            document.getElementById('sessionDuration').textContent = 
                `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }
    }, 1000);
}

function pauseSession() {
    brainstormingData.isPaused = !brainstormingData.isPaused;
    const pauseBtn = document.getElementById('pauseBtn');
    
    if (brainstormingData.isPaused) {
        pauseBtn.innerHTML = ' Resume Session';
        addMessage('ai', 'Session paused. Click resume when you\'re ready to continue.');
    } else {
        pauseBtn.innerHTML = ' Pause Session';
        addMessage('ai', 'Welcome back! Let\'s continue where we left off.');
    }
}

function resetSession() {
    if (confirm('Are you sure you want to reset this session? All progress will be lost.')) {
        createNewSession();
    }
}

function updateSessionsList() {
    const sessionsList = document.getElementById('sessionsList');
    
    if (brainstormingData.sessions.length === 0) {
        sessionsList.innerHTML = '<div style="color: var(--text-light); font-size: 0.75rem; text-align: center; padding: 1rem;">No previous sessions</div>';
        return;
    }
    
    sessionsList.innerHTML = brainstormingData.sessions.slice(0, 5).map(session => `
        <div class="session-item ${session.id === brainstormingData.currentSessionId ? 'active' : ''}" 
             onclick="loadSession('${session.id}')">
            <div class="session-item-title">${session.name}</div>
            <div class="session-item-meta">
                ${session.createdAt.toLocaleDateString()}  ${session.totalExchanges} exchanges
            </div>
        </div>
    `).join('');
}

function loadSession(sessionId) {
    const session = brainstormingData.sessions.find(s => s.id === sessionId);
    if (!session) return;
    
    brainstormingData.currentSession = session;
    brainstormingData.currentSessionId = sessionId;
    brainstormingData.memory = { ...session.memory };
    brainstormingData.totalExchanges = session.totalExchanges;
    
    updateSessionStats();
    updateMemoryDisplay();
    updateSessionsList();
    checkEssayGenerationReadiness();
    
    addMessage('ai', `Loaded session: ${session.name}. Let's continue our conversation!`);
}

// ================================
// ESSAY GENERATION
// ================================
async function generateEssayFromBrainstorming() {
    const generateBtn = document.getElementById('generateEssayBtn');
    
    generateBtn.disabled = true;
    generateBtn.textContent = ' Generating Essay...';
    
    try {
        // Simulate essay generation
        await new Promise(resolve => setTimeout(resolve, 3000));
        
        // In production, this would call your backend API
        const essayData = {
            title: "My Journey of Growth and Discovery",
            content: generateEssayContent(),
            wordCount: 650,
            type: "personal_statement"
        };
        
        // Store the generated essay
        localStorage.setItem('generated_essay', JSON.stringify(essayData));
        
        // Show success message
        alert(`Essay generated successfully!\n\nTitle: "${essayData.title}"\nWord Count: ${essayData.wordCount}\n\nYou can now review and edit your essay in the Essay Evaluator.`);
        
        // Optionally redirect to essay evaluator
        if (confirm('Would you like to review your generated essay now?')) {
            goToEssayEvaluator();
        }
        
    } catch (error) {
        console.error('Essay generation failed:', error);
        alert('Failed to generate essay. Please try again.');
    } finally {
        generateBtn.disabled = false;
        generateBtn.textContent = ' Generate Essay Draft';
    }
}

function generateEssayContent() {
    const experiences = brainstormingData.memory.experiences.slice(0, 2);
    const challenges = brainstormingData.memory.challenges.slice(0, 1);
    const achievements = brainstormingData.memory.achievements.slice(0, 1);
    const goals = brainstormingData.memory.goals.slice(0, 1);
    
    return `Throughout my journey, I have discovered that growth often comes from embracing challenges and pursuing what truly matters to me.

${experiences.length > 0 ? experiences[0] : 'My formative experiences have shaped my perspective significantly.'} This experience taught me valuable lessons about perseverance and the importance of staying true to my values.

${challenges.length > 0 ? 'When faced with ' + challenges[0].toLowerCase() + ', I learned that resilience is not just about overcoming obstacles, but about growing stronger through them.' : 'The challenges I have faced have taught me resilience and determination.'}

${achievements.length > 0 ? achievements[0] + ' This accomplishment reinforced my belief in the power of hard work and dedication.' : 'My achievements have reinforced my commitment to excellence.'}

Looking toward the future, ${goals.length > 0 ? goals[0].toLowerCase() : 'I am excited to pursue my academic and career aspirations'}. I believe that my experiences have prepared me well for the challenges and opportunities that lie ahead.

As I embark on this next chapter of my educational journey, I am committed to bringing the same passion, dedication, and growth mindset that have served me well thus far.`;
}

// ================================
// UTILITY FUNCTIONS
// ================================
function playLastResponse() {
    if (lastRecordedAudio && 'speechSynthesis' in window) {
        // In a real implementation, you would play back the actual recorded audio
        // For demo, we'll just provide feedback
        alert('Audio playback feature would play your last recorded response here.');
    } else {
        alert('No audio to play back.');
    }
}

// ================================
// INTEGRATION WITH MAIN APP
// ================================
function goToBrainstormer() {
    showPage('brainstormingPage');
    
    // Initialize brainstorming when page is shown
    setTimeout(() => {
        initializeBrainstorming();
    }, 100);
}

// Make functions globally accessible
window.goToBrainstormer = goToBrainstormer;
window.initializeBrainstorming = initializeBrainstorming;
window.toggleRecording = toggleRecording;
window.sendMessage = sendMessage;
window.handleEnterKey = handleEnterKey;
window.changeTopic = changeTopic;
window.createNewSession = createNewSession;
window.pauseSession = pauseSession;
window.resetSession = resetSession;
window.loadSession = loadSession;
window.generateEssayFromBrainstorming = generateEssayFromBrainstorming;
window.playLastResponse = playLastResponse;

// Update the main goToBrainstormer function to actually work
function updateGoToBrainstormerFunction() {
    // Replace the existing alert with actual functionality
    const existingFunction = window.goToBrainstormer;
    window.goToBrainstormer = function() {
        showPage('brainstormingPage');
        setTimeout(() => {
            initializeBrainstorming();
        }, 100);
    };
}

// Initialize when the brainstorming page is loaded
document.addEventListener('DOMContentLoaded', function() {
    updateGoToBrainstormerFunction();
    console.log(' Brainstorming module loaded and ready');
});
    </script>
</body>
</html>     