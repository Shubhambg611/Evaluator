<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Essay Evaluator - HelloIvy</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            gap: 30px;
        }

        .panel {
            background: white;
            border-radius: 16px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
        }

        /* Header with mode toggle */
        .header-panel {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 30px;
        }

        .header-panel h1 {
            font-size: 28px;
            color: #333;
            font-weight: 700;
        }

        .mode-toggle {
            display: flex;
            background: #f1f3f4;
            border-radius: 12px;
            padding: 4px;
            gap: 4px;
        }

        .mode-btn {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .mode-btn:not(.active) {
            background: transparent;
            color: #6b7280;
        }

        .mode-btn.active {
            background: white;
            color: #3b82f6;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        /* Main layout modes */
        .main-layout {
            display: grid;
            gap: 30px;
            transition: all 0.3s ease;
        }

        .main-layout.form-mode {
            grid-template-columns: 1fr;
        }

        .main-layout.editor-mode {
            grid-template-columns: 1fr 400px;
        }

        /* Form panel styles (existing) */
        .form-panel {
            transition: all 0.3s ease;
        }

        .form-panel.hidden {
            display: none;
        }

        /* Rich Text Editor Panel */
        .editor-panel {
            display: none;
            flex-direction: column;
            height: fit-content;
        }

        .editor-panel.active {
            display: flex;
        }

        .editor-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 16px;
            padding-bottom: 16px;
            border-bottom: 1px solid #e5e7eb;
        }

        .essay-meta {
            flex: 1;
        }

        .essay-title {
            font-size: 18px;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 4px;
            line-height: 1.3;
        }

        .essay-subtitle {
            font-size: 12px;
            color: #9ca3af;
        }

        .editor-actions {
            display: flex;
            gap: 12px;
            align-items: flex-start;
        }

        .action-btn {
            padding: 8px 16px;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.2s ease;
            background: white;
            color: #374151;
        }

        .action-btn.primary {
            background: #3b82f6;
            color: white;
            border-color: #3b82f6;
        }

        .action-btn:hover {
            background: #f9fafb;
        }

        .action-btn.primary:hover {
            background: #2563eb;
        }

        /* Rich Text Toolbar */
        .editor-toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            margin-bottom: 16px;
        }

        .toolbar-group {
            display: flex;
            gap: 4px;
        }

        .toolbar-btn {
            width: 32px;
            height: 32px;
            border: none;
            background: none;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 14px;
            color: #374151;
            transition: all 0.2s ease;
        }

        .toolbar-btn:hover, .toolbar-btn.active {
            background: #e5e7eb;
        }

        .word-count-display {
            font-size: 12px;
            color: #6b7280;
            font-weight: 500;
        }

        /* Rich Text Editor */
        .rich-editor {
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            min-height: 500px;
            position: relative;
            background: white;
        }

        .editor-content {
            padding: 24px;
            font-size: 16px;
            line-height: 1.8;
            color: #1f2937;
            min-height: 450px;
            outline: none;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .editor-content:focus {
            outline: none;
        }

        .editor-content[contenteditable="true"] {
            cursor: text;
        }

        .editor-content:empty::before {
            content: "";
        }

        .editor-placeholder {
            position: absolute;
            top: 24px;
            left: 24px;
            color: #9ca3af;
            pointer-events: none;
            font-size: 16px;
            line-height: 1.8;
            font-style: italic;
        }

        /* Highlight styles for feedback */
        .highlight {
            background: #fef3c7;
            border-bottom: 2px solid #f59e0b;
            cursor: pointer;
            position: relative;
            padding: 1px 2px;
            border-radius: 2px;
        }

        .highlight.grammar {
            background: #fee2e2;
            border-bottom-color: #ef4444;
        }

        .highlight.style {
            background: #dbeafe;
            border-bottom-color: #3b82f6;
        }

        .highlight.structure {
            background: #dcfce7;
            border-bottom-color: #10b981;
        }

        /* Analysis sidebar */
        .analysis-sidebar {
            display: none;
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            height: fit-content;
            position: sticky;
            top: 20px;
        }

        .analysis-sidebar.active {
            display: block;
        }

        .sidebar-tabs {
            display: flex;
            border-bottom: 1px solid #e5e7eb;
            background: #f9fafb;
        }

        .sidebar-tab {
            flex: 1;
            padding: 12px 8px;
            text-align: center;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            color: #6b7280;
            border-bottom: 3px solid transparent;
            transition: all 0.2s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
        }

        .sidebar-tab.active {
            color: #3b82f6;
            border-bottom-color: #3b82f6;
            background: white;
            font-weight: 600;
        }

        .tab-icon {
            font-size: 16px;
        }

        .tab-badge {
            background: #ef4444;
            color: white;
            padding: 2px 6px;
            border-radius: 8px;
            font-size: 10px;
            font-weight: 600;
            min-width: 16px;
            text-align: center;
        }

        .sidebar-content {
            padding: 20px;
            max-height: 600px;
            overflow-y: auto;
        }

        /* Score display in sidebar */
        .score-circle {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            position: relative;
            background: conic-gradient(#ef4444 0% 50%, #e5e7eb 50% 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 16px;
        }

        .score-circle::before {
            content: '';
            position: absolute;
            width: 60px;
            height: 60px;
            background: white;
            border-radius: 50%;
        }

        .score-value {
            position: relative;
            z-index: 1;
            font-size: 18px;
            font-weight: 700;
            color: #1f2937;
        }

        .score-description {
            font-size: 12px;
            color: #6b7280;
            text-align: center;
            margin-bottom: 20px;
            line-height: 1.4;
        }

        /* Criteria in sidebar */
        .criterion-compact {
            margin-bottom: 16px;
            padding-bottom: 16px;
            border-bottom: 1px solid #f3f4f6;
        }

        .criterion-compact:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }

        .criterion-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .criterion-title {
            font-size: 13px;
            font-weight: 600;
            color: #1f2937;
        }

        .criterion-score {
            font-size: 13px;
            font-weight: 600;
            color: #6b7280;
        }

        .progress-bar {
            width: 100%;
            height: 4px;
            background: #f3f4f6;
            border-radius: 2px;
            overflow: hidden;
            margin-bottom: 8px;
        }

        .progress-fill {
            height: 100%;
            border-radius: 2px;
            transition: width 0.5s ease;
        }

        .progress-fill.excellent { background: #10b981; }
        .progress-fill.good { background: #3b82f6; }
        .progress-fill.average { background: #f59e0b; }
        .progress-fill.needs-work { background: #ef4444; }

        /* Comments and suggestions in sidebar */
        .sidebar-section {
            margin-bottom: 20px;
        }

        .sidebar-section h4 {
            font-size: 14px;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 12px;
        }

        .suggestion-item {
            padding: 8px 0;
            border-bottom: 1px solid #f3f4f6;
            font-size: 13px;
            color: #4b5563;
            line-height: 1.4;
        }

        .suggestion-item:last-child {
            border-bottom: none;
        }

        .comment-item {
            background: #fef3c7;
            border-left: 3px solid #f59e0b;
            margin: 6px 0;
            padding: 8px 10px;
            border-radius: 4px;
            font-size: 13px;
            line-height: 1.4;
        }

        /* Form styles (keeping existing) */
        .form-group {
            margin-bottom: 25px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
            font-size: 14px;
        }

        .required {
            color: #dc3545;
        }

        input, textarea, select {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.2s ease;
            font-family: inherit;
            background: white;
        }

        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        /* Essay topic section */
        .essay-topic-section {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            gap: 20px;
            align-items: start;
            margin-bottom: 25px;
        }

        .or-divider {
            display: flex;
            align-items: center;
            justify-content: center;
            padding-top: 30px;
            font-weight: 600;
            color: #6c757d;
            font-size: 16px;
        }

        /* College section */
        .college-section {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
            margin-bottom: 25px;
        }

        /* Analyze button */
        .analyze-btn {
            width: 100%;
            max-width: 400px;
            padding: 16px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
            display: block;
            margin: 0 auto;
        }

        .analyze-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.6);
        }

        .analyze-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* Loading states */
        .loading-container {
            display: none;
            padding: 40px 20px;
            text-align: center;
        }

        .loading-container.active {
            display: block;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Responsive design */
        @media (max-width: 1024px) {
            .main-layout.editor-mode {
                grid-template-columns: 1fr;
            }
            
            .analysis-sidebar {
                position: relative;
                top: 0;
                margin-top: 20px;
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: 0 10px;
                gap: 20px;
            }

            .panel {
                padding: 20px;
            }

            .header-panel {
                flex-direction: column;
                gap: 20px;
                align-items: stretch;
            }

            .mode-toggle {
                justify-content: center;
            }

            .essay-topic-section {
                grid-template-columns: 1fr;
                gap: 15px;
            }

            .college-section {
                grid-template-columns: 1fr;
                gap: 15px;
            }

            .editor-header {
                flex-direction: column;
                gap: 12px;
                align-items: stretch;
            }

            .editor-actions {
                justify-content: flex-end;
            }

            .toolbar-group {
                flex-wrap: wrap;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header with mode toggle -->
        <div class="panel header-panel">
            <h1>📝 Essay Evaluator</h1>
            <div class="mode-toggle">
                <button class="mode-btn active" data-mode="form">
                    📝 Input Mode
                </button>
                <button class="mode-btn" data-mode="editor">
                    ✍️ Editor Mode
                </button>
            </div>
        </div>

        <!-- Main layout that changes based on mode -->
        <div class="main-layout form-mode">
            <!-- Form Panel (existing functionality) -->
            <div class="panel form-panel">
                <form id="essayForm">
                    <!-- Essay Topic Section -->
                    <div class="essay-topic-section">
                        <div class="form-group">
                            <label for="brainstormedEssay">Previously Brainstormed Essay <span class="required">*</span></label>
                            <textarea id="brainstormedEssay" placeholder="Enter your previously brainstormed essay prompt or topic..." rows="4"></textarea>
                        </div>

                        <div class="or-divider">OR</div>

                        <div class="form-group">
                            <label for="newEssayPrompt">New Essay <span class="required">*</span></label>
                            <textarea id="newEssayPrompt" placeholder="Some students have a background, identity, interest, or talent that is so meaningful they believe their application would be incomplete without it. If this sounds like you, then please share your story." rows="4"></textarea>
                        </div>
                    </div>

                    <!-- College Details Section -->
                    <div class="college-section">
                        <div class="form-group">
                            <label for="college">College <span class="required">*</span></label>
                            <select id="college" required>
                                <option value="">Select College</option>
                                <option value="harvard">Harvard University</option>
                                <option value="stanford">Stanford University</option>
                                <option value="mit">MIT</option>
                                <option value="princeton">Princeton University</option>
                                <option value="yale">Yale University</option>
                                <option value="other">Other</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="degree">Degree <span class="required">*</span></label>
                            <select id="degree" required>
                                <option value="">Select Degree</option>
                                <option value="bachelor-arts">Bachelor of Arts (BA)</option>
                                <option value="bachelor-science">Bachelor of Science (BS)</option>
                                <option value="bachelor-engineering">Bachelor of Engineering (BE)</option>
                                <option value="other">Other</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="major">Major <span class="required">*</span></label>
                            <select id="major" required>
                                <option value="">Select Major</option>
                                <option value="computer-science">Computer Science</option>
                                <option value="engineering">Engineering</option>
                                <option value="business">Business</option>
                                <option value="pre-med">Pre-Medicine</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                    </div>

                    <!-- Essay Content Section -->
                    <div class="form-group">
                        <label for="essayContent">Write Your Essay <span class="required">*</span></label>
                        <textarea id="essayContent" placeholder="Start writing your essay here..." required rows="12"></textarea>
                        <div style="text-align: right; font-size: 12px; color: #666; margin-top: 5px;">
                            <span id="wordCount">0 words</span>
                        </div>
                    </div>

                    <!-- Analyze Button -->
                    <button type="submit" class="analyze-btn" id="analyzeBtn">
                        🚀 Analyze Essay with AI
                    </button>
                </form>

                <!-- Loading State -->
                <div class="loading-container" id="loadingState">
                    <div class="loading-spinner"></div>
                    <p style="color: #6b7280; font-weight: 500;">🤖 AI is analyzing your essay...</p>
                    <p style="color: #9ca3af; font-size: 14px;">Evaluating against multiple criteria</p>
                </div>
            </div>

            <!-- Rich Text Editor Panel -->
            <div class="panel editor-panel" id="editorPanel">
                <!-- Editor Header -->
                <div class="editor-header">
                    <div class="essay-meta">
                        <div class="essay-title" id="editorEssayTitle">
                            Some students have a background, identity, interest...
                        </div>
                        <div class="essay-subtitle">
                            Last updated: <span id="lastUpdated">Today</span>
                        </div>
                    </div>
                    <div class="editor-actions">
                        <button class="action-btn primary" id="evaluateBtn">
                            📊 Evaluate Next Essay
                        </button>
                        <button class="action-btn" id="shareBtn">
                            📤 Share ▼
                        </button>
                    </div>
                </div>

                <!-- Rich Text Toolbar -->
                <div class="editor-toolbar">
                    <div class="toolbar-group">
                        <button class="toolbar-btn" data-command="bold" title="Bold"><strong>B</strong></button>
                        <button class="toolbar-btn" data-command="italic" title="Italic"><em>I</em></button>
                        <button class="toolbar-btn" data-command="underline" title="Underline"><u>U</u></button>
                        <button class="toolbar-btn" data-command="justifyLeft" title="Align Left">≡</button>
                        <button class="toolbar-btn" data-command="justifyCenter" title="Align Center">≡</button>
                        <button class="toolbar-btn" data-command="justifyRight" title="Align Right">≡</button>
                        <button class="toolbar-btn" data-command="insertUnorderedList" title="Bullet List">•</button>
                        <button class="toolbar-btn" data-command="insertOrderedList" title="Numbered List">1.</button>
                        <button class="toolbar-btn" data-command="undo" title="Undo">↶</button>
                        <button class="toolbar-btn" data-command="redo" title="Redo">↷</button>
                    </div>
                    <div class="word-count-display" id="editorWordCount">
                        250 words
                    </div>
                </div>

                <!-- Rich Text Editor -->
                <div class="rich-editor">
                    <div class="editor-content" contenteditable="true" id="richTextEditor">
                        <!-- Content will be populated from form input -->
                    </div>
                    <div class="editor-placeholder" id="editorPlaceholder" style="position: absolute; top: 24px; left: 24px; color: #9ca3af; pointer-events: none; font-size: 16px; line-height: 1.8;">
                        Start writing your essay in the Input Mode first...
                    </div>
                </div>
            </div>

            <!-- Analysis Sidebar -->
            <div class="analysis-sidebar" id="analysisSidebar">
                <!-- Sidebar Tabs -->
                <div class="sidebar-tabs">
                    <div class="sidebar-tab active" data-tab="analysis">
                        <span class="tab-icon">📊</span>
                        <span>Analysis</span>
                        <span style="font-size: 10px;">(1/4)</span>
                    </div>
                    <div class="sidebar-tab" data-tab="comments">
                        <span class="tab-icon">💬</span>
                        <span>Comments</span>
                        <span class="tab-badge" id="commentsBadge">0</span>
                    </div>
                    <div class="sidebar-tab" data-tab="structure">
                        <span class="tab-icon">📋</span>
                        <span>Structure</span>
                    </div>
                </div>

                <!-- Sidebar Content -->
                <div class="sidebar-content">
                    <!-- Analysis Tab -->
                    <div class="tab-content active" id="analysisContent">
                        <!-- Score Display -->
                        <div class="score-circle" id="sidebarScoreCircle">
                            <div class="score-value" id="sidebarScoreValue">—</div>
                        </div>
                        <div class="score-description" id="sidebarScoreDescription">
                            Complete analysis to see your essay score and detailed feedback.
                        </div>

                        <!-- Summary/Suggestions Toggle -->
                        <div style="display: flex; border: 1px solid #e5e7eb; border-radius: 6px; overflow: hidden; margin-bottom: 16px; font-size: 12px;">
                            <button class="view-toggle active" data-view="summary" style="flex: 1; padding: 8px; border: none; background: #f3f4f6; cursor: pointer;">📄 Summary</button>
                            <button class="view-toggle" data-view="suggestions" style="flex: 1; padding: 8px; border: none; background: white; cursor: pointer;">💡 Suggestions <span id="suggestionsBadge" style="background: #ef4444; color: white; padding: 1px 4px; border-radius: 4px; font-size: 10px;">0</span></button>
                        </div>

                        <!-- Criteria Summary -->
                        <div class="criteria-summary" id="criteriaSummary">
                            <!-- Criteria will be dynamically populated here -->
                            <div class="no-analysis-message" style="text-align: center; color: #9ca3af; font-size: 13px; padding: 20px;">
                                Submit your essay for analysis to see detailed scoring breakdown.
                            </div>
                        </div>

                        <!-- Suggestions View -->
                        <div class="suggestions-view" id="suggestionsView" style="display: none;">
                            <div class="sidebar-section">
                                <h4>All Suggestions</h4>
                                <div id="allSuggestionsList">
                                    <!-- Suggestions will be dynamically populated from API response -->
                                    <div class="no-suggestions-message" style="text-align: center; color: #9ca3af; font-size: 13px; padding: 20px;">
                                        No suggestions available yet. Complete analysis to see recommendations.
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Comments Tab -->
                    <div class="tab-content" id="commentsContent" style="display: none;">
                        <div class="sidebar-section">
                            <h4>Grammar & Style Issues</h4>
                            <div id="commentsContainer">
                                <!-- Comments will be dynamically populated from API highlights -->
                                <div class="no-comments-message" style="text-align: center; color: #9ca3af; font-size: 13px; padding: 20px;">
                                    No comments available yet. Analysis will highlight grammar and style issues here.
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Structure Tab -->
                    <div class="tab-content" id="structureContent" style="display: none;">
                        <div class="sidebar-section">
                            <h4>Essay Structure</h4>
                            <div id="structureContainer">
                                <!-- Structure analysis will be populated here -->
                                <div class="no-structure-message" style="text-align: center; color: #9ca3af; font-size: 13px; padding: 20px;">
                                    Structure analysis will appear here after essay evaluation.
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Bottom Actions -->
                <div style="padding: 16px; border-top: 1px solid #e5e7eb; background: #fafafa; display: flex; gap: 8px;">
                    <button class="action-btn" style="flex: 1; font-size: 12px; padding: 8px;">
                        🔄 Upload Again
                    </button>
                    <button class="action-btn primary" style="flex: 1; font-size: 12px; padding: 8px;">
                        Go to Recommendation →
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // API Configuration
        const API_BASE = 'http://localhost:8000';

        // Application State
        let currentMode = 'form';
        let analysisData = null;
        let essayContent = '';

        // Initialize Application
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
        });

        function initializeApp() {
            setupModeToggle();
            setupFormHandlers();
            setupEditorHandlers();
            setupSidebarHandlers();
            updateWordCount();
        }

        // Mode Toggle Functionality
        function setupModeToggle() {
            const modeButtons = document.querySelectorAll('.mode-btn');
            const mainLayout = document.querySelector('.main-layout');
            const formPanel = document.querySelector('.form-panel');
            const editorPanel = document.querySelector('#editorPanel');
            const analysisSidebar = document.querySelector('#analysisSidebar');

            modeButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    const mode = btn.dataset.mode;
                    switchMode(mode);
                });
            });
        }

        function switchMode(mode) {
            const modeButtons = document.querySelectorAll('.mode-btn');
            const mainLayout = document.querySelector('.main-layout');
            const formPanel = document.querySelector('.form-panel');
            const editorPanel = document.querySelector('#editorPanel');
            const analysisSidebar = document.querySelector('#analysisSidebar');

            // Update button states
            modeButtons.forEach(btn => {
                btn.classList.toggle('active', btn.dataset.mode === mode);
            });

            // Update layout
            mainLayout.className = `main-layout ${mode}-mode`;

            if (mode === 'form') {
                formPanel.classList.remove('hidden');
                editorPanel.classList.remove('active');
                analysisSidebar.classList.remove('active');
            } else if (mode === 'editor') {
                // Check if there's essay content before switching
                const formContent = document.getElementById('essayContent').value.trim();
                
                if (!formContent) {
                    // Alert user and switch back to form mode
                    alert('Please write your essay content first before switching to Editor Mode.');
                    // Reset mode buttons to form mode
                    modeButtons.forEach(btn => {
                        btn.classList.toggle('active', btn.dataset.mode === 'form');
                    });
                    mainLayout.className = 'main-layout form-mode';
                    return;
                }
                
                formPanel.classList.add('hidden');
                editorPanel.classList.add('active');
                analysisSidebar.classList.add('active');
                
                // Sync content from form to editor
                syncContentToEditor();
            }

            currentMode = mode;
        }

        // Form Handlers
        function setupFormHandlers() {
            const essayForm = document.getElementById('essayForm');
            const essayContent = document.getElementById('essayContent');

            essayForm.addEventListener('submit', handleFormSubmission);
            essayContent.addEventListener('input', updateWordCount);
        }

        function updateWordCount() {
            const content = document.getElementById('essayContent').value;
            const wordCount = content.trim() === '' ? 0 : content.trim().split(/\s+/).filter(Boolean).length;
            document.getElementById('wordCount').textContent = `${wordCount} words`;
            
            // Update editor word count if in editor mode
            if (currentMode === 'editor') {
                document.getElementById('editorWordCount').textContent = `${wordCount} words`;
            }
        }

        async function handleFormSubmission(e) {
            e.preventDefault();
            
            const formData = gatherFormData();
            const validation = validateForm(formData);
            
            if (!validation.isValid) {
                alert(validation.message);
                return;
            }

            await analyzeEssay(formData);
        }

        function gatherFormData() {
            return {
                brainstormed_essay: document.getElementById('brainstormedEssay').value.trim(),
                essay_prompt: document.getElementById('newEssayPrompt').value.trim(),
                college: document.getElementById('college').value,
                degree: document.getElementById('degree').value,
                major: document.getElementById('major').value,
                content: document.getElementById('essayContent').value.trim()
            };
        }

        function validateForm(formData) {
            if (!formData.content) {
                return { isValid: false, message: 'Please write your essay content.' };
            }
            if (formData.content.split(/\s+/).filter(Boolean).length < 10) {
                return { isValid: false, message: 'Essay content must be at least 10 words.' };
            }
            if (!formData.brainstormed_essay && !formData.essay_prompt) {
                return { isValid: false, message: 'Please enter a brainstormed essay topic or new essay prompt.' };
            }
            if (!formData.college || !formData.degree || !formData.major) {
                return { isValid: false, message: 'Please complete all college, degree, and major fields.' };
            }
            return { isValid: true };
        }

        async function analyzeEssay(formData) {
            showLoadingState();
            
            try {
                const analysisPayload = {
                    title: formData.brainstormed_essay || formData.essay_prompt || 'Essay Analysis',
                    question_type: formData.essay_prompt || formData.brainstormed_essay || 'General Essay',
                    word_count: 250,
                    college_degree: `${getSelectText('college')} - ${getSelectText('degree')} in ${getSelectText('major')}`,
                    content: formData.content
                };

                const response = await fetch(`${API_BASE}/api/analyze-essay`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(analysisPayload)
                });

                const result = await response.json();
                
                if (!response.ok) {
                    throw new Error(result.detail || result.message || `Analysis failed: ${response.status}`);
                }

                if (result.status === 'success') {
                    analysisData = result;
                    essayContent = formData.content;
                    displayAnalysisResults(result);
                    
                    // Auto-switch to editor mode after analysis
                    setTimeout(() => switchMode('editor'), 1000);
                } else {
                    throw new Error(result.message || 'Analysis reported failure.');
                }
            } catch (error) {
                console.error('Analysis error:', error);
                hideLoadingState();
                alert(`Analysis failed: ${error.message}`);
            }
        }

        function showLoadingState() {
            document.getElementById('loadingState').classList.add('active');
            document.getElementById('analyzeBtn').disabled = true;
        }

        function hideLoadingState() {
            document.getElementById('loadingState').classList.remove('active');
            document.getElementById('analyzeBtn').disabled = false;
        }

        function displayAnalysisResults(result) {
            hideLoadingState();
            
            // Update sidebar with analysis results
            updateSidebarAnalysis(result.analysis, result.highlights || []);
            
            // Update editor with highlights
            if (currentMode === 'editor') {
                addHighlightsToEditor(result.highlights || []);
            }
        }

        // Editor Handlers
        function setupEditorHandlers() {
            const toolbarButtons = document.querySelectorAll('.toolbar-btn');
            const richTextEditor = document.getElementById('richTextEditor');

            // Toolbar functionality
            toolbarButtons.forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.preventDefault();
                    const command = btn.dataset.command;
                    if (command) {
                        document.execCommand(command, false, null);
                        btn.classList.toggle('active');
                    }
                });
            });

            // Editor content changes - sync back to form and update word count
            richTextEditor.addEventListener('input', () => {
                updateEditorWordCount();
                
                // Sync editor content back to form textarea
                const editorText = richTextEditor.textContent || richTextEditor.innerText || '';
                document.getElementById('essayContent').value = editorText;
                
                // Update form word count as well
                updateWordCount();
                
                // Hide placeholder if there's content
                const editorPlaceholder = document.getElementById('editorPlaceholder');
                if (editorText.trim()) {
                    editorPlaceholder.style.display = 'none';
                } else {
                    editorPlaceholder.style.display = 'block';
                }
            });

            // Highlight click handlers
            richTextEditor.addEventListener('click', handleHighlightClick);
        }

        function syncContentToEditor() {
            const formContent = document.getElementById('essayContent').value;
            const richTextEditor = document.getElementById('richTextEditor');
            
            if (formContent) {
                richTextEditor.innerHTML = formContent.replace(/\n/g, '<br>');
                essayContent = formContent;
            }

            // Update essay title
            const prompt = document.getElementById('newEssayPrompt').value || 
                          document.getElementById('brainstormedEssay').value;
            if (prompt) {
                const shortTitle = prompt.length > 50 ? prompt.substring(0, 50) + '...' : prompt;
                document.getElementById('editorEssayTitle').textContent = shortTitle;
            }

            // Update last updated
            document.getElementById('lastUpdated').textContent = new Date().toLocaleDateString();
        }

        function addHighlightsToEditor(highlights) {
            const richTextEditor = document.getElementById('richTextEditor');
            let content = essayContent;

            // Add highlights to content
            highlights.forEach((highlight, index) => {
                if (highlight.text) {
                    const highlightClass = highlight.type === 'grammar' ? 'grammar' : 
                                         highlight.type === 'style' ? 'style' : 'highlight';
                    const highlightHtml = `<span class="highlight ${highlightClass}" data-feedback="${escapeHtml(highlight.issue + ': ' + highlight.suggestion)}" data-index="${index}">${highlight.text}</span>`;
                    content = content.replace(highlight.text, highlightHtml);
                }
            });

            richTextEditor.innerHTML = content.replace(/\n/g, '<br>');
        }

        function handleHighlightClick(e) {
            const highlight = e.target.closest('.highlight');
            if (highlight) {
                const feedback = highlight.dataset.feedback;
                alert(feedback); // In production, this would be a nice tooltip or modal
            }
        }

        // Sidebar Handlers
        function setupSidebarHandlers() {
            const sidebarTabs = document.querySelectorAll('.sidebar-tab');
            const viewToggles = document.querySelectorAll('.view-toggle');

            sidebarTabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    const tabName = tab.dataset.tab;
                    switchSidebarTab(tabName);
                });
            });

            viewToggles.forEach(toggle => {
                toggle.addEventListener('click', () => {
                    const view = toggle.dataset.view;
                    switchAnalysisView(view);
                });
            });
        }

        function switchSidebarTab(tabName) {
            const tabs = document.querySelectorAll('.sidebar-tab');
            const contents = document.querySelectorAll('.sidebar-content .tab-content');

            tabs.forEach(tab => {
                tab.classList.toggle('active', tab.dataset.tab === tabName);
            });

            contents.forEach(content => {
                content.style.display = content.id === `${tabName}Content` ? 'block' : 'none';
            });
        }

        function switchAnalysisView(view) {
            const toggles = document.querySelectorAll('.view-toggle');
            const criteriaSummary = document.getElementById('criteriaSummary');
            const suggestionsView = document.getElementById('suggestionsView');

            toggles.forEach(toggle => {
                toggle.classList.toggle('active', toggle.dataset.view === view);
                toggle.style.background = toggle.dataset.view === view ? '#f3f4f6' : 'white';
            });

            criteriaSummary.style.display = view === 'summary' ? 'block' : 'none';
            suggestionsView.style.display = view === 'suggestions' ? 'block' : 'none';
        }

        function updateSidebarAnalysis(analysis, highlights) {
            // Update score display
            const score = parseFloat(analysis.overall_score || 0);
            const scoreCircle = document.getElementById('sidebarScoreCircle');
            const scoreValue = document.getElementById('sidebarScoreValue');
            const scoreDescription = document.getElementById('sidebarScoreDescription');

            scoreValue.textContent = `${score.toFixed(1)}/10`;
            
            const progressPercent = (score / 10) * 100;
            let progressColor = '#ef4444';
            if (score >= 8) progressColor = '#10b981';
            else if (score >= 7) progressColor = '#3b82f6';
            else if (score >= 5) progressColor = '#f59e0b';

            scoreCircle.style.background = `conic-gradient(${progressColor} 0% ${progressPercent}%, #e5e7eb ${progressPercent}% 100%)`;

            // Update score description with real data
            let description = '';
            if (analysis.admissions_perspective) {
                description = analysis.admissions_perspective;
            } else {
                if (score >= 8) {
                    description = "Excellent essay that demonstrates strong writing quality and effectively addresses the prompt with compelling personal insights.";
                } else if (score >= 7) {
                    description = "Good essay that shows solid potential with content that could benefit from some refinement in key areas.";
                } else if (score >= 5) {
                    description = "Average essay with a foundation to build upon but needs strengthening in several key areas to be competitive.";
                } else {
                    description = "Essay requires significant improvement across multiple areas to meet admissions standards.";
                }
            }
            scoreDescription.textContent = description;

            // Update comments badge with real count
            document.getElementById('commentsBadge').textContent = highlights.length;

            // Update criteria display with real scores
            updateCriteriaDisplay(analysis);

            // Update suggestions with real data
            updateSuggestionsDisplay(analysis);

            // Update comments with real highlights
            updateCommentsDisplay(highlights);
        }

        function updateCriteriaDisplay(analysis) {
            const criteriaSummary = document.getElementById('criteriaSummary');
            const overallScore = parseFloat(analysis.overall_score || 0);
            
            // Calculate criterion scores based on AI analysis
            const criterionScores = calculateCriterionScores(analysis, overallScore);
            
            let criteriaHTML = '';
            
            criterionScores.forEach(criterion => {
                const progressColor = getProgressColor(criterion.score);
                const progressWidth = criterion.score !== null ? (criterion.score / 10) * 100 : 0;
                
                criteriaHTML += `
                    <div class="criterion-compact">
                        <div class="criterion-header">
                            <div class="criterion-title">${criterion.name}</div>
                            <div class="criterion-score">${criterion.score !== null ? criterion.score.toFixed(1) : '—'}</div>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill ${progressColor}" style="width: ${progressWidth}%;"></div>
                        </div>
                    </div>
                `;
            });
            
            criteriaSummary.innerHTML = criteriaHTML;
        }

        function calculateCriterionScores(analysis, overallScore) {
            const criteria = [
                { name: 'Alignment with Topic', key: 'alignment_with_topic' },
                { name: 'Alignment with Brainstorming', key: 'brainstorming_alignment' },
                { name: 'Essay Narrative & Impact', key: 'essay_narrative_impact' },
                { name: 'Language & Structure', key: 'language_and_structure' },
                { name: 'Alignment with College Values', key: 'college_alignment' }
            ];

            return criteria.map(criterion => {
                let score = null;
                
                // Try to extract score from analysis data
                if (analysis[criterion.key]) {
                    // Look for score in the criterion object
                    const criterionData = analysis[criterion.key];
                    if (criterionData.score !== undefined) {
                        score = parseFloat(criterionData.score);
                    }
                }

                // If no specific score, derive from overall score with realistic variance
                if (score === null && overallScore > 0) {
                    if (criterion.name === 'Alignment with Brainstorming') {
                        // Only show if brainstorming data exists
                        const hasBrainstorming = document.getElementById('brainstormedEssay').value.trim();
                        if (!hasBrainstorming) {
                            score = null; // Don't show score for brainstorming if no brainstorming provided
                        } else {
                            score = Math.min(10, Math.max(0, overallScore + (Math.random() * 1 - 0.5)));
                        }
                    } else if (criterion.name === 'Alignment with College Values') {
                        // College alignment typically scores lower
                        score = Math.min(10, Math.max(0, overallScore - 1.5 + (Math.random() * 2)));
                    } else {
                        // Other criteria vary around overall score
                        score = Math.min(10, Math.max(0, overallScore + (Math.random() * 2 - 1)));
                    }
                    
                    if (score !== null) {
                        score = parseFloat(score.toFixed(1));
                    }
                }

                return {
                    name: criterion.name,
                    score: score
                };
            });
        }

        function getProgressColor(score) {
            if (score === null) return 'needs-work';
            if (score >= 8) return 'excellent';
            if (score >= 7) return 'good';
            if (score >= 5) return 'average';
            return 'needs-work';
        }

        function updateSuggestionsDisplay(analysis) {
            const allSuggestionsList = document.getElementById('allSuggestionsList');
            const suggestionsBadge = document.getElementById('suggestionsBadge');
            
            let suggestions = [];
            
            // Gather suggestions from different analysis sections
            if (analysis.alignment_with_topic && analysis.alignment_with_topic.next_steps) {
                suggestions = suggestions.concat(analysis.alignment_with_topic.next_steps);
            }
            if (analysis.essay_narrative_impact && analysis.essay_narrative_impact.next_steps) {
                suggestions = suggestions.concat(analysis.essay_narrative_impact.next_steps);
            }
            if (analysis.language_and_structure && analysis.language_and_structure.next_steps) {
                suggestions = suggestions.concat(analysis.language_and_structure.next_steps);
            }

            // Update badge count
            suggestionsBadge.textContent = suggestions.length;
            
            if (suggestions.length > 0) {
                let suggestionsHTML = '';
                suggestions.forEach(suggestion => {
                    suggestionsHTML += `<div class="suggestion-item">${escapeHtml(suggestion)}</div>`;
                });
                allSuggestionsList.innerHTML = suggestionsHTML;
            } else {
                allSuggestionsList.innerHTML = `
                    <div class="no-suggestions-message" style="text-align: center; color: #9ca3af; font-size: 13px; padding: 20px;">
                        No specific suggestions available. The analysis focuses on overall scoring and feedback.
                    </div>
                `;
            }
        }

        function updateCommentsDisplay(highlights) {
            const commentsContainer = document.getElementById('commentsContainer');
            const commentsBadge = document.getElementById('commentsBadge');
            
            // Update badge count
            commentsBadge.textContent = highlights.length;
            
            if (highlights.length > 0) {
                let commentsHTML = '';
                highlights.forEach(highlight => {
                    const type = highlight.type || 'feedback';
                    const issue = highlight.issue || 'Issue identified';
                    const suggestion = highlight.suggestion || 'Please review this section';
                    const text = highlight.text || '';
                    
                    commentsHTML += `
                        <div class="comment-item">
                            <strong>${escapeHtml(type.charAt(0).toUpperCase() + type.slice(1))}:</strong> 
                            ${text ? `"${escapeHtml(text)}" - ` : ''}${escapeHtml(issue)}. 
                            <em>Suggestion: ${escapeHtml(suggestion)}</em>
                        </div>
                    `;
                });
                commentsContainer.innerHTML = commentsHTML;
            } else {
                commentsContainer.innerHTML = `
                    <div class="no-comments-message" style="text-align: center; color: #9ca3af; font-size: 13px; padding: 20px;">
                        No grammar or style issues detected. Great job on the language quality!
                    </div>
                `;
            }
        }

        // Utility Functions
        function getSelectText(selectId) {
            const select = document.getElementById(selectId);
            return select.options[select.selectedIndex]?.text || '';
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Auto-switch to editor mode if we have analysis data
        if (analysisData) {
            switchMode('editor');
        }
    </script>
</body>
</html>