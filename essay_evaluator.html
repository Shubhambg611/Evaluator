<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Essay Evaluator - HelloIvy</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* --- NEW LANDING PAGE & MODAL STYLES --- */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #f7f9fc;
            min-height: 100vh;
        }

        #landingPage {
            display: flex;
            min-height: 100vh;
        }

        .landing-sidebar {
            width: 250px;
            background-color: #fff;
            padding: 20px;
            display: flex;
            flex-direction: column;
            border-right: 1px solid #e5e7eb;
        }

        .landing-logo {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 22px;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 50px;
        }
        .landing-logo span {
            display: inline-block;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 4px 8px;
            border-radius: 6px;
        }

        .landing-nav a {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            text-decoration: none;
            color: #4b5563;
            font-weight: 500;
            border-radius: 8px;
            margin-bottom: 8px;
            gap: 12px;
            transition: background-color 0.2s ease;
        }
        .landing-nav a:hover {
            background-color: #f3f4f6;
        }
        .landing-nav a.active {
            background-color: #eef2ff;
            color: #4f46e5;
            font-weight: 600;
        }
        .nav-icon {
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }


        .landing-main-wrapper {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: linear-gradient(180deg, #f7f9fc 0%, #eef2ff 100%);
        }

        .landing-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 40px;
        }
        .landing-title {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 18px;
            font-weight: 600;
            color: #1f2937;
        }
        .landing-title .close-icon {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 24px;
            height: 24px;
            background: #e5e7eb;
            color: #4b5563;
            border-radius: 50%;
            cursor: pointer;
            font-weight: bold;
        }
        .landing-user-profile {
            display: flex;
            align-items: center;
            gap: 16px;
        }
        .profile-icon { font-size: 24px; color: #6b7280; cursor: pointer; position: relative; }
        .profile-icon .notification-dot {
            position: absolute; top: 0; right: 0; width: 8px; height: 8px;
            background-color: #ef4444; border-radius: 50%; border: 2px solid #f7f9fc;
        }
        .profile-avatar { width: 36px; height: 36px; border-radius: 50%; background-color: #f9a8d4; cursor: pointer; border: 2px solid white; }

        .landing-content {
            flex: 1;
            padding: 20px 40px;
        }
        .intro-section {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 40px;
        }
        .intro-text h2 {
            font-size: 36px;
            font-weight: 800;
            color: #1f2937;
            margin-top: 8px;
            line-height: 1.2;
        }
        .intro-text .evaluator-badge {
            font-size: 16px;
            font-weight: 700;
            background: linear-gradient(90deg, #a855f7, #3b82f6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-fill-color: transparent;
        }
        .intro-image-placeholder {
            width: 300px;
            height: 200px;
            background: #e0e7ff;
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #6b7280;
            text-align: center;
            font-style: italic;
            border: 1px dashed #c7d2fe;
        }

        .instructions-box {
            background-color: #fff;
            padding: 30px;
            border-radius: 16px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            max-width: 900px;
            margin: 0 auto;
        }
        .instructions-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .instructions-header h3 {
            font-size: 18px;
            font-weight: 600;
            color: #1f2937;
        }
        .listen-btn {
            padding: 8px 16px;
            border: 1px solid #fed7aa;
            background: #fff7ed;
            color: #f97316;
            font-weight: 500;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .instructions-list {
            list-style-position: inside;
            padding-left: 0;
            margin-bottom: 30px;
        }
        .instructions-list li {
            color: #4b5563;
            line-height: 1.6;
            margin-bottom: 12px;
        }
        .instructions-list li::marker {
            font-weight: 600;
            color: #374151;
        }
        .read-checkbox {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
        }
        .read-checkbox input {
            width: 18px;
            height: 18px;
            accent-color: #4f46e5;
        }
        .read-checkbox label {
            font-weight: 500;
            color: #374151;
        }

        .get-started-btn {
            width: 100%;
            max-width: 200px;
            padding: 12px;
            border: none;
            border-radius: 8px;
            color: white;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            background: linear-gradient(90deg, #2dd4bf, #3b82f6);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.3s ease;
        }
        .get-started-btn:disabled {
            background: #d1d5db;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        .get-started-btn:not(:disabled):hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.4);
        }
        
        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(10, 20, 40, 0.4);
            backdrop-filter: blur(5px);
            display: none; /* Hidden by default */
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        .modal-content {
            background: linear-gradient(160deg, #ffffff 50%, #f0f5ff 100%);
            padding: 40px;
            border-radius: 20px;
            text-align: center;
            max-width: 450px;
            width: 90%;
            position: relative;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }
        .modal-close {
            position: absolute;
            top: 15px;
            right: 15px;
            background: #e5e7eb;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            font-size: 20px;
            line-height: 28px;
            color: #6b7280;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .modal-close:hover { background: #d1d5db; }
        
        .modal-icon-container {
            width: 72px;
            height: 72px;
            background-color: #eef2ff;
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 24px;
            border: 1px solid #c7d2fe;
        }
        .modal-icon-container svg { color: #4f46e5; }

        .modal-content h2 {
            font-size: 24px;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 12px;
        }
        .modal-content p {
            font-size: 16px;
            color: #6b7280;
            line-height: 1.6;
            margin-bottom: 32px;
        }
        .modal-primary-btn {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 12px;
            color: white;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            background: linear-gradient(90deg, #3b82f6, #2dd4bf);
            transition: all 0.3s ease;
            margin-bottom: 16px;
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
        }
        .modal-primary-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(59, 130, 246, 0.4);
        }
        /* Style for secondary-style button in second modal */
        .modal-primary-btn.secondary {
            background: #fff;
            color: #4f46e5;
            border: 1px solid #c7d2fe;
            box-shadow: none;
        }
         .modal-primary-btn.secondary:hover {
            background: #f7f9fc;
            box-shadow: none;
            transform: none;
        }

        .modal-secondary-link {
            background: none;
            border: none;
            color: #4f46e5;
            font-weight: 600;
            cursor: pointer;
            font-size: 15px;
        }
        /* --- END LANDING PAGE & MODAL STYLES --- */


        /* --- EXISTING STYLES (slight modifications) --- */
        #evaluatorApp {
            display: none; /* Initially hidden */
        }
        
        #evaluatorApp.active {
            display: block; /* Show when active */
        }
        
        #landingPage.hidden {
            display: none;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            gap: 30px;
        }

        .panel {
            background: white;
            border-radius: 16px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
        }

        .header-panel {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 30px;
        }

        .header-panel h1 {
            font-size: 28px;
            color: #333;
            font-weight: 700;
            margin-bottom: 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }
         .header-panel h1 .header-icon {
            font-size: 24px;
        }


        .mode-toggle {
            display: flex;
            background: #f1f3f4;
            border-radius: 12px;
            padding: 4px;
            gap: 4px;
        }

        .mode-btn {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .mode-btn:not(.active) {
            background: transparent;
            color: #6b7280;
        }

        .mode-btn.active {
            background: white;
            color: #3b82f6;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .main-layout {
            display: grid;
            gap: 30px;
            transition: all 0.3s ease;
        }

        .main-layout.form-mode {
            grid-template-columns: 1fr;
        }

        .main-layout.editor-mode {
            grid-template-columns: 1fr 400px;
        }

        .form-panel {
            transition: all 0.3s ease;
        }
        .form-panel.hidden {
            display: none;
        }
        .form-panel h1.form-title {
            text-align: center;
            font-size: 24px;
            margin-bottom: 30px;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
        }
        .form-panel h1.form-title .header-icon {
             font-size: 22px;
        }

        .editor-panel {
            display: none;
            flex-direction: column;
            height: fit-content;
        }
        .editor-panel.active {
            display: flex;
        }

        .editor-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 16px;
            padding-bottom: 16px;
            border-bottom: 1px solid #e5e7eb;
        }
        .essay-meta { flex: 1; }
        .essay-title { font-size: 18px; font-weight: 600; color: #1f2937; margin-bottom: 4px; line-height: 1.3; }
        .essay-subtitle { font-size: 12px; color: #9ca3af; }
        .editor-actions { display: flex; gap: 12px; align-items: flex-start; }
        
        .action-btn {
            padding: 8px 16px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 14px; font-weight: 500; cursor: pointer; display: flex; align-items: center; gap: 6px; transition: all 0.2s ease; background: white; color: #374151;
        }
        .action-btn.primary { background: #3b82f6; color: white; border-color: #3b82f6; }
        .action-btn:hover { background: #f9fafb; }
        .action-btn.primary:hover { background: #2563eb; }

        .editor-toolbar { 
            display: flex; 
            justify-content: space-between;
            align-items: center; 
            padding: 8px 12px;
            background: #f9fafb; 
            border: 1px solid #e5e7eb; 
            border-radius: 8px; 
            margin-bottom: 16px; 
        }
        .toolbar-left-groups {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .toolbar-group { 
            display: flex; 
            align-items: center;
            gap: 2px;
        }
        .toolbar-btn { 
            width: 30px;
            height: 30px;
            border: none; 
            background: none; 
            border-radius: 4px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            cursor: pointer; 
            font-size: 14px;
            color: #374151; 
            transition: all 0.2s ease; 
            line-height: 1;
        }
        .toolbar-btn:hover, .toolbar-btn.active { background: #e5e7eb; }
        .toolbar-btn strong, .toolbar-btn em, .toolbar-btn u { font-size: inherit; }
        
        .toolbar-divider {
            width: 1px;
            height: 18px;
            background-color: #d1d5db;
            margin: 0 6px;
        }
        .editor-toolbar .word-count-display {
             font-size: 12px; color: #6b7280; font-weight: 500; 
             padding: 0 4px;
             white-space: nowrap;
        }

        .rich-editor { border: 1px solid #e5e7eb; border-radius: 8px; min-height: 500px; position: relative; background: white; }
        .editor-content { padding: 24px; font-size: 16px; line-height: 1.8; color: #1f2937; min-height: 450px; outline: none; white-space: pre-wrap; word-wrap: break-word; }
        .editor-content:focus { outline: none; }
        .editor-content[contenteditable="true"] { cursor: text; }
        .editor-placeholder { position: absolute; top: 24px; left: 24px; color: #9ca3af; pointer-events: none; font-size: 16px; line-height: 1.8; font-style: italic; }
        .editor-content:not(:empty) + .editor-placeholder,
        .editor-content:focus + .editor-placeholder { display: none; }

        /* Highlight styles for feedback */
        .highlight { 
            background: #fef3c7; 
            border-bottom: 2px solid #f59e0b; 
            cursor: pointer; 
            position: relative; 
            padding: 0px 1px;
            border-radius: 2px; 
            margin: 0 -1px;
        }
        .highlight.grammar { background: #fee2e2; border-bottom-color: #ef4444; }
        .highlight.style { background: #dbeafe; border-bottom-color: #3b82f6; }
        
        .highlight.spelling {
            text-decoration: underline wavy #FFA500;
            text-decoration-skip-ink: none;
            background-color: transparent !important;
            border-bottom: none !important;
        }
        .highlight.replace_candidate {
            border-bottom: 2px solid #0000CD;
            background-color: rgba(0, 0, 205, 0.05);
        }
        .highlight.remove_candidate {
            text-decoration: line-through;
            color: #581c87; 
            background-color: #f3e8ff; 
            border-bottom: none !important;
            padding: 1px 0;
        }
        .highlight.add_candidate {
            border-bottom: 2px solid #add8e6;
            background-color: rgba(173, 216, 230, 0.1);
        }
        .highlight.add_candidate::after {
            content: "‚äï"; 
            color: #3b82f6; 
            font-weight: bold;
            font-size: 0.7em;
            vertical-align: super;
            margin-left: 2px;
            cursor: help;
        }

        .analysis-sidebar { display: none; background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 1px 3px rgba(0,0,0,0.1); height: fit-content; position: sticky; top: 20px; }
        .analysis-sidebar.active { display: block; }
        .sidebar-tabs { display: flex; border-bottom: 1px solid #e5e7eb; background: #f9fafb; }
        .sidebar-tab { flex: 1; padding: 12px 8px; text-align: center; cursor: pointer; font-size: 12px; font-weight: 500; color: #6b7280; border-bottom: 3px solid transparent; transition: all 0.2s ease; display: flex; flex-direction: column; align-items: center; gap: 4px; }
        .sidebar-tab.active { color: #3b82f6; border-bottom-color: #3b82f6; background: white; font-weight: 600; }
        .sidebar-tab .tab-icon { font-size: 16px; }
        .tab-badge { background: #ef4444; color: white; padding: 2px 6px; border-radius: 8px; font-size: 10px; font-weight: 600; min-width: 16px; text-align: center; }
        .sidebar-content { padding: 20px; max-height: 600px; overflow-y: auto; }
        .sidebar-content .tab-content { display: none; }
        .sidebar-content .tab-content.active { display: block; }

        .score-circle { width: 80px; height: 80px; border-radius: 50%; position: relative; background: conic-gradient(#ef4444 0% 50%, #e5e7eb 50% 100%); display: flex; align-items: center; justify-content: center; margin: 0 auto 16px; }
        .score-circle::before { content: ''; position: absolute; width: 60px; height: 60px; background: white; border-radius: 50%; }
        .score-value { position: relative; z-index: 1; font-size: 18px; font-weight: 700; color: #1f2937; }
        .score-description { font-size: 12px; color: #6b7280; text-align: center; margin-bottom: 20px; line-height: 1.4; }

        .criterion-compact { margin-bottom: 16px; padding-bottom: 16px; border-bottom: 1px solid #f3f4f6; }
        .criterion-compact:last-child { border-bottom: none; margin-bottom: 0; padding-bottom: 0; }
        .criterion-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .criterion-title { font-size: 13px; font-weight: 600; color: #1f2937; }
        .criterion-compact .criterion-score { font-size: 13px; font-weight: 600; color: #6b7280; }
        .progress-bar { width: 100%; height: 4px; background: #f3f4f6; border-radius: 2px; overflow: hidden; margin-bottom: 8px; }
        .progress-fill { height: 100%; border-radius: 2px; transition: width 0.5s ease; }
        .progress-fill.excellent { background: #10b981; }
        .progress-fill.good { background: #3b82f6; }
        .progress-fill.average { background: #f59e0b; }
        .progress-fill.needs-work { background: #ef4444; }
        
        .view-toggle-container { display: flex; border: 1px solid #e5e7eb; border-radius: 6px; overflow: hidden; margin-bottom: 16px; font-size: 12px;}
        .view-toggle { flex: 1; padding: 8px; border: none; background: white; cursor: pointer; font-weight: 500; color: #6b7280;}
        .view-toggle.active { background: #f3f4f6; color: #3b82f6;}

        .sidebar-section { margin-bottom: 20px; }
        .sidebar-section h4 { font-size: 14px; font-weight: 600; color: #1f2937; margin-bottom: 12px; }
        .suggestion-item { padding: 8px 0; border-bottom: 1px solid #f3f4f6; font-size: 13px; color: #4b5563; line-height: 1.4; }
        .suggestion-item:last-child { border-bottom: none; }
        
        .no-analysis-message, .no-suggestions-message, .no-comments-message, .no-structure-message {
            text-align: center; color: #9ca3af; font-size: 13px; padding: 20px;
        }

        .suggestion-detail-type { font-weight: 600; margin-right: 5px; color: #1f2937;}
        .suggestion-original-text { font-style: italic; color: #6b7280; background-color: #f9fafb; padding: 1px 3px; border-radius: 3px; border: 1px solid #e5e7eb;}
        .suggestion-text-arrow { color: #6b7280; margin: 0 4px;}
        .suggestion-suggested-text { font-weight: 500; color: #166534; background-color: #f0fdf4; padding: 1px 3px; border-radius: 3px; border: 1px solid #bbf7d0;}
        .suggestion-remove-text { text-decoration: line-through; color: #7f1d1d; background-color: #fef2f2; padding: 1px 3px; border-radius: 3px; border: 1px solid #fecaca;}
        .suggestion-issue-text { font-size: 0.9em; color: #4b5563; display: block; margin-top: 3px; padding-left: 10px;}

        /* Form styles */
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 6px; font-weight: 600; color: #333; font-size: 14px; }
        .required { color: #dc3545; margin-left: 2px; }
        input, textarea, select { width: 100%; padding: 10px 14px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 14px; transition: all 0.2s ease; font-family: inherit; background: white; }
        input:focus, textarea:focus, select:focus { outline: none; border-color: #667eea; box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1); }
        select { cursor: pointer; background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e"); background-position: right 12px center; background-repeat: no-repeat; background-size: 16px; padding-right: 40px; appearance: none; }
        textarea { resize: vertical; min-height: 100px; line-height: 1.6; }

        .essay-topic-section { display: grid; grid-template-columns: 1fr auto 1fr; gap: 20px; align-items: start; margin-bottom: 25px; }
        .or-divider { display: flex; align-items: center; justify-content: center; padding-top: 30px; font-weight: 600; color: #6c757d; font-size: 16px; }
        .essay-note { font-size: 12px; color: #6b7280; margin-top: 8px; font-style: italic; }
        .input-icons { display: flex; gap: 8px; margin-top: 8px; justify-content: flex-end; }
        .input-icon { width: 24px; height: 24px; border-radius: 4px; background: #e9ecef; display: flex; align-items: center; justify-content: center; font-size: 12px; color: #495057; cursor: pointer; }
        .input-icon:hover { background: #dee2e6; }

        .essay-limit-section { margin-bottom: 25px; }
        .section-title { font-size: 16px; font-weight: 600; color: #495057; margin-bottom: 12px; }
        .limit-options { display: flex; gap: 15px; flex-wrap: wrap; margin-bottom: 12px; }
        .limit-option { display: flex; align-items: center; gap: 6px; }
        .limit-option input[type="radio"] { width: auto; margin: 0; }
        .limit-option label { margin: 0; font-size: 14px; color: #333; cursor: pointer; font-weight: 500; }
        .limit-input { max-width: 150px; }

        .college-section { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 25px; }
        .deadline-section { max-width: 250px; margin-bottom: 25px; }
        .deadline-warning { background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 6px; padding: 10px 12px; margin-top: 8px; font-size: 12px; color: #856404; }
        .deadline-urgent { background: #f8d7da; border-color: #f5c6cb; color: #721c24; }

        .form-panel .word-count-display {
            text-align: right; font-size: 12px; color: #666; margin-top: 8px; display: flex; justify-content: space-between; align-items: center;
        }
        .word-count-status { font-weight: 600; }
        .word-count-over { color: #dc3545; }
        .word-count-good { color: #28a745; }
        .word-count-under { color: #ffc107; }

        .analyze-btn { width: 100%; max-width: 300px; padding: 14px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 10px; font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4); display: block; margin: 30px auto 0; }
        .analyze-btn:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(102, 126, 234, 0.6); }
        .analyze-btn:disabled { background: #ccc; cursor: not-allowed; transform: none; box-shadow: none; }

        .loading-container { display: none; padding: 40px 20px; text-align: center; }
        .loading-container.active { display: block; }
        .loading-spinner { width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid #3b82f6; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 20px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        @media (max-width: 1024px) {
            .main-layout.editor-mode { grid-template-columns: 1fr; }
            .analysis-sidebar { position: relative; top: 0; margin-top: 20px; }
            #landingPage { flex-direction: column; }
            .landing-sidebar { width: 100%; border-right: none; border-bottom: 1px solid #e5e7eb; flex-direction: row; justify-content: space-between; align-items: center; padding: 10px 20px; }
            .landing-logo { margin-bottom: 0; }
            .landing-nav { display: flex; gap: 10px; }
            .landing-nav a { margin-bottom: 0; }
        }
        @media (max-width: 768px) {
            #evaluatorApp { padding: 0; }
            .container { padding: 0 10px; gap: 20px; }
            .panel { padding: 20px; }
            .header-panel { flex-direction: column; gap: 20px; align-items: stretch; }
            .mode-toggle { justify-content: center; }
            .essay-topic-section { grid-template-columns: 1fr; gap: 15px; }
            .college-section { grid-template-columns: 1fr; gap: 15px; }
            .deadline-section { max-width: 100%; }
            .editor-header { flex-direction: column; gap: 12px; align-items: stretch; }
            .editor-actions { justify-content: flex-end; }
            .editor-toolbar { flex-wrap: wrap; justify-content: center; }
            .toolbar-left-groups { justify-content: center; flex-wrap: wrap; margin-bottom: 8px; gap: 4px;}
            .toolbar-divider { margin: 0 2px; }
            .editor-toolbar .word-count-display { width: 100%; text-align: center; margin-top: 8px; margin-left: 0;}
            .landing-header, .landing-content { padding: 15px; }
            .intro-section { flex-direction: column; text-align: center; gap: 20px; }
        }
    </style>
</head>
<body>

    <!-- NEW LANDING PAGE -->
    <div id="landingPage">
        <aside class="landing-sidebar">
            <div class="landing-logo">
                <span>H</span>helloivy
            </div>
            <nav class="landing-nav">
                <a href="#">
                    <span class="nav-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect></svg>
                    </span>
                    My Dashboard
                </a>
                <a href="#" class="active">
                    <span class="nav-icon">
                       <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20h9"></path><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"></path></svg>
                    </span>
                    Essay Evaluator
                </a>
            </nav>
        </aside>
        <div class="landing-main-wrapper">
            <header class="landing-header">
                <div class="landing-title">
                    <span class="close-icon">√ó</span>
                    <span>New Essay Evaluation</span>
                </div>
                <div class="landing-user-profile">
                    <div class="profile-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path><path d="M13.73 21a2 2 0 0 1-3.46 0"></path></svg>
                        <div class="notification-dot"></div>
                    </div>
                    <div class="profile-avatar"></div>
                </div>
            </header>
            <main class="landing-content">
                <section class="intro-section">
                    <div class="intro-text">
                        <span class="evaluator-badge">Essay Evaluator</span>
                        <h2>Ready to Evaluate<br>Your Essays?</h2>
                    </div>
                    <div class="intro-image-placeholder">
                        Image of a tablet and stylus.
                    </div>
                </section>
                <section class="instructions-box">
                    <div class="instructions-header">
                        <h3>Go Through Instructions Before We Start The Module</h3>
                        <button class="listen-btn">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon></svg>
                            Listen
                        </button>
                    </div>
                    <ol class="instructions-list">
                        <li>This module helps you evaluate, refine, and elevate your essay drafts.</li>
                        <li>Revisit your brainstormed structure before uploading. It will ensure your essay evaluation is consistent with your narrative, goals and selected college prompts.</li>
                        <li>Upload your written draft to receive targeted AI suggestions, integrate counselor feedback, and iterate through multiple versions.</li>
                        <li>Review all AI and counselor suggestions carefully.</li>
                        <li>Decide what resonates with your voice, and make changes that align with your intended story and tone.</li>
                        <li>Credits are limited per user, so use each upload mindfully.</li>
                        <li>Make sure your essay version is complete and ready for feedback before submitting to maximize the value you receive.</li>
                    </ol>
                    <div class="read-checkbox">
                        <input type="checkbox" id="readInstructionsCheck">
                        <label for="readInstructionsCheck">I have read all the instruction mentioned above.</label>
                    </div>
                    <button class="get-started-btn" id="getStartedBtn" disabled>
                        Get Started
                        <span>‚Üí</span>
                    </button>
                </section>
            </main>
        </div>
    </div>
    
    <!-- BRAINSTORMER MODAL (Modal 1) -->
    <div id="brainstormerModal" class="modal-overlay">
        <div class="modal-content">
            <button id="modalCloseBtn" class="modal-close">√ó</button>
            <div class="modal-icon-container">
                 <svg width="40" height="40" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M5.38571 11.399C5.38571 10.5181 6.10857 9.79981 7 9.79981H17C17.8914 9.79981 18.6143 10.5181 18.6143 11.399V19.3985C18.6143 19.8631 18.2529 20.2485 17.8 20.2485H6.2C5.74714 20.2485 5.38571 19.8631 5.38571 19.3985V11.399Z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M9.85714 12.6V9.8C9.85714 9.24771 9.40943 8.8 8.85714 8.8H7V12.6" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M14.1429 12.6V9.8C14.1429 9.24771 14.5906 8.8 15.1429 8.8H17V12.6" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M12 12.6V8.8" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M12 20.2485V21.1983C12 21.6412 11.6412 22 11.2 22H7C6.55886 22 6.2 21.6412 6.2 21.1983V20.2485" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M12 20.2485V21.1983C12 21.6412 12.3589 22 12.8 22H17C17.4411 22 17.8 21.6412 17.8 21.1983V20.2485" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M12 8.8V4.8C12 4.57886 12.1789 4.4 12.4 4.4H13.3C13.5211 4.4 13.7 4.57886 13.7 4.8V6.6" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
            </div>
            <h2>Explore Essay Brainstormer</h2>
            <p>Uncover compelling essay ideas tailored to your story and goals.</p>
            <button class="modal-primary-btn">Go to Essay Brainstormer</button>
            <button id="continueToUserTypeBtn" class="modal-secondary-link">Continue with essay evaluator</button>
        </div>
    </div>
    
    <!-- USER TYPE MODAL (Modal 2) -->
    <div id="userTypeModal" class="modal-overlay">
        <div class="modal-content" style="max-width: 400px; padding: 30px;">
            <h2 style="font-size: 22px;">Welcome!</h2>
            <p style="margin-bottom: 24px;">Please select your user type to continue.</p>
            <button id="firstTimeUserBtn" class="modal-primary-btn">First-Time User</button>
            <button id="existingUserBtn" class="modal-primary-btn secondary">Existing User</button>
        </div>
    </div>


    <!-- EXISTING EVALUATOR APP -->
    <div id="evaluatorApp">
        <div class="container">
            <div class="panel header-panel">
                <h1><span class="header-icon">üìù</span>Essay Evaluator</h1>
                <div class="mode-toggle">
                    <button class="mode-btn active" data-mode="form" title="Input and submit your essay">
                        <span class="tab-icon">üìù</span> Input Mode
                    </button>
                    <button class="mode-btn" data-mode="editor" title="View and edit essay with AI feedback">
                        <span class="tab-icon">‚úçÔ∏è</span> Editor Mode
                    </button>
                </div>
            </div>
    
            <div class="main-layout form-mode">
                <div class="panel form-panel">
                     <h1 class="form-title"><span class="header-icon" style="font-size:1.1em;">‚úçÔ∏è</span> Essay Input</h1>
                    <form id="essayForm">
                        <div class="essay-topic-section">
                            <div class="form-group">
                                <label for="brainstormedEssay">Previously Brainstormed Essay <span class="required">*</span></label>
                                <textarea id="brainstormedEssay" placeholder="E.g., My journey overcoming adversity..." rows="4"></textarea>
                                <div class="input-icons">
                                    <div class="input-icon" title="Check Grammar (Placeholder)">G</div>
                                    <div class="input-icon" title="Generate Ideas (Placeholder)">üí°</div>
                                </div>
                            </div>
                            <div class="or-divider">OR</div>
                            <div class="form-group">
                                <label for="newEssayPrompt">New Essay Prompt <span class="required">*</span></label>
                                <textarea id="newEssayPrompt" placeholder="E.g., Common App Prompt #1..." rows="4"></textarea>
                                 <div class="essay-note">
                                    Since this Essay has not been Brainstormed, it will be evaluated without an Essay structure.
                                </div>
                            </div>
                        </div>
                        <div class="essay-limit-section">
                            <div class="section-title">Essay Limit</div>
                            <div class="limit-options">
                                <div class="limit-option"><input type="radio" id="limitWords" name="limitType" value="words" checked><label for="limitWords">Words</label></div>
                                <div class="limit-option"><input type="radio" id="limitCharsSpace" name="limitType" value="charactersWithSpace"><label for="limitCharsSpace">Characters With Space</label></div>
                                <div class="limit-option"><input type="radio" id="limitCharsNoSpace" name="limitType" value="charactersWithoutSpace"><label for="limitCharsNoSpace">Characters Without Space</label></div>
                            </div>
                            <div class="limit-input"><input type="number" id="essayLimit" value="650" min="50" max="10000" placeholder="E.g., 650"></div>
                        </div>
                        <div class="college-section">
                            <div class="form-group">
                                <label for="college">College <span class="required">*</span></label>
                                <select id="college" required><option value="">Select</option><option value="upenn">UPenn</option><option value="harvard">Harvard</option><option value="other">Other</option></select>
                            </div>
                            <div class="form-group">
                                <label for="degree">Degree <span class="required">*</span></label>
                                <select id="degree" required><option value="">Select</option><option value="ba">BA</option><option value="bs">BS</option><option value="other">Other</option></select>
                            </div>
                            <div class="form-group">
                                <label for="major">Major <span class="required">*</span></label>
                                <select id="major" required><option value="">Select</option><option value="cs">CS</option><option value="eng">Engineering</option><option value="other">Other</option></select>
                            </div>
                        </div>
                        <div class="deadline-section">
                            <div class="form-group">
                                <label for="deadline">Deadline Set by You <span class="required">*</span></label>
                                <input type="date" id="deadline" required>
                                <div id="deadlineWarning"></div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="essayContent">Write Your Essay <span class="required">*</span></label>
                            <textarea id="essayContent" placeholder="Paste or type your essay here..." required rows="15"></textarea>
                            <div class="word-count-display">
                                <span>Current count: <span id="currentCount" class="word-count-status">0</span> <span id="currentUnit">words</span></span>
                                <span>Target: <span id="targetLimit">650</span> <span id="targetUnitDisplay">words</span></span>
                            </div>
                        </div>
                        <button type="submit" class="analyze-btn" id="analyzeBtn">üöÄ Analyze Essay with AI</button>
                    </form>
                    <div class="loading-container" id="formLoadingState">
                        <div class="loading-spinner"></div>
                        <p style="color: #6b7280; font-weight: 500;">ü§ñ AI is analyzing your essay...</p>
                    </div>
                </div>
    
                <div class="panel editor-panel" id="editorPanel">
                    <div class="editor-header">
                        <div class="essay-meta">
                            <div class="essay-title" id="editorEssayTitle">Your Essay Title</div>
                            <div class="essay-subtitle">Last updated: <span id="editorLastUpdated">N/A</span></div>
                        </div>
                        <div class="editor-actions">
                            <button class="action-btn primary" id="editorEvaluateBtn" title="Re-evaluate current text in editor">üìä Re-Evaluate</button>
                            <button class="action-btn" id="editorShareBtn" title="Share options (TBD)">üì§ Share ‚ñº</button>
                        </div>
                    </div>
                    <div class="editor-toolbar">
                        <div class="toolbar-left-groups">
                            <div class="toolbar-group">
                                <button class="toolbar-btn" data-command="bold" title="Bold (Ctrl+B)"><strong>B</strong></button>
                                <button class="toolbar-btn" data-command="italic" title="Italic (Ctrl+I)"><em>I</em></button>
                                <button class="toolbar-btn" data-command="underline" title="Underline (Ctrl+U)"><u>U</u></button>
                            </div>
                            <div class="toolbar-divider"></div>
                            <div class="toolbar-group">
                                <button class="toolbar-btn" data-command="justifyLeft" title="Align Left">‚ò∞</button>
                                <button class="toolbar-btn" data-command="justifyCenter" title="Align Center">‚óÜ</button>
                                <button class="toolbar-btn" data-command="justifyRight" title="Align Right" style="transform: scaleX(-1);">‚ò∞</button>
                                <button class="toolbar-btn" data-command="justifyFull" title="Align Justify">J</button>
                            </div>
                            <div class="toolbar-divider"></div>
                            <div class="toolbar-group">
                                <button class="toolbar-btn" data-command="insertUnorderedList" title="Bullet List">‚Ä¢</button>
                                <button class="toolbar-btn" data-command="insertOrderedList" title="Numbered List">1.</button>
                            </div>
                            <div class="toolbar-divider"></div>
                            <div class="toolbar-group">
                                <button class="toolbar-btn" data-command="undo" title="Undo (Ctrl+Z)">‚Ü∫</button>
                                <button class="toolbar-btn" data-command="redo" title="Redo (Ctrl+Y)">‚Üª</button>
                            </div>
                        </div>
                        <div class="word-count-display" id="editorWordCountDisplay">0 words</div>
                    </div>
                    <div class="rich-editor">
                        <div class="editor-content" contenteditable="true" id="richTextEditor" aria-placeholder="Essay content will appear here..."></div>
                        <div class="editor-placeholder" id="editorPlaceholder">Essay content will appear here...</div>
                    </div>
                </div>
    
                <div class="analysis-sidebar" id="analysisSidebar">
                    <div class="sidebar-tabs">
                        <div class="sidebar-tab active" data-tab="analysis"><span class="tab-icon">üìä</span><span>Analysis</span></div>
                        <div class="sidebar-tab" data-tab="suggestions"><span class="tab-icon">üí°</span><span>Suggestions</span><span class="tab-badge" id="suggestionsBadgeOverall">0</span></div>
                        <div class="sidebar-tab" data-tab="structure"><span class="tab-icon">üìã</span><span>Structure</span></div>
                    </div>
                    <div class="sidebar-content">
                        <div class="tab-content active" id="analysisContentSidebar">
                            <div class="score-circle" id="sidebarScoreCircle"><div class="score-value" id="sidebarScoreValue">‚Äî</div></div>
                            <div class="score-description" id="sidebarScoreDescription">Submit essay for analysis.</div>
                            <div class="view-toggle-container">
                                <button class="view-toggle active" data-view="summary">üìÑ Summary</button>
                                <button class="view-toggle" data-view="suggestions">üí° General Feedback <span id="suggestionsBadgeGeneral" class="tab-badge" style="background-color: #3b82f6;">0</span></button>
                            </div>
                            <div class="criteria-summary" id="criteriaSummaryView">
                                 <div class="no-analysis-message">Detailed scoring breakdown will appear here.</div>
                            </div>
                            <div class="suggestions-view" id="generalSuggestionsView" style="display:none;">
                                <div class="sidebar-section"><h4 style="margin-bottom: 8px;">Key Feedback</h4><div id="generalSuggestionsListSidebar"><div class="no-suggestions-message">General feedback will appear here.</div></div></div>
                            </div>
                        </div>
                        <div class="tab-content" id="suggestionsContentSidebar" style="display:none;">
                            <div class="sidebar-section">
                                <h4>Editorial Suggestions</h4>
                                <div id="detailedSuggestionsContainerSidebar">
                                    <div class="no-comments-message">Specific editorial suggestions will appear here.</div>
                                </div>
                            </div>
                        </div>
                        <div class="tab-content" id="structureContentSidebar" style="display:none;">
                            <div class="sidebar-section"><h4>Essay Structure Observations</h4><div id="structureContainerSidebar"><div class="no-structure-message">Structural analysis will appear here.</div></div></div>
                        </div>
                    </div>
                     <div style="padding: 16px; border-top: 1px solid #e5e7eb; background: #fafafa; display: flex; gap: 8px;">
                        <button class="action-btn" id="sidebarUploadAgainBtn" style="flex: 1; font-size: 12px; padding: 8px;" title="Start a new essay evaluation">üîÑ New Essay</button>
                        <button class="action-btn primary" id="sidebarGoToFormBtn" style="flex: 1; font-size: 12px; padding: 8px;" title="Go back to input mode">Back to Input</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8000';
        let currentMode = 'form';
        let currentAnalysisResult = null;
        let currentEssayTextForEditor = ''; 
        
        const richTextEditor = document.getElementById('richTextEditor');
        const editorPlaceholder = document.getElementById('editorPlaceholder');

        document.addEventListener('DOMContentLoaded', initializeApp);

        function initializeApp() {
            // Setup sequence
            setupLandingPage();
            setupBrainstormerModal();
            setupUserTypeModal(); // NEW: Setup the second modal
            setupModeToggle();
            setupFormHandlers();
            setupEditorHandlers();
            setupSidebarHandlers();
            updateWordCount(); 
            updateDeadlineWarning();
            document.getElementById('targetUnitDisplay').textContent = document.querySelector('input[name="limitType"]:checked + label').textContent.toLowerCase().includes("words") ? "words" : "characters";
            updateEditorPlaceholderVisibility();
        }

        function setupLandingPage() {
            const getStartedBtn = document.getElementById('getStartedBtn');
            const readCheckbox = document.getElementById('readInstructionsCheck');
            const brainstormerModal = document.getElementById('brainstormerModal');

            readCheckbox.addEventListener('change', () => {
                getStartedBtn.disabled = !readCheckbox.checked;
            });

            getStartedBtn.addEventListener('click', () => {
                if (!readCheckbox.checked) return;
                brainstormerModal.style.display = 'flex';
            });
        }
        
        function setupBrainstormerModal() {
            const brainstormerModal = document.getElementById('brainstormerModal');
            const userTypeModal = document.getElementById('userTypeModal');
            const continueBtn = document.getElementById('continueToUserTypeBtn');
            const closeBtn = document.getElementById('modalCloseBtn');
            
            // "Continue with essay evaluator" button -> shows the next modal
            continueBtn.addEventListener('click', () => {
                brainstormerModal.style.display = 'none';
                userTypeModal.style.display = 'flex';
            });

            // The 'X' close button on the first modal will skip the second modal and go straight to the app
            closeBtn.addEventListener('click', proceedToEvaluator);
        }

        function setupUserTypeModal() {
            const firstTimeBtn = document.getElementById('firstTimeUserBtn');
            const existingUserBtn = document.getElementById('existingUserBtn');

            // Both buttons in the second modal will proceed to the evaluator app
            firstTimeBtn.addEventListener('click', proceedToEvaluator);
            existingUserBtn.addEventListener('click', proceedToEvaluator);
        }

        // Final function to transition to the main application
        function proceedToEvaluator() {
            const landingPage = document.getElementById('landingPage');
            const evaluatorApp = document.getElementById('evaluatorApp');
            const body = document.body;

            // Hide all modals and the landing page
            document.getElementById('brainstormerModal').style.display = 'none';
            document.getElementById('userTypeModal').style.display = 'none';
            landingPage.classList.add('hidden');
            
            // Show the evaluator app and set its styles
            evaluatorApp.classList.add('active');
            body.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
            body.style.padding = '20px';
        }

        function updateEditorPlaceholderVisibility() {
            const editorIsEmpty = !(richTextEditor.textContent || richTextEditor.innerText || "").trim() && !richTextEditor.querySelector('img') && !richTextEditor.querySelector('br');
             editorPlaceholder.style.display = editorIsEmpty && !document.hasFocus(richTextEditor) ? 'block' : 'none';
        }

        function setupModeToggle() {
            document.querySelectorAll('.mode-btn').forEach(btn => btn.addEventListener('click', () => switchMode(btn.dataset.mode)));
        }

        function switchMode(mode) {
            if (mode === currentMode) return;
            const mainLayout = document.querySelector('.main-layout');
            const formPanel = document.querySelector('.form-panel');
            const editorPanel = document.getElementById('editorPanel');
            const analysisSidebar = document.getElementById('analysisSidebar');

            if (mode === 'editor') {
                const formContent = document.getElementById('essayContent').value.trim();
                const editorContentIsEmpty = !(richTextEditor.textContent || richTextEditor.innerText || "").trim();
                if (editorContentIsEmpty && !formContent && !currentEssayTextForEditor) {
                    alert('Please input your essay in "Input Mode" first or perform an analysis.');
                    document.querySelector(`.mode-btn[data-mode="form"]`).classList.add('active');
                    document.querySelector(`.mode-btn[data-mode="editor"]`).classList.remove('active');
                    return;
                }
            }
            
            document.querySelectorAll('.mode-btn').forEach(btn => btn.classList.toggle('active', btn.dataset.mode === mode));
            mainLayout.className = `main-layout ${mode}-mode`;

            if (mode === 'form') {
                formPanel.classList.remove('hidden');
                editorPanel.classList.remove('active');
                analysisSidebar.classList.remove('active');
            } else if (mode === 'editor') {
                formPanel.classList.add('hidden');
                editorPanel.classList.add('active');
                analysisSidebar.classList.add('active');
                
                const formContentForSync = document.getElementById('essayContent').value;
                if (currentEssayTextForEditor) { // Prioritize analysis-derived or direct editor input
                    syncContentToEditor(currentEssayTextForEditor, true);
                } else if (formContentForSync) {
                     syncContentToEditor(formContentForSync, false);
                } else { // Fallback to whatever might be in editor (e.g. if page reloaded in editor mode)
                    syncContentToEditor(richTextEditor.innerHTML, true);
                }

                if (currentAnalysisResult) {
                    displayAnalysisInSidebar(currentAnalysisResult.analysis, currentAnalysisResult.highlights);
                }
            }
            currentMode = mode;
            updateWordCount();
            updateEditorPlaceholderVisibility();
        }

        function setupFormHandlers() {
            document.getElementById('essayForm').addEventListener('submit', handleFormSubmission);
            document.getElementById('essayContent').addEventListener('input', updateWordCount);
            document.querySelectorAll('input[name="limitType"]').forEach(radio => radio.addEventListener('change', updateWordCount));
            document.getElementById('essayLimit').addEventListener('input', updateWordCount);
            document.getElementById('deadline').addEventListener('change', updateDeadlineWarning);
            const defaultDeadline = new Date();
            defaultDeadline.setDate(defaultDeadline.getDate() + 30); 
            document.getElementById('deadline').value = defaultDeadline.toISOString().split('T')[0];
            updateDeadlineWarning(); // Initial call
        }
        
        function updateWordCount() {
            const formContentEl = document.getElementById('essayContent');
            const editorText = richTextEditor.textContent || richTextEditor.innerText || "";
            const content = currentMode === 'form' ? formContentEl.value : editorText;
            
            const limitTypeEl = document.querySelector('input[name="limitType"]:checked');
            const limitType = limitTypeEl ? limitTypeEl.value : 'words';
            const limit = parseInt(document.getElementById('essayLimit').value) || 0;
            
            let currentCount = 0;
            let currentUnitText = 'words'; 

            switch(limitType) {
                case 'words': 
                    currentCount = content.trim() === '' ? 0 : content.trim().split(/\s+/).filter(Boolean).length; 
                    currentUnitText = 'words';
                    break;
                case 'charactersWithSpace': 
                    currentCount = content.length; 
                    currentUnitText = 'characters';
                    break;
                case 'charactersWithoutSpace':
                    currentCount = content.replace(/\s/g, '').length;
                    currentUnitText = 'characters (no space)';
                    break;
            }

            if (currentMode === 'form') {
                document.getElementById('currentCount').textContent = currentCount;
                document.getElementById('currentUnit').textContent = currentUnitText; 
                document.getElementById('targetLimit').textContent = limit;
                document.getElementById('targetUnitDisplay').textContent = currentUnitText; 

                const countStatusEl = document.getElementById('currentCount');
                countStatusEl.className = 'word-count-status'; 
                if (limit > 0) { 
                    if (currentCount > limit * 1.05) countStatusEl.classList.add('word-count-over'); 
                    else if (currentCount >= limit * 0.9 && currentCount <= limit * 1.05) countStatusEl.classList.add('word-count-good'); 
                    else countStatusEl.classList.add('word-count-under');
                }
            } else if (currentMode === 'editor') {
                 const editorWords = editorText.trim() === '' ? 0 : editorText.trim().split(/\s+/).filter(Boolean).length;
                 document.getElementById('editorWordCountDisplay').textContent = `${editorWords} words`;
            }
        }

        function updateDeadlineWarning() {
            // ... (Identical to previous correct version) ...
            const deadlineInput = document.getElementById('deadline');
            const warningDiv = document.getElementById('deadlineWarning');
            if (!deadlineInput.value) { warningDiv.innerHTML = ''; return; }
            const deadline = new Date(deadlineInput.value + "T00:00:00"); 
            const now = new Date(); now.setHours(0,0,0,0);
            const diffTime = deadline - now;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            
            warningDiv.innerHTML = '';
            if (diffDays < 0) warningDiv.innerHTML = '<div class="deadline-urgent">‚ö†Ô∏è Deadline has passed!</div>';
            else if (diffDays <= 3) warningDiv.innerHTML = `<div class="deadline-urgent">üö® Urgent: ${diffDays} day${diffDays === 1 ? '' : 's'} left!</div>`;
            else if (diffDays <= 7) warningDiv.innerHTML = `<div class="deadline-warning" style="color: #856404; background-color: #fff3cd; border-color: #ffeeba;">‚è∞ ${diffDays} days left</div>`;
        }

        async function handleFormSubmission(e) {
            e.preventDefault();
            const formData = gatherFormDataFromForm();
            if (!validateFormData(formData)) return;
            currentEssayTextForEditor = formData.content; // Store plain text from form
            
            document.getElementById('formLoadingState').style.display = 'block';
            document.getElementById('analyzeBtn').disabled = true;
            document.getElementById('analyzeBtn').textContent = "Analyzing...";

            try {
                const payload = {
                    title: formData.brainstormed_essay || formData.essay_prompt,
                    question_type: formData.essay_prompt || formData.brainstormed_essay,
                    word_count: formData.essay_limit, 
                    college_degree: `${formData.college_text} - ${formData.degree_text} in ${formData.major_text}`,
                    content: formData.content
                };
                const response = await fetch(`${API_BASE}/api/analyze-essay`, {
                    method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(payload)
                });
                currentAnalysisResult = await response.json();
                if (!response.ok) throw new Error(currentAnalysisResult.detail || currentAnalysisResult.message || 'Analysis failed');
                
                if (currentAnalysisResult.status === 'success') {
                    switchMode('editor'); 
                } else {
                    throw new Error(currentAnalysisResult.message || 'Analysis reported an issue.');
                }
            } catch (error) {
                console.error('Analysis error:', error);
                alert(`Analysis failed: ${error.message}`);
            } finally {
                document.getElementById('formLoadingState').style.display = 'none';
                document.getElementById('analyzeBtn').disabled = false;
                document.getElementById('analyzeBtn').textContent = "üöÄ Analyze Essay with AI";
            }
        }

        function gatherFormDataFromForm() { /* ... (Identical to previous correct version) ... */ 
            return {
                brainstormed_essay: document.getElementById('brainstormedEssay').value.trim(),
                essay_prompt: document.getElementById('newEssayPrompt').value.trim(),
                college: document.getElementById('college').value,
                college_text: getSelectText('college'),
                degree: document.getElementById('degree').value,
                degree_text: getSelectText('degree'),
                major: document.getElementById('major').value,
                major_text: getSelectText('major'),
                essay_limit: parseInt(document.getElementById('essayLimit').value) || 0,
                limit_type: document.querySelector('input[name="limitType"]:checked').value,
                content: document.getElementById('essayContent').value.trim(),
                deadline: document.getElementById('deadline').value
            };
        }
        function validateFormData(formData) { /* ... (Identical to previous correct version) ... */ 
             if (!formData.content) { alert('Essay content is required.'); return false; }
            if (formData.content.split(/\s+/).filter(Boolean).length < 10) { alert('Essay must be at least 10 words.'); return false; }
            if (!formData.brainstormed_essay && !formData.essay_prompt) { alert('Essay topic or prompt is required.'); return false; }
            if (!formData.college || !formData.degree || !formData.major) { alert('College, Degree, and Major are required.'); return false; }
            if (!formData.deadline) { 
                alert('Deadline is required.'); 
                document.getElementById('deadline').focus();
                return false; 
            }
            return true;
        }
        
        function setupEditorHandlers() {
            document.querySelectorAll('.toolbar-btn').forEach(btn => {
                btn.addEventListener('mousedown', e => { 
                    e.preventDefault(); 
                    document.execCommand(btn.dataset.command, false, null);
                    richTextEditor.focus();
                    currentEssayTextForEditor = richTextEditor.innerHTML;
                    updateEditorPlaceholderVisibility();
                });
            });
            richTextEditor.addEventListener('input', () => {
                currentEssayTextForEditor = richTextEditor.innerHTML;
                updateWordCount(); 
                document.getElementById('essayContent').value = richTextEditor.textContent || "";
                updateEditorPlaceholderVisibility();
            });
            richTextEditor.addEventListener('focus', updateEditorPlaceholderVisibility);
            richTextEditor.addEventListener('blur', updateEditorPlaceholderVisibility);

            document.getElementById('editorEvaluateBtn').addEventListener('click', async () => {
                const editorTextContentForAnalysis = richTextEditor.textContent || ""; 
                if (editorTextContentForAnalysis.trim().length < 10) {
                    alert("Please ensure there is enough content in the editor to evaluate.");
                    return;
                }
                const formData = gatherFormDataFromForm(); 
                document.getElementById('editorEvaluateBtn').textContent = "Evaluating...";
                document.getElementById('editorEvaluateBtn').disabled = true;
                try {
                     const payload = { /* ... (payload identical to previous) ... */ 
                        title: formData.brainstormed_essay || formData.essay_prompt,
                        question_type: formData.essay_prompt || formData.brainstormed_essay,
                        word_count: formData.essay_limit,
                        college_degree: `${formData.college_text} - ${formData.degree_text} in ${formData.major_text}`,
                        content: editorTextContentForAnalysis
                     };
                    const response = await fetch(`${API_BASE}/api/analyze-essay`, {
                        method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(payload)
                    });
                    currentAnalysisResult = await response.json();
                    if (!response.ok) throw new Error(currentAnalysisResult.detail || 'Re-evaluation failed');
                    if (currentAnalysisResult.status === 'success') {
                        currentEssayTextForEditor = richTextEditor.innerHTML; // Capture current HTML before re-highlighting
                        displayAnalysisInSidebar(currentAnalysisResult.analysis, currentAnalysisResult.highlights);
                        addHighlightsToEditor(currentAnalysisResult.highlights); 
                    } else {
                         throw new Error(currentAnalysisResult.message || 'Re-evaluation reported an issue.');
                    }
                } catch (error) {
                    console.error("Re-evaluation error:", error);
                    alert("Failed to re-evaluate: " + error.message);
                } finally {
                    document.getElementById('editorEvaluateBtn').textContent = "üìä Re-Evaluate";
                    document.getElementById('editorEvaluateBtn').disabled = false;
                }
            });
        }

        function syncContentToEditor(contentToSync, isHtmlContent = false) {
            if (isHtmlContent) {
                richTextEditor.innerHTML = contentToSync;
            } else {
                richTextEditor.innerHTML = contentToSync.replace(/\n/g, '<br>');
            }
            currentEssayTextForEditor = richTextEditor.innerHTML; // Always store the current HTML state
            
            if (currentAnalysisResult && currentAnalysisResult.highlights) {
                addHighlightsToEditor(currentAnalysisResult.highlights); 
            }
            document.getElementById('editorEssayTitle').textContent = (document.getElementById('brainstormedEssay').value || document.getElementById('newEssayPrompt').value || "Essay").substring(0,50) + "...";
            document.getElementById('editorLastUpdated').textContent = new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
            updateWordCount(); 
            updateEditorPlaceholderVisibility();
        }

        function addHighlightsToEditor(highlights) {
            // Base is the current editor's HTML, preserving user formatting as much as possible
            let baseHtml = richTextEditor.innerHTML;
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = baseHtml; // Use this to get clean textContent for matching
            let textContentForMatching = tempDiv.textContent || tempDiv.innerText || "";

            const replacements = [];
            (highlights || []).forEach((h, index) => {
                if (h.text) {
                    let startIndex = 0;
                    let matchIndex;
                    while ((matchIndex = textContentForMatching.indexOf(h.text, startIndex)) !== -1) {
                        const alreadyReplaced = replacements.some(r => (matchIndex >= r.start && matchIndex < r.end));
                        if (!alreadyReplaced) {
                            let highlightClass = `highlight ${escapeHtml(h.type || 'grammar')}`; 
                            replacements.push({
                                start: matchIndex, end: matchIndex + h.text.length,
                                replacementHtml: `<span class="${highlightClass}" data-index="${index}" title="${escapeHtml(h.issue + (h.suggestion ? ': ' + h.suggestion : ''))}">${escapeHtml(h.text)}</span>`
                            });
                            break; 
                        }
                        startIndex = matchIndex + h.text.length; 
                    }
                }
            });
            replacements.sort((a, b) => b.start - a.start);
            let processedTextContent = textContentForMatching;
            replacements.forEach(rep => {
                processedTextContent = processedTextContent.substring(0, rep.start) + rep.replacementHtml + processedTextContent.substring(rep.end);
            });
            richTextEditor.innerHTML = processedTextContent.replace(/\n/g, '<br>'); // Re-apply, newlines to br
            currentEssayTextForEditor = richTextEditor.innerHTML;
            updateEditorPlaceholderVisibility();
        }

        function setupSidebarHandlers() {
            document.querySelectorAll('.sidebar-tab').forEach(tab => tab.addEventListener('click', () => switchSidebarTab(tab.dataset.tab)));
            document.querySelectorAll('.view-toggle').forEach(toggle => toggle.addEventListener('click', () => switchSidebarAnalysisView(toggle.dataset.view)));
            document.getElementById('sidebarUploadAgainBtn').addEventListener('click', () => {
                currentAnalysisResult = null; currentEssayTextForEditor = '';
                richTextEditor.innerHTML = ''; document.getElementById('essayForm').reset();
                document.getElementById('currentCount').textContent = '0';
                document.getElementById('currentUnit').textContent = 'words';
                document.getElementById('targetLimit').textContent = document.getElementById('essayLimit').value || '650';
                const defaultDeadline = new Date(); defaultDeadline.setDate(defaultDeadline.getDate() + 30);
                document.getElementById('deadline').value = defaultDeadline.toISOString().split('T')[0];
                updateDeadlineWarning(); updateWordCount();
                document.getElementById('sidebarScoreValue').textContent = '‚Äî';
                document.getElementById('sidebarScoreCircle').style.background = `conic-gradient(#e5e7eb 0%, #e5e7eb 100%)`;
                document.getElementById('sidebarScoreDescription').textContent = 'Submit essay for analysis.';
                document.getElementById('criteriaSummaryView').innerHTML = `<div class="no-analysis-message">Detailed scoring breakdown will appear here.</div>`;
                document.getElementById('generalSuggestionsListSidebar').innerHTML = `<div class="no-suggestions-message">General feedback will appear here.</div>`;
                document.getElementById('detailedSuggestionsContainerSidebar').innerHTML = `<div class="no-comments-message">Specific editorial suggestions will appear here.</div>`;
                document.getElementById('structureContainerSidebar').innerHTML = `<div class="no-structure-message">Structural analysis will appear here.</div>`;
                document.getElementById('suggestionsBadgeGeneral').textContent = '0';
                document.getElementById('suggestionsBadgeOverall').textContent = '0';
                switchMode('form'); updateEditorPlaceholderVisibility();
            });
            document.getElementById('sidebarGoToFormBtn').addEventListener('click', () => {
                const editorTextForForm = richTextEditor.textContent || "";
                document.getElementById('essayContent').value = editorTextForForm;
                updateWordCount(); switchMode('form');
            });
        }
        
        function switchSidebarTab(tabName) {
            document.querySelectorAll('.sidebar-tab').forEach(tab => tab.classList.toggle('active', tab.dataset.tab === tabName));
            document.querySelectorAll('.sidebar-content .tab-content').forEach(content => {
                content.style.display = content.id.toLowerCase().startsWith(tabName) ? 'block' : 'none';
            });
        }

        function switchSidebarAnalysisView(viewName) {
            document.querySelectorAll('.view-toggle').forEach(toggle => toggle.classList.toggle('active', toggle.dataset.view === viewName));
            document.getElementById('criteriaSummaryView').style.display = viewName === 'summary' ? 'block' : 'none';
            document.getElementById('generalSuggestionsView').style.display = viewName === 'suggestions' ? 'block' : 'none';
        }

        function displayAnalysisInSidebar(analysisDetails, highlights) {
            const score = parseFloat(analysisDetails.overall_score || 0);
            document.getElementById('sidebarScoreValue').textContent = `${score.toFixed(1)}/10`;
            const scoreCircle = document.getElementById('sidebarScoreCircle');
            const progressPercent = (score / 10) * 100;
            let scoreColor = '#ef4444'; 
            if (score >= 8) scoreColor = '#10b981'; else if (score >= 7) scoreColor = '#3b82f6'; else if (score >= 5) scoreColor = '#f59e0b';
            scoreCircle.style.background = `conic-gradient(${scoreColor} ${progressPercent}%, #e5e7eb ${progressPercent}%)`;
            document.getElementById('sidebarScoreDescription').textContent = analysisDetails.admissions_perspective || "See detailed breakdown below.";

            const criteriaContainer = document.getElementById('criteriaSummaryView');
            criteriaContainer.innerHTML = ""; 
            const tempFormData = gatherFormDataFromForm();
            const criterionScores = calculateCriterionScoresForSidebar(analysisDetails, tempFormData, analysisDetails.content_breakdown);
            criterionScores.forEach(c => { /* ... (Identical to previous correct version) ... */ 
                if (c.score === null && c.name === "Alignment with Brainstorming" && !tempFormData.brainstormed_essay) return; 
                const scoreDisplay = c.score !== null ? c.score.toFixed(1) : '‚Äî';
                const colorClass = getProgressColorClass(c.score);
                criteriaContainer.innerHTML += `
                    <div class="criterion-compact">
                        <div class="criterion-header">
                            <div class="criterion-title">${c.name}</div>
                            <div class="criterion-score">${scoreDisplay}</div>
                        </div>
                        <div class="progress-bar"><div class="progress-fill ${colorClass}" style="width: ${c.score !== null ? (c.score/10)*100 : 0}%;"></div></div>
                    </div>`;
            });
            if (criteriaContainer.innerHTML === "") criteriaContainer.innerHTML = `<div class="no-analysis-message">Detailed scoring breakdown will appear here.</div>`;

            const generalSuggestionsList = document.getElementById('generalSuggestionsListSidebar');
            generalSuggestionsList.innerHTML = "";
            let generalSuggestionCount = 0;
            const allNextSteps = [];
            if(analysisDetails.alignment_with_topic?.next_steps) allNextSteps.push(...analysisDetails.alignment_with_topic.next_steps);
            if(analysisDetails.essay_narrative_impact?.next_steps) allNextSteps.push(...analysisDetails.essay_narrative_impact.next_steps);
            if(analysisDetails.language_and_structure?.next_steps) allNextSteps.push(...analysisDetails.language_and_structure.next_steps);
            allNextSteps.forEach(s => { generalSuggestionsList.innerHTML += `<div class="suggestion-item">${escapeHtml(s)}</div>`; generalSuggestionCount++; });
            if (analysisDetails.admissions_perspective && generalSuggestionCount === 0) { generalSuggestionsList.innerHTML += `<div class="suggestion-item"><strong>Overall Perspective:</strong> ${escapeHtml(analysisDetails.admissions_perspective)}</div>`; generalSuggestionCount++;}
            if (generalSuggestionCount === 0) generalSuggestionsList.innerHTML = `<div class="no-suggestions-message">No general feedback provided.</div>`;
            document.getElementById('suggestionsBadgeGeneral').textContent = generalSuggestionCount;

            const detailedSuggestionsContainer = document.getElementById('detailedSuggestionsContainerSidebar');
            detailedSuggestionsContainer.innerHTML = "";
            let detailedSuggestionCount = 0;
            if (highlights?.length) {
                highlights.forEach(h => {
                    let suggestionHtml = '<div class="suggestion-item" style="margin-bottom: 10px;">';
                    const originalTextEsc = escapeHtml(h.text); const suggestionTextEsc = escapeHtml(h.suggestion); const issueTextEsc = escapeHtml(h.issue);
                    switch (h.type) {
                        case 'spelling': suggestionHtml += `<span class="suggestion-detail-type">Spelling:</span> Fix <span class="suggestion-original-text">"${originalTextEsc}"</span> to <span class="suggestion-suggested-text">${suggestionTextEsc}</span>.`; break;
                        case 'replace_candidate': suggestionHtml += `<span class="suggestion-detail-type">Replace:</span> <span class="suggestion-original-text">"${originalTextEsc}"</span> <span class="suggestion-text-arrow">‚Üí</span> <span class="suggestion-suggested-text">${suggestionTextEsc}</span>.`; break;
                        case 'remove_candidate': suggestionHtml += `<span class="suggestion-detail-type">Remove:</span> <span class="suggestion-remove-text">"${originalTextEsc}"</span>.`; break;
                        case 'add_candidate': suggestionHtml += `<span class="suggestion-detail-type">Add:</span> After <span class="suggestion-original-text">"${originalTextEsc}"</span>, insert <span class="suggestion-suggested-text">'${suggestionTextEsc}'</span>.`; break;
                        default: suggestionHtml += `<span class="suggestion-detail-type">${escapeHtml(h.type.replace("_", " ").replace(/\b\w/g, l => l.toUpperCase()))}:</span> Regarding <span class="suggestion-original-text">"${originalTextEsc}"</span>. Suggestion: <span class="suggestion-suggested-text">${suggestionTextEsc}</span>.`; break;
                    }
                    if (h.issue) { suggestionHtml += `<span class="suggestion-issue-text">${issueTextEsc}</span>`; }
                    suggestionHtml += '</div>';
                    detailedSuggestionsContainer.innerHTML += suggestionHtml; detailedSuggestionCount++;
                });
            }
            if (detailedSuggestionCount === 0) { detailedSuggestionsContainer.innerHTML = `<div class="no-comments-message">No specific editorial suggestions flagged.</div>`; }
            document.getElementById('suggestionsBadgeOverall').textContent = detailedSuggestionCount;

            const structureContainer = document.getElementById('structureContainerSidebar');
            structureContainer.innerHTML = "";
            const allKeyObservations = [];
            if(analysisDetails.alignment_with_topic?.key_observations) allKeyObservations.push(...analysisDetails.alignment_with_topic.key_observations);
            if(analysisDetails.essay_narrative_impact?.key_observations) allKeyObservations.push(...analysisDetails.essay_narrative_impact.key_observations);
            if(analysisDetails.language_and_structure?.key_observations) allKeyObservations.push(...analysisDetails.language_and_structure.key_observations);
            if (allKeyObservations.length) {
                 structureContainer.innerHTML += `<h4>Key Observations:</h4>`;
                 allKeyObservations.forEach(obs => { structureContainer.innerHTML += `<div class="suggestion-item">${escapeHtml(obs)}</div>`; });
            } else { structureContainer.innerHTML = `<div class="no-structure-message">No specific structural observations provided.</div>`; }
            
            switchSidebarTab('analysis'); 
            switchSidebarAnalysisView('summary'); 
        }

        function calculateCriterionScoresForSidebar(analysis, formData, contentBreakdown) { /* ... (Identical to previous correct version) ... */ 
            const overallScore = parseFloat(analysis.overall_score || 0); let scores = {};
            if (contentBreakdown && typeof contentBreakdown === 'object') {
                scores['Alignment with Topic'] = contentBreakdown.prompt_alignment !== undefined ? parseFloat(contentBreakdown.prompt_alignment) : null;
                scores['Essay Narrative & Impact'] = contentBreakdown.content_ideas !== undefined ? parseFloat(contentBreakdown.content_ideas) : null;
                const structScore = contentBreakdown.structure_organization !== undefined ? parseFloat(contentBreakdown.structure_organization) : null;
                const langWriteScore = contentBreakdown.language_writing !== undefined ? parseFloat(contentBreakdown.language_writing) : null;
                if (structScore !== null && langWriteScore !== null) scores['Language & Structure'] = parseFloat(((structScore + langWriteScore) / 2).toFixed(1));
                else if (structScore !== null) scores['Language & Structure'] = structScore; else if (langWriteScore !== null) scores['Language & Structure'] = langWriteScore; else scores['Language & Structure'] = null;
            }
            const baseForFallback = overallScore > 0 ? overallScore : 6.0;
            const criteriaConfig = [
                { name: 'Alignment with Topic', fallbackFactor: 0.75, variance: 1.5 }, { name: 'Essay Narrative & Impact', fallbackFactor: 0, variance: 2.0 },
                { name: 'Language & Structure', fallbackFactor: -0.5, variance: 1.5 }, { name: 'Alignment with Brainstorming', fallbackFactor: -0.5, variance: 1, requires: () => formData.brainstormed_essay },
            ];
            return criteriaConfig.map(cfg => {
                let scoreValue = scores[cfg.name] !== undefined && scores[cfg.name] !== null ? scores[cfg.name] : null;
                if (scoreValue === null) { 
                    if (cfg.requires && !cfg.requires()) {} else {
                        scoreValue = Math.min(10.0, Math.max(0.0, baseForFallback + (Math.random() * cfg.variance * 2) - cfg.variance + cfg.fallbackFactor));
                        scoreValue = parseFloat(scoreValue.toFixed(1));
                    }
                } return { name: cfg.name, score: scoreValue };
            });
        }
        function getProgressColorClass(score) { /* ... (Identical to previous correct version) ... */ 
            if (score === null || score === undefined) return 'needs-work'; if (score >= 8) return 'excellent'; if (score >= 7) return 'good'; if (score >= 5) return 'average'; return 'needs-work';
        }
        function getSelectText(selectId) { /* ... (Identical to previous correct version) ... */ 
            const select = document.getElementById(selectId); return select.options[select.selectedIndex]?.text || '';
        }
        function escapeHtml(text) { /* ... (Identical to previous correct version) ... */ 
            if (text === null || text === undefined) return ''; const d = document.createElement('div'); d.textContent = String(text); return d.innerHTML;
        }
    </script>
</body>
</html>